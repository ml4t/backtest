# =============================================================================
# ML Strategy Configuration
# =============================================================================
#
# This configuration demonstrates an ML-driven strategy with:
# - Precomputed ML signals (ml_score from trained model)
# - Precomputed features (ATR for volatility-based stops)
# - Basic risk management rules
# - Single-asset or small-universe application
#
# Use Case: ML model deployment, signal-based trading, feature integration
# Expected Runtime: <5 seconds
# =============================================================================

name: "ML Signal Strategy"
description: "ML-driven strategy with precomputed signals and volatility-based risk"

# -----------------------------------------------------------------------------
# Data Sources
# -----------------------------------------------------------------------------

data_sources:
  # REQUIRED: Price data (OHLCV bars)
  prices:
    path: "examples/integrated/data/stock_data.parquet"
    format: parquet
    timestamp_column: timestamp
    asset_column: asset_id

  # OPTIONAL: ML signals from trained model
  # In production, these would come from your ML inference pipeline
  # Expected columns: timestamp, asset_id, signal_long, signal_short, confidence
  # Note: The stock_data.parquet already contains ml_score column
  signals:
    path: "examples/integrated/data/stock_data.parquet"
    format: parquet
    columns: [timestamp, asset_id, ml_score]  # Load only signal columns
    timestamp_column: timestamp
    asset_column: asset_id

  # OPTIONAL: Market context (VIX for regime filtering)
  context:
    path: "examples/integrated/data/vix_data.parquet"
    format: parquet
    columns: [timestamp, vix]  # VIX data doesn't need asset_id
    timestamp_column: timestamp
    asset_column: asset_id  # Will be null for market-wide data

# -----------------------------------------------------------------------------
# Feature Provider
# -----------------------------------------------------------------------------
# Load precomputed features used by risk rules and strategy logic
# Features flow: File → FeatureProvider → MarketEvent → Strategy/Risk

features:
  type: precomputed
  path: "examples/integrated/data/stock_data.parquet"
  # Specify which columns are features (not price data)
  columns: [atr, ml_score]  # ATR for vol stops, ml_score for ranking
  timestamp_column: timestamp
  asset_column: asset_id

# Alternative: Callable feature provider (compute features on-the-fly)
# features:
#   type: callable
#   module: my_features  # Import from my_features.py
#   function: compute_ml_features  # Call compute_ml_features(timestamp, asset_id)
#   kwargs:
#     model_path: "models/xgboost_v1.pkl"
#     lookback: 20

# -----------------------------------------------------------------------------
# Risk Rules
# -----------------------------------------------------------------------------
# Integrated risk management with ML signals

risk_rules:
  # Position sizing: 10% max per position
  max_position_size: 0.10

  # Volatility-scaled stop loss (2× ATR)
  # Note: This requires 'atr' feature to be available
  # The actual VolatilityScaledStopLoss rule is instantiated in code
  # This config just stores parameters
  stop_loss: 0.02  # Fallback if ATR not available

  # Take profit target
  take_profit: 0.05  # 5% profit target

  # VIX filtering: Only trade when VIX is reasonable
  # Requires context data with 'vix' column
  min_vix: 10.0  # Avoid trading in extremely quiet markets
  max_vix: 30.0  # Avoid trading in panic/high-volatility markets

  # Portfolio heat limit (not yet implemented in Phase 1)
  # max_portfolio_heat: 0.15  # Max 15% of NAV at risk

# -----------------------------------------------------------------------------
# Execution Parameters
# -----------------------------------------------------------------------------

execution:
  # Initial capital
  initial_capital: 100000.0

  # Commission model: Interactive Brokers-style
  commission:
    type: per_share
    rate: 0.005  # $0.005 per share
    minimum: 1.0  # $1 minimum

  # Slippage model: Percentage-based
  slippage:
    type: percentage
    rate: 0.001  # 0.1% slippage (10 bps)

  # No margin for simplicity
  enable_margin: false
  max_leverage: 1.0

  # Prevent lookahead bias
  execution_delay: true

  # Allow re-entry on same bar (useful for quick ML signal changes)
  allow_immediate_reentry: true

# =============================================================================
# ML Strategy Implementation Notes
# =============================================================================
#
# This config assumes you have:
#
# 1. Precomputed ML Signals
#    - Train your model offline: sklearn, XGBoost, PyTorch, etc.
#    - Generate predictions and save to Parquet
#    - Columns: timestamp, asset_id, ml_score (or signal_long, signal_short)
#
# 2. Precomputed Features
#    - ATR for volatility-based stops
#    - ML features used for model input (optional, for analysis)
#    - Any other technical indicators
#
# 3. Strategy Logic (Python code)
#    ```python
#    class MLStrategy(Strategy):
#        def on_market_data(self, event: MarketEvent):
#            # Get ML signal from event
#            ml_score = event.signals.get('ml_score', 0.0)
#
#            # Get VIX from context
#            vix = event.context.get('vix', 0.0)
#
#            # Apply VIX filter (from config)
#            if vix > self.config.risk_rules.max_vix:
#                return  # Don't trade
#
#            # Trade on ML signal
#            if ml_score > 0.6 and not self.has_position(event.asset_id):
#                self.buy_percent(event.asset_id, 0.10)  # 10% of NAV
#
#            elif ml_score < 0.4 and self.has_position(event.asset_id):
#                self.close_position(event.asset_id)
#    ```
#
# 4. Risk Rules (Automatic)
#    - VolatilityScaledStopLoss: Automatically uses ATR from features
#    - TimeBasedExit: Automatically tracks bars since entry
#    - VIX filtering: Strategy code checks context
#
# =============================================================================
# Common Workflows
# =============================================================================
#
# Single-Asset ML Strategy:
#   1. Train model on historical features
#   2. Generate ml_score for each (timestamp, asset_id)
#   3. Save to Parquet: [timestamp, asset_id, ml_score]
#   4. Use this config with asset filter
#   5. Run backtest
#
# Multi-Asset ML Strategy (small universe):
#   1. Train model on cross-sectional features
#   2. Generate ml_score for all assets
#   3. Strategy ranks by ml_score, selects top N
#   4. Use this config without asset filter
#   5. Run backtest
#
# Live Trading Deployment:
#   1. Use same config
#   2. Replace DataFeed with LiveDataFeed
#   3. Replace SimulationBroker with LiveBroker
#   4. ML inference runs in real-time or pre-market
#
# =============================================================================
