

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qengine.execution.broker &mdash; qengine 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            qengine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/core.html">Core Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/execution.html">Execution Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/portfolio.html">Portfolio Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/strategy.html">Strategy Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/data.html">Data Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/reporting.html">Reporting Module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">qengine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">qengine.execution.broker</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qengine.execution.broker</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Broker implementations for QEngine.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.core.assets</span><span class="w"> </span><span class="kn">import</span> <span class="n">AssetRegistry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.core.event</span><span class="w"> </span><span class="kn">import</span> <span class="n">FillEvent</span><span class="p">,</span> <span class="n">MarketEvent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.core.types</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AssetId</span><span class="p">,</span>
    <span class="n">OrderId</span><span class="p">,</span>
    <span class="n">OrderStatus</span><span class="p">,</span>
    <span class="n">OrderType</span><span class="p">,</span>
    <span class="n">Price</span><span class="p">,</span>
    <span class="n">Quantity</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.bracket_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">BracketOrderManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.fill_simulator</span><span class="w"> </span><span class="kn">import</span> <span class="n">FillSimulator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">OrderState</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.order_router</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderRouter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.position_tracker</span><span class="w"> </span><span class="kn">import</span> <span class="n">PositionTracker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.trade_tracker</span><span class="w"> </span><span class="kn">import</span> <span class="n">TradeTracker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.portfolio.margin</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarginAccount</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.commission</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommissionModel</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.liquidity</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiquidityModel</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.market_impact</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarketImpactModel</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.slippage</span><span class="w"> </span><span class="kn">import</span> <span class="n">SlippageModel</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Broker">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.Broker">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Broker</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for broker implementations.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Broker.submit_order">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.Broker.submit_order">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">submit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderId</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Submit an order for execution.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Broker.cancel_order">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.Broker.cancel_order">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel an existing order.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Broker.get_order">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.Broker.get_order">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get order by ID.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Broker.get_open_orders">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.Broker.get_open_orders">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_id</span><span class="p">:</span> <span class="n">AssetId</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all open orders, optionally filtered by asset.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Broker.on_market_event">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.Broker.on_market_event">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_market_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">MarketEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">FillEvent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process market event and generate fills.&quot;&quot;&quot;</span></div>
</div>



<div class="viewcode-block" id="SimulationBroker">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SimulationBroker</span><span class="p">(</span><span class="n">Broker</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulated broker for backtesting.</span>

<span class="sd">    Handles order execution with configurable realism models.</span>
<span class="sd">    Supports multiple asset classes including equities, futures, options, FX, and crypto.</span>

<span class="sd">    Features:</span>
<span class="sd">    - Execution delay: Prevents lookahead bias by delaying order fills by one market event</span>
<span class="sd">    - Multiple order types: Market, Limit, Stop, Trailing Stop, Bracket</span>
<span class="sd">    - Realistic fills: Slippage, commission, and market impact models</span>
<span class="sd">    - Position tracking: Multi-asset position management</span>
<span class="sd">    - Margin support: For derivatives trading</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SimulationBroker.__init__">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">initial_cash</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100000.0</span><span class="p">,</span>
        <span class="n">asset_registry</span><span class="p">:</span> <span class="n">AssetRegistry</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">commission_model</span><span class="p">:</span> <span class="s2">&quot;CommissionModel | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slippage_model</span><span class="p">:</span> <span class="s2">&quot;SlippageModel | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">market_impact_model</span><span class="p">:</span> <span class="s2">&quot;MarketImpactModel | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">liquidity_model</span><span class="p">:</span> <span class="s2">&quot;LiquidityModel | None&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_model</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">enable_margin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">execution_delay</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Add execution delay to prevent lookahead (default True to prevent bias)</span>
        <span class="n">max_leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># Maximum leverage allowed (1.0 = no leverage)</span>
        <span class="n">allow_immediate_reentry</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Allow re-entry on same bar as exit (default True for realism)</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize simulation broker with specialized components.</span>

<span class="sd">        Args:</span>
<span class="sd">            initial_cash: Starting cash balance</span>
<span class="sd">            asset_registry: Registry of asset specifications</span>
<span class="sd">            commission_model: Model for calculating commissions</span>
<span class="sd">            slippage_model: Model for calculating slippage</span>
<span class="sd">            market_impact_model: Model for calculating market impact</span>
<span class="sd">            liquidity_model: Model for liquidity constraints and volume limits</span>
<span class="sd">            fill_model: Model for determining fills</span>
<span class="sd">            enable_margin: Whether to enable margin trading for derivatives</span>
<span class="sd">            execution_delay: Whether to delay order execution by one market event (default True to prevent lookahead bias)</span>
<span class="sd">            max_leverage: Maximum leverage allowed (default 1.0 = no leverage).</span>
<span class="sd">                Prevents unlimited leverage as capital depletes. Example: max_leverage=2.0 allows</span>
<span class="sd">                positions up to 2x cash balance.</span>
<span class="sd">            allow_immediate_reentry: Whether to allow re-entering a position on the same bar where it was exited.</span>
<span class="sd">                True (default) = realistic behavior, allows intrabar exit+entry if liquidity exists.</span>
<span class="sd">                False = VectorBT-compatible mode, prevents same-bar re-entry for validation purposes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_cash</span> <span class="o">=</span> <span class="n">initial_cash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset_registry</span> <span class="o">=</span> <span class="n">asset_registry</span> <span class="ow">or</span> <span class="n">AssetRegistry</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission_model</span> <span class="o">=</span> <span class="n">commission_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage_model</span> <span class="o">=</span> <span class="n">slippage_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_impact_model</span> <span class="o">=</span> <span class="n">market_impact_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">liquidity_model</span> <span class="o">=</span> <span class="n">liquidity_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_model</span> <span class="o">=</span> <span class="n">fill_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_margin</span> <span class="o">=</span> <span class="n">enable_margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_delay</span> <span class="o">=</span> <span class="n">execution_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span> <span class="o">=</span> <span class="n">max_leverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_immediate_reentry</span> <span class="o">=</span> <span class="n">allow_immediate_reentry</span>

        <span class="c1"># Initialize specialized components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span> <span class="o">=</span> <span class="n">PositionTracker</span><span class="p">(</span><span class="n">initial_cash</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span> <span class="o">=</span> <span class="n">OrderRouter</span><span class="p">(</span><span class="n">execution_delay</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bracket_manager</span> <span class="o">=</span> <span class="n">BracketOrderManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_order</span><span class="p">)</span>

        <span class="c1"># Margin account for derivatives</span>
        <span class="k">if</span> <span class="n">enable_margin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">margin_account</span> <span class="o">=</span> <span class="n">MarginAccount</span><span class="p">(</span><span class="n">initial_cash</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset_registry</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">margin_account</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Fill simulator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_simulator</span> <span class="o">=</span> <span class="n">FillSimulator</span><span class="p">(</span>
            <span class="n">asset_registry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">asset_registry</span><span class="p">,</span>
            <span class="n">commission_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">commission_model</span><span class="p">,</span>
            <span class="n">slippage_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">slippage_model</span><span class="p">,</span>
            <span class="n">market_impact_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">market_impact_model</span><span class="p">,</span>
            <span class="n">liquidity_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">liquidity_model</span><span class="p">,</span>
            <span class="n">margin_account</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">margin_account</span><span class="p">,</span>
            <span class="n">max_leverage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Latest market prices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_prices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">AssetId</span><span class="p">,</span> <span class="n">Price</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Track last exit timestamp per asset (for allow_immediate_reentry=False)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_exit_time</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">AssetId</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># VectorBT compatibility: Track newly-created brackets to skip checking on creation bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_newly_created_brackets</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Trade tracking (highly efficient)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_tracker</span> <span class="o">=</span> <span class="n">TradeTracker</span><span class="p">()</span>

        <span class="c1"># Statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_commission</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_slippage</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SimulationBroker initialized with $</span><span class="si">{</span><span class="n">initial_cash</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;execution_delay=</span><span class="si">{</span><span class="n">execution_delay</span><span class="si">}</span><span class="s2">, enable_margin=</span><span class="si">{</span><span class="n">enable_margin</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;max_leverage=</span><span class="si">{</span><span class="n">max_leverage</span><span class="si">}</span><span class="s2">, allow_immediate_reentry=</span><span class="si">{</span><span class="n">allow_immediate_reentry</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>


    <span class="c1"># Properties for backward compatibility</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current cash balance from PositionTracker.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_cash</span><span class="p">()</span>

    <span class="nd">@cash</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set cash balance in PositionTracker.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">cash</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">AssetId</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get positions from PositionTracker for backward compatibility.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">_positions</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">OrderId</span><span class="p">,</span> <span class="n">Order</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get orders from OrderRouter for backward compatibility.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">_orders</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">AssetId</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get open orders from OrderRouter for backward compatibility.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">_open_orders</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_stop_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">AssetId</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get stop orders from OrderRouter for backward compatibility.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">_stop_orders</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_trailing_stops</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">AssetId</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get trailing stops from OrderRouter for backward compatibility.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">_trailing_stops</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_pending_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">AssetId</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Order</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get pending orders from OrderRouter for backward compatibility.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">_pending_orders</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trades</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;pl.DataFrame&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get completed trades as a Polars DataFrame.</span>

<span class="sd">        Returns DataFrame with columns:</span>
<span class="sd">        - trade_id: Unique trade identifier</span>
<span class="sd">        - asset_id: Asset symbol</span>
<span class="sd">        - entry_dt: Entry timestamp</span>
<span class="sd">        - entry_price: Entry execution price</span>
<span class="sd">        - entry_quantity: Position size</span>
<span class="sd">        - entry_commission: Entry fees</span>
<span class="sd">        - entry_slippage: Entry slippage cost</span>
<span class="sd">        - entry_order_id: Entry order ID</span>
<span class="sd">        - exit_dt: Exit timestamp</span>
<span class="sd">        - exit_price: Exit execution price</span>
<span class="sd">        - exit_quantity: Exit position size</span>
<span class="sd">        - exit_commission: Exit fees</span>
<span class="sd">        - exit_slippage: Exit slippage cost</span>
<span class="sd">        - exit_order_id: Exit order ID</span>
<span class="sd">        - pnl: Net profit/loss</span>
<span class="sd">        - return_pct: Return percentage</span>
<span class="sd">        - duration_bars: Trade duration in bars</span>
<span class="sd">        - direction: &quot;long&quot; or &quot;short&quot;</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; broker = SimulationBroker(initial_cash=100000)</span>
<span class="sd">            &gt;&gt;&gt; # ... run backtest ...</span>
<span class="sd">            &gt;&gt;&gt; trades_df = broker.trades</span>
<span class="sd">            &gt;&gt;&gt; print(f&quot;Total trades: {len(trades_df)}&quot;)</span>
<span class="sd">            &gt;&gt;&gt; print(f&quot;Total PnL: ${trades_df[&#39;pnl&#39;].sum():.2f}&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trade_tracker</span><span class="o">.</span><span class="n">get_trades_df</span><span class="p">()</span>

<div class="viewcode-block" id="SimulationBroker.can_enter_position">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.can_enter_position">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_enter_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_id</span><span class="p">:</span> <span class="n">AssetId</span><span class="p">,</span> <span class="n">current_time</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a new position can be entered for the given asset.</span>

<span class="sd">        When allow_immediate_reentry=False, prevents entering a position on the same</span>
<span class="sd">        bar where the previous position was exited (VectorBT-compatible behavior).</span>

<span class="sd">        Args:</span>
<span class="sd">            asset_id: Asset to check</span>
<span class="sd">            current_time: Current bar timestamp</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if entry is allowed, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_immediate_reentry</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Check if we exited on this same bar</span>
        <span class="k">if</span> <span class="n">asset_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_exit_time</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_exit_time</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">current_time</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SimulationBroker.submit_order">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.submit_order">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">submit_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderId</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submit an order for execution.</span>

<span class="sd">        Args:</span>
<span class="sd">            order: Order to submit</span>
<span class="sd">            timestamp: Current simulation time (if None, uses datetime.now() for compatibility)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Order ID</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If order is invalid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate order</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order quantity must be positive, got </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">limit_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;LIMIT order requires limit_price&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">STOP</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">stop_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;STOP order requires stop_price&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">STOP_LIMIT</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">limit_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;STOP_LIMIT order requires limit_price&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">stop_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;STOP_LIMIT order requires stop_price&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">limit_price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">limit_price</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Limit price must be positive, got </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">limit_price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">stop_price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">stop_price</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stop price must be positive, got </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">stop_price</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Update order state</span>
        <span class="n">order</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OrderState</span><span class="o">.</span><span class="n">SUBMITTED</span>
        <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">SUBMITTED</span>
        <span class="n">order</span><span class="o">.</span><span class="n">submitted_time</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="k">if</span> <span class="n">timestamp</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="c1"># Initialize trailing stop price if applicable</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">TRAILING_STOP</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">asset_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_prices</span><span class="p">:</span>
            <span class="n">order</span><span class="o">.</span><span class="n">update_trailing_stop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_prices</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">])</span>

        <span class="c1"># Route order (delegates to OrderRouter)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">route_order</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">submitted_time</span><span class="p">)</span>

        <span class="c1"># Legacy immediate execution for market orders (no delay mode)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_delay</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">asset_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_prices</span><span class="p">:</span>
                <span class="n">fill_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_simulator</span><span class="o">.</span><span class="n">try_fill_order</span><span class="p">(</span>
                    <span class="n">order</span><span class="p">,</span>
                    <span class="n">market_price</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_prices</span><span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">],</span>
                    <span class="n">current_cash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_cash</span><span class="p">(),</span>
                    <span class="n">current_position</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">),</span>
                    <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">fill_result</span><span class="p">:</span>
                    <span class="c1"># Update position tracker</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">update_position</span><span class="p">(</span>
                        <span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">,</span>
                        <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_quantity</span><span class="p">,</span>
                        <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
                        <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_price</span><span class="p">,</span>
                        <span class="n">fill_result</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
                        <span class="n">fill_result</span><span class="o">.</span><span class="n">slippage</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Update statistics</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_total_commission</span> <span class="o">+=</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">commission</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_total_slippage</span> <span class="o">+=</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">slippage</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="c1"># Track trade (same as delayed execution path)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trade_tracker</span><span class="o">.</span><span class="n">on_fill</span><span class="p">(</span><span class="n">fill_result</span><span class="o">.</span><span class="n">fill_event</span><span class="p">)</span>

                    <span class="c1"># Publish fill event immediately if order was filled</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;event_bus&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">fill_result</span><span class="o">.</span><span class="n">fill_event</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Submitted order: </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="n">order_id</span></div>


<div class="viewcode-block" id="SimulationBroker.cancel_order">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.cancel_order">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cancel_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cancel an existing order (delegates to OrderRouter).</span>

<span class="sd">        Args:</span>
<span class="sd">            order_id: ID of order to cancel</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if cancelled successfully</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">get_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Remove from queues (delegates to OrderRouter)</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">remove_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">removed</span><span class="p">:</span>
            <span class="c1"># Update order state</span>
            <span class="n">order</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelled order: </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="SimulationBroker.get_order">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.get_order">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Order</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get order by ID (delegates to OrderRouter).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">get_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimulationBroker.get_open_orders">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.get_open_orders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_open_orders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_id</span><span class="p">:</span> <span class="n">AssetId</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Order</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all open orders, optionally filtered by asset (delegates to OrderRouter).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">get_open_orders</span><span class="p">(</span><span class="n">asset_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">is_active</span><span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_exit_priority</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bracket_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get VectorBT exit priority for bracket leg type.</span>

<span class="sd">        Priority Order (lower number = higher priority):</span>
<span class="sd">            1. Stop Loss (SL)</span>
<span class="sd">            2. Trailing Stop Loss (TSL)</span>
<span class="sd">            3. Take Profit (TP)</span>

<span class="sd">        Args:</span>
<span class="sd">            bracket_type: Type from order.metadata[&quot;bracket_type&quot;]</span>

<span class="sd">        Returns:</span>
<span class="sd">            Priority value (1 = highest, 3 = lowest)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">priority_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;stop_loss&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>      <span class="c1"># Highest priority</span>
            <span class="s2">&quot;trailing_stop&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># Medium priority</span>
            <span class="s2">&quot;take_profit&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>    <span class="c1"># Lowest priority</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">priority_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bracket_type</span><span class="p">,</span> <span class="mi">999</span><span class="p">)</span>  <span class="c1"># Unknown types get lowest priority</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_collect_triggered_bracket_exits</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">asset_id</span><span class="p">:</span> <span class="n">AssetId</span><span class="p">,</span>
        <span class="n">event</span><span class="p">:</span> <span class="n">MarketEvent</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Order</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect all triggered bracket exit orders without filling them.</span>

<span class="sd">        Returns list of (priority, bracket_type, order) tuples sorted by priority.</span>
<span class="sd">        Only includes bracket leg orders (stop_loss, trailing_stop, take_profit).</span>

<span class="sd">        Args:</span>
<span class="sd">            asset_id: Asset identifier</span>
<span class="sd">            event: Market event with OHLC data</span>
<span class="sd">            price: Current market price</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of (priority, bracket_type, order) tuples, sorted by priority (lowest first)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">triggered</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check TP orders (LIMIT orders in open_orders with bracket_type=&quot;take_profit&quot;)</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]):</span>
            <span class="n">bracket_type</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bracket_type&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bracket_type</span> <span class="o">==</span> <span class="s2">&quot;take_profit&quot;</span><span class="p">:</span>
                <span class="c1"># VectorBT: Skip newly-created brackets (created in current event)</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newly_created_brackets</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># TP triggers when high &gt;= limit_price</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">can_fill</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">low</span><span class="p">):</span>
                    <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exit_priority</span><span class="p">(</span><span class="n">bracket_type</span><span class="p">)</span>
                    <span class="n">triggered</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span> <span class="n">bracket_type</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>

        <span class="c1"># Check SL orders (STOP orders in stop_orders with bracket_type=&quot;stop_loss&quot;)</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stop_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]):</span>
            <span class="n">bracket_type</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bracket_type&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bracket_type</span> <span class="o">==</span> <span class="s2">&quot;stop_loss&quot;</span><span class="p">:</span>
                <span class="c1"># VectorBT: Skip newly-created brackets (created in current event)</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newly_created_brackets</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># SL triggers when low &lt;= stop_price</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_trigger_stop</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
                    <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exit_priority</span><span class="p">(</span><span class="n">bracket_type</span><span class="p">)</span>
                    <span class="n">triggered</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span> <span class="n">bracket_type</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>

        <span class="c1"># Check TSL orders (TRAILING_STOP orders with bracket_type=&quot;trailing_stop&quot;)</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trailing_stops</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]):</span>
            <span class="n">bracket_type</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bracket_type&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bracket_type</span> <span class="o">==</span> <span class="s2">&quot;trailing_stop&quot;</span><span class="p">:</span>
                <span class="c1"># VectorBT: Skip newly-created brackets (created in current event)</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_newly_created_brackets</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Initialize peak tracking if not present</span>
                <span class="k">if</span> <span class="s2">&quot;peak_price&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;peak_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_price&quot;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

                <span class="c1"># VectorBT 4-stage per-bar process (from TASK-018)</span>
                <span class="c1"># Stage 1: Update peak with open</span>
                <span class="n">peak_price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;peak_price&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">open</span> <span class="o">&gt;</span> <span class="n">peak_price</span><span class="p">:</span>
                    <span class="n">peak_price</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">open</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;peak_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_price</span>

                <span class="c1"># Stage 2: Check TSL trigger with current peak</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">trail_percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">trail_amount</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">*</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">trail_percent</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
                    <span class="c1"># BUG FIX: Logic was inverted!</span>
                    <span class="c1"># For SELL orders (exiting long): TSL = peak - trail_amount (stop BELOW)</span>
                    <span class="c1"># For BUY orders (exiting short): TSL = peak + trail_amount (stop ABOVE)</span>
                    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                        <span class="c1"># BUY order (exiting short): TSL above peak</span>
                        <span class="n">tsl_level</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">+</span> <span class="n">trail_amount</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># SELL order (exiting long): TSL below peak</span>
                        <span class="n">tsl_level</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">-</span> <span class="n">trail_amount</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">tsl_level</span>

                    <span class="n">can_fill_result</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">can_fill</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">low</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">can_fill_result</span><span class="p">:</span>
                        <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exit_priority</span><span class="p">(</span><span class="n">bracket_type</span><span class="p">)</span>
                        <span class="n">triggered</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span> <span class="n">bracket_type</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>
                        <span class="k">continue</span>  <span class="c1"># Don&#39;t do stages 3/4 if already triggered</span>

                <span class="c1"># Stage 3: Update peak with high</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">high</span> <span class="o">&gt;</span> <span class="n">peak_price</span><span class="p">:</span>
                    <span class="n">peak_price</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">high</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;peak_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_price</span>

                <span class="c1"># Stage 4: Re-check TSL with updated peak</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">trail_percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">is_filled</span><span class="p">:</span>
                    <span class="n">trail_amount</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">*</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">trail_percent</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
                    <span class="c1"># BUG FIX: Same fix as Stage 2</span>
                    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                        <span class="c1"># BUY order (exiting short): TSL above peak</span>
                        <span class="n">tsl_level</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">+</span> <span class="n">trail_amount</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># SELL order (exiting long): TSL below peak</span>
                        <span class="n">tsl_level</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">-</span> <span class="n">trail_amount</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">tsl_level</span>

        <span class="c1"># Sort by priority (lowest number = highest priority)</span>
        <span class="n">triggered</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">triggered</span>

<div class="viewcode-block" id="SimulationBroker.on_market_event">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.on_market_event">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_market_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">MarketEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">FillEvent</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process market event and generate fills.</span>

<span class="sd">        Args:</span>
<span class="sd">            event: Market data event</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of fill events generated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Increment bar counter for trade duration tracking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_tracker</span><span class="o">.</span><span class="n">on_bar</span><span class="p">()</span>

        <span class="n">fills</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">asset_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">asset_id</span>

        <span class="c1"># Determine execution price</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">close</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fills</span>  <span class="c1"># No price available</span>

        <span class="c1"># Update last known price</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_prices</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>

        <span class="c1"># Process existing open orders FIRST (before moving pending orders)</span>
        <span class="c1"># This ensures pending orders wait for the next event</span>
        <span class="c1"># IMPORTANT: Skip bracket exit orders here - they&#39;re handled with priority logic below</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Skip bracket exits (TP, SL, TSL) - they use priority-based processing</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bracket_type&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;take_profit&quot;</span><span class="p">,</span> <span class="s2">&quot;stop_loss&quot;</span><span class="p">,</span> <span class="s2">&quot;trailing_stop&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">fill_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_simulator</span><span class="o">.</span><span class="n">try_fill_order</span><span class="p">(</span>
                <span class="n">order</span><span class="p">,</span>
                <span class="n">market_price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
                <span class="n">current_cash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_cash</span><span class="p">(),</span>
                <span class="n">current_position</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">),</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">low</span><span class="p">,</span>
                <span class="n">close</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">fill_result</span><span class="p">:</span>
                <span class="c1"># Check position before fill (for exit tracking)</span>
                <span class="n">position_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">)</span>

                <span class="c1"># Update position tracker</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">update_position</span><span class="p">(</span>
                    <span class="n">asset_id</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_quantity</span><span class="p">,</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_price</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">slippage</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Track exit timestamp if position went to zero (for allow_immediate_reentry=False)</span>
                <span class="n">position_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">position_before</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">position_after</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_exit_time</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span>

                <span class="c1"># Update statistics</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_total_commission</span> <span class="o">+=</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">commission</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_total_slippage</span> <span class="o">+=</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">slippage</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Track trade (efficient - minimal overhead)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trade_tracker</span><span class="o">.</span><span class="n">on_fill</span><span class="p">(</span><span class="n">fill_result</span><span class="o">.</span><span class="n">fill_event</span><span class="p">)</span>

                <span class="n">fills</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fill_result</span><span class="o">.</span><span class="n">fill_event</span><span class="p">)</span>

                <span class="c1"># Remove filled orders</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_filled</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">remove_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

                    <span class="c1"># Handle bracket order completion</span>
                    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">BRACKET</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_bracket_fill</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_event</span><span class="p">)</span>
                    <span class="c1"># Handle OCO (One-Cancels-Other) logic for bracket legs (delegates to BracketOrderManager)</span>
                    <span class="c1"># Only cancel sibling orders if this is a bracket leg (not the parent)</span>
                    <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">child_order_ids</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bracket_type&quot;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bracket_manager</span><span class="o">.</span><span class="n">handle_oco_fill</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">)</span>

        <span class="c1"># Check stop orders for triggering</span>
        <span class="c1"># IMPORTANT: Skip bracket SL orders - they&#39;re handled with priority logic below</span>
        <span class="n">triggered_stops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stop_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]):</span>
            <span class="c1"># Skip bracket exits - they use priority-based processing</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bracket_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;stop_loss&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_trigger_stop</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
                <span class="n">triggered_stops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stop_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="c1"># Process triggered stops immediately</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">triggered_stops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">STOP</span><span class="p">:</span>
                <span class="c1"># Convert to market order and try to fill immediately</span>
                <span class="n">original_type</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span>
                <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;STOP&quot;</span>
                <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">=</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span>
                <span class="n">fill_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_simulator</span><span class="o">.</span><span class="n">try_fill_order</span><span class="p">(</span>
                    <span class="n">order</span><span class="p">,</span>
                    <span class="n">market_price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
                    <span class="n">current_cash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_cash</span><span class="p">(),</span>
                    <span class="n">current_position</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">),</span>
                    <span class="n">timestamp</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                    <span class="n">high</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
                    <span class="n">low</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">low</span><span class="p">,</span>
                    <span class="n">close</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">fill_result</span><span class="p">:</span>
                    <span class="c1"># Update position tracker</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">update_position</span><span class="p">(</span>
                        <span class="n">asset_id</span><span class="p">,</span>
                        <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_quantity</span><span class="p">,</span>
                        <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
                        <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_price</span><span class="p">,</span>
                        <span class="n">fill_result</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
                        <span class="n">fill_result</span><span class="o">.</span><span class="n">slippage</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Update statistics</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_total_commission</span> <span class="o">+=</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">commission</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_total_slippage</span> <span class="o">+=</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">slippage</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">fills</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fill_result</span><span class="o">.</span><span class="n">fill_event</span><span class="p">)</span>

                    <span class="c1"># FIX: Handle OCO logic for bracket legs that are filled as stop orders (delegates to BracketOrderManager)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">order</span><span class="o">.</span><span class="n">is_filled</span>
                        <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">child_order_ids</span>
                        <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bracket_type&quot;</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bracket_manager</span><span class="o">.</span><span class="n">handle_oco_fill</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If couldn&#39;t fill as market order, restore type and add to open orders</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">=</span> <span class="n">original_type</span>
                    <span class="k">del</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">STOP_LIMIT</span><span class="p">:</span>
                <span class="c1"># Keep as limit order after triggering</span>
                <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">=</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="c1"># Update and check trailing stops</span>
        <span class="c1"># VectorBT TSL behavior (TASK-007): Trail from PEAK price, not current price</span>
        <span class="c1"># Peak tracking uses metadata-based approach for now (short-term workaround)</span>
        <span class="c1"># IMPORTANT: Skip bracket TSL orders - they&#39;re handled with priority logic below</span>
        <span class="n">triggered_trailing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trailing_stops</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]):</span>
            <span class="c1"># Skip bracket exits - they use priority-based processing</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bracket_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;trailing_stop&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Initialize peak tracking if not present</span>
            <span class="k">if</span> <span class="s2">&quot;peak_price&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                <span class="c1"># Initialize peak to entry price (base price)</span>
                <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;peak_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base_price&quot;</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

            <span class="c1"># VectorBT 4-stage per-bar process:</span>
            <span class="c1"># Stage 1: Update peak with open (before checking stop)</span>
            <span class="n">peak_price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;peak_price&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">open</span> <span class="o">&gt;</span> <span class="n">peak_price</span><span class="p">:</span>
                <span class="n">peak_price</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">open</span>
                <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;peak_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_price</span>

            <span class="c1"># Stage 2: Check TSL trigger with current peak (against low)</span>
            <span class="c1"># Calculate TSL level from peak, not current price</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">trail_percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trail_amount</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">*</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">trail_percent</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
                <span class="c1"># BUG FIX: Logic was inverted (same as bracket code fix)</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="c1"># BUY order (exiting short): TSL above peak</span>
                    <span class="n">tsl_level</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">+</span> <span class="n">trail_amount</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># SELL order (exiting long): TSL below peak</span>
                    <span class="n">tsl_level</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">-</span> <span class="n">trail_amount</span>

                <span class="n">order</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">tsl_level</span>

                <span class="c1"># Check if triggered (for long exit: low &lt;= tsl_level)</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">can_fill</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">low</span><span class="p">):</span>
                    <span class="n">triggered_trailing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_trailing_stops</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                    <span class="k">continue</span>  <span class="c1"># Skip stage 3/4 if triggered</span>

            <span class="c1"># Stage 3: Update peak with high (after checking stop)</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">high</span> <span class="o">&gt;</span> <span class="n">peak_price</span><span class="p">:</span>
                <span class="n">peak_price</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">high</span>
                <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;peak_price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_price</span>

            <span class="c1"># Stage 4: Re-check TSL with updated peak (against close)</span>
            <span class="c1"># Recalculate TSL level with potentially updated peak</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">trail_percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">is_filled</span><span class="p">:</span>
                <span class="n">trail_amount</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">*</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">trail_percent</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
                <span class="c1"># BUG FIX: Same as Stage 2</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="c1"># BUY order (exiting short): TSL above peak</span>
                    <span class="n">tsl_level</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">+</span> <span class="n">trail_amount</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># SELL order (exiting long): TSL below peak</span>
                    <span class="n">tsl_level</span> <span class="o">=</span> <span class="n">peak_price</span> <span class="o">-</span> <span class="n">trail_amount</span>

                <span class="n">order</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">tsl_level</span>

        <span class="c1"># Process triggered trailing stops immediately (as market orders)</span>
        <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">triggered_trailing</span><span class="p">:</span>
            <span class="n">original_type</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span>
            <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;TRAILING_STOP&quot;</span>
            <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">=</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span>
            <span class="n">fill_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_simulator</span><span class="o">.</span><span class="n">try_fill_order</span><span class="p">(</span>
                <span class="n">order</span><span class="p">,</span>
                <span class="n">market_price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
                <span class="n">current_cash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_cash</span><span class="p">(),</span>
                <span class="n">current_position</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">),</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">low</span><span class="p">,</span>
                <span class="n">close</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">fill_result</span><span class="p">:</span>
                <span class="c1"># Check position before fill (for exit tracking)</span>
                <span class="n">position_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">)</span>

                <span class="c1"># Update position tracker</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">update_position</span><span class="p">(</span>
                    <span class="n">asset_id</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_quantity</span><span class="p">,</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_price</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">slippage</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Track exit timestamp if position went to zero (for allow_immediate_reentry=False)</span>
                <span class="n">position_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">position_before</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">position_after</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_exit_time</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span>

                <span class="c1"># Update statistics</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_total_commission</span> <span class="o">+=</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">commission</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_total_slippage</span> <span class="o">+=</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">slippage</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Track trade (efficient - minimal overhead)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trade_tracker</span><span class="o">.</span><span class="n">on_fill</span><span class="p">(</span><span class="n">fill_result</span><span class="o">.</span><span class="n">fill_event</span><span class="p">)</span>

                <span class="n">fills</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fill_result</span><span class="o">.</span><span class="n">fill_event</span><span class="p">)</span>

                <span class="c1"># FIX: Handle OCO logic for bracket legs that are filled as trailing stops (delegates to BracketOrderManager)</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_filled</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">child_order_ids</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bracket_type&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bracket_manager</span><span class="o">.</span><span class="n">handle_oco_fill</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If couldn&#39;t fill as market order, restore type and add to open orders</span>
                <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">=</span> <span class="n">original_type</span>
                <span class="k">del</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="c1"># TASK-019: Process bracket exits with VectorBT priority (SL &gt; TSL &gt; TP)</span>
        <span class="c1"># Collect all triggered bracket exits without filling them</span>
        <span class="n">triggered_bracket_exits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_triggered_bracket_exits</span><span class="p">(</span><span class="n">asset_id</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>

        <span class="c1"># Fill ONLY the highest priority exit (if any triggered)</span>
        <span class="k">if</span> <span class="n">triggered_bracket_exits</span><span class="p">:</span>
            <span class="n">priority</span><span class="p">,</span> <span class="n">bracket_type</span><span class="p">,</span> <span class="n">winning_order</span> <span class="o">=</span> <span class="n">triggered_bracket_exits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Remove winning order from its queue</span>
            <span class="k">if</span> <span class="n">bracket_type</span> <span class="o">==</span> <span class="s2">&quot;take_profit&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">winning_order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">winning_order</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">bracket_type</span> <span class="o">==</span> <span class="s2">&quot;stop_loss&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">winning_order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stop_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">winning_order</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">bracket_type</span> <span class="o">==</span> <span class="s2">&quot;trailing_stop&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">winning_order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trailing_stops</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_trailing_stops</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">winning_order</span><span class="p">)</span>

            <span class="c1"># Convert stop/trailing orders to MARKET for filling</span>
            <span class="n">original_type</span> <span class="o">=</span> <span class="n">winning_order</span><span class="o">.</span><span class="n">order_type</span>
            <span class="k">if</span> <span class="n">bracket_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop_loss&quot;</span><span class="p">,</span> <span class="s2">&quot;trailing_stop&quot;</span><span class="p">]:</span>
                <span class="n">winning_order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_type</span><span class="o">.</span><span class="n">value</span>
                <span class="n">winning_order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">=</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span>

            <span class="c1"># Fill the winning exit</span>
            <span class="n">fill_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_simulator</span><span class="o">.</span><span class="n">try_fill_order</span><span class="p">(</span>
                <span class="n">winning_order</span><span class="p">,</span>
                <span class="n">market_price</span><span class="o">=</span><span class="n">price</span><span class="p">,</span>
                <span class="n">current_cash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_cash</span><span class="p">(),</span>
                <span class="n">current_position</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">),</span>
                <span class="n">timestamp</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">low</span><span class="p">,</span>
                <span class="n">close</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">close</span><span class="p">,</span>
                <span class="nb">open</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">open</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">fill_result</span><span class="p">:</span>
                <span class="c1"># Check position before fill (for exit tracking)</span>
                <span class="n">position_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">)</span>

                <span class="c1"># Update position tracker</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">update_position</span><span class="p">(</span>
                    <span class="n">asset_id</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_quantity</span><span class="p">,</span>
                    <span class="n">winning_order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">fill_price</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
                    <span class="n">fill_result</span><span class="o">.</span><span class="n">slippage</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Track exit timestamp if position went to zero</span>
                <span class="n">position_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">position_before</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">position_after</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_exit_time</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">timestamp</span>

                <span class="c1"># Update statistics</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_total_commission</span> <span class="o">+=</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">commission</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_total_slippage</span> <span class="o">+=</span> <span class="n">fill_result</span><span class="o">.</span><span class="n">slippage</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Track trade</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trade_tracker</span><span class="o">.</span><span class="n">on_fill</span><span class="p">(</span><span class="n">fill_result</span><span class="o">.</span><span class="n">fill_event</span><span class="p">)</span>

                <span class="n">fills</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fill_result</span><span class="o">.</span><span class="n">fill_event</span><span class="p">)</span>

                <span class="c1"># Handle OCO logic to cancel sibling bracket orders</span>
                <span class="k">if</span> <span class="n">winning_order</span><span class="o">.</span><span class="n">is_filled</span> <span class="ow">and</span> <span class="n">winning_order</span><span class="o">.</span><span class="n">child_order_ids</span> <span class="ow">and</span> <span class="n">winning_order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bracket_type&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bracket_manager</span><span class="o">.</span><span class="n">handle_oco_fill</span><span class="p">(</span><span class="n">winning_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If couldn&#39;t fill, restore order type and add back to queue</span>
                <span class="k">if</span> <span class="n">bracket_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;stop_loss&quot;</span><span class="p">,</span> <span class="s2">&quot;trailing_stop&quot;</span><span class="p">]:</span>
                    <span class="n">winning_order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">=</span> <span class="n">original_type</span>
                    <span class="k">if</span> <span class="s2">&quot;original_type&quot;</span> <span class="ow">in</span> <span class="n">winning_order</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">winning_order</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;original_type&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">bracket_type</span> <span class="o">==</span> <span class="s2">&quot;take_profit&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">winning_order</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">bracket_type</span> <span class="o">==</span> <span class="s2">&quot;stop_loss&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stop_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">winning_order</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">bracket_type</span> <span class="o">==</span> <span class="s2">&quot;trailing_stop&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_trailing_stops</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">winning_order</span><span class="p">)</span>

        <span class="c1"># CRITICAL FIX: Move pending orders to open AFTER processing current orders</span>
        <span class="c1"># This ensures orders cannot be filled on the same event that triggered them</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_delay</span> <span class="ow">and</span> <span class="n">asset_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_orders</span><span class="p">:</span>
            <span class="c1"># Move pending orders to open orders for NEXT event&#39;s processing</span>
            <span class="k">for</span> <span class="n">order</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">BRACKET</span><span class="p">:</span>
                    <span class="c1"># Bracket orders start as regular orders and create legs after fill</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="c1"># Clear pending orders after moving them</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pending_orders</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Publish fill events to the event bus (if available)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;event_bus&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fill_event</span> <span class="ow">in</span> <span class="n">fills</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">fill_event</span><span class="p">)</span>

        <span class="c1"># Clear newly-created brackets set for next event (VectorBT: brackets now active)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_newly_created_brackets</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fills</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_should_trigger_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">price</span><span class="p">:</span> <span class="n">Price</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if stop order should be triggered.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">stop_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">price</span> <span class="o">&gt;=</span> <span class="n">order</span><span class="o">.</span><span class="n">stop_price</span>
        <span class="k">return</span> <span class="n">price</span> <span class="o">&lt;=</span> <span class="n">order</span><span class="o">.</span><span class="n">stop_price</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_bracket_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">fill_event</span><span class="p">:</span> <span class="n">FillEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle completion of bracket order by creating stop-loss and take-profit orders.</span>
<span class="sd">        (Delegates to BracketOrderManager)</span>

<span class="sd">        Args:</span>
<span class="sd">            parent_order: The filled bracket order</span>
<span class="sd">            fill_event: The fill event that completed the order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">leg_orders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bracket_manager</span><span class="o">.</span><span class="n">handle_bracket_fill</span><span class="p">(</span><span class="n">parent_order</span><span class="p">,</span> <span class="n">fill_event</span><span class="p">)</span>

        <span class="c1"># Track parent-child relationship and mark as newly created (VectorBT: skip same-bar checking)</span>
        <span class="k">if</span> <span class="n">leg_orders</span><span class="p">:</span>
            <span class="n">parent_order</span><span class="o">.</span><span class="n">child_order_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">order_id</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">leg_orders</span><span class="p">])</span>
            <span class="c1"># Add to newly-created set so they won&#39;t be checked until next bar</span>
            <span class="k">for</span> <span class="n">leg_order</span> <span class="ow">in</span> <span class="n">leg_orders</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_newly_created_brackets</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">leg_order</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>


<div class="viewcode-block" id="SimulationBroker.get_position">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.get_position">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_id</span><span class="p">:</span> <span class="n">AssetId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Quantity</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current position for an asset (delegates to PositionTracker).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">asset_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimulationBroker.get_positions">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.get_positions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">AssetId</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all current positions (delegates to PositionTracker).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_all_positions</span><span class="p">()</span></div>


<div class="viewcode-block" id="SimulationBroker.get_cash">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.get_cash">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current cash balance (delegates to PositionTracker).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">get_cash</span><span class="p">()</span></div>


<div class="viewcode-block" id="SimulationBroker.get_statistics">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.get_statistics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get broker statistics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;total_commission&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_commission</span><span class="p">,</span>
            <span class="s2">&quot;total_slippage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_slippage</span><span class="p">,</span>
            <span class="s2">&quot;fill_count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span><span class="p">,</span>
            <span class="s2">&quot;open_orders&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="k">for</span> <span class="n">orders</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s2">&quot;stop_orders&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="k">for</span> <span class="n">orders</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_orders</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="SimulationBroker.initialize">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.initialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">portfolio</span><span class="p">,</span> <span class="n">event_bus</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize broker with portfolio and event bus.</span>

<span class="sd">        Args:</span>
<span class="sd">            portfolio: Portfolio instance for position tracking</span>
<span class="sd">            event_bus: Event bus for publishing fill events</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">portfolio</span> <span class="o">=</span> <span class="n">portfolio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_bus</span> <span class="o">=</span> <span class="n">event_bus</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SimulationBroker initialized&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimulationBroker.on_order_event">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.on_order_event">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_order_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle order event from strategy.</span>

<span class="sd">        Args:</span>
<span class="sd">            event: OrderEvent to process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span>

        <span class="c1"># Create Order object from OrderEvent</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="n">asset_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">asset_id</span><span class="p">,</span>
            <span class="n">order_type</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">order_type</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
            <span class="n">quantity</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span>
            <span class="n">limit_price</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s2">&quot;limit_price&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">stop_price</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s2">&quot;stop_price&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">time_in_force</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s2">&quot;time_in_force&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Submit the order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimulationBroker.finalize">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.finalize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finalize broker at end of backtest.&quot;&quot;&quot;</span>
        <span class="c1"># Cancel all remaining open orders</span>
        <span class="k">for</span> <span class="n">asset_orders</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_orders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">asset_orders</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">asset_orders</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_orders</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">asset_orders</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                    <span class="n">order</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SimulationBroker finalized. Total fills: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SimulationBroker.get_trades">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.get_trades">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_trades</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all executed trades.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame or list of trades</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>

        <span class="n">trades</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">order_id</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">filled_quantity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;order_id&quot;</span><span class="p">:</span> <span class="n">order_id</span><span class="p">,</span>
                        <span class="s2">&quot;asset_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">,</span>
                        <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">filled_quantity</span><span class="p">,</span>
                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_fill_price</span><span class="p">,</span>
                        <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="s2">&quot;submitted_time&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">submitted_time</span><span class="p">,</span>
                        <span class="s2">&quot;filled_time&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">filled_time</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">trades</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span></div>


<div class="viewcode-block" id="SimulationBroker.reset">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.broker.SimulationBroker.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset broker to initial state (delegates to components).</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If reset() called before initialization</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;initial_cash&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;SimulationBroker.reset() called before initialization. &quot;</span>
                <span class="s2">&quot;Call __init__() with initial_cash parameter first.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Reset components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_tracker</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_router</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bracket_manager</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_simulator</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># Reset local state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_prices</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_commission</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_slippage</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SimulationBroker reset (all components)&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, ML4T.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>