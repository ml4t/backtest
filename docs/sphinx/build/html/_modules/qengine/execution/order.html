

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qengine.execution.order &mdash; qengine 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            qengine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/core.html">Core Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/execution.html">Execution Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/portfolio.html">Portfolio Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/strategy.html">Strategy Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/data.html">Data Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/reporting.html">Reporting Module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">qengine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">qengine.execution.order</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qengine.execution.order</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Order management for QEngine.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.core.types</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AssetId</span><span class="p">,</span>
    <span class="n">OrderId</span><span class="p">,</span>
    <span class="n">OrderSide</span><span class="p">,</span>
    <span class="n">OrderStatus</span><span class="p">,</span>
    <span class="n">OrderType</span><span class="p">,</span>
    <span class="n">Price</span><span class="p">,</span>
    <span class="n">Quantity</span><span class="p">,</span>
    <span class="n">TimeInForce</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="OrderState">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.order.OrderState">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderState</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Order lifecycle states.&quot;&quot;&quot;</span>

    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>  <span class="c1"># Created but not yet submitted</span>
    <span class="n">SUBMITTED</span> <span class="o">=</span> <span class="s2">&quot;submitted&quot;</span>  <span class="c1"># Sent to broker</span>
    <span class="n">ACKNOWLEDGED</span> <span class="o">=</span> <span class="s2">&quot;acknowledged&quot;</span>  <span class="c1"># Broker confirmed receipt</span>
    <span class="n">PARTIALLY_FILLED</span> <span class="o">=</span> <span class="s2">&quot;partially_filled&quot;</span>  <span class="c1"># Some quantity filled</span>
    <span class="n">FILLED</span> <span class="o">=</span> <span class="s2">&quot;filled&quot;</span>  <span class="c1"># Completely filled</span>
    <span class="n">CANCELLED</span> <span class="o">=</span> <span class="s2">&quot;cancelled&quot;</span>  <span class="c1"># Cancelled by user</span>
    <span class="n">REJECTED</span> <span class="o">=</span> <span class="s2">&quot;rejected&quot;</span>  <span class="c1"># Rejected by broker</span>
    <span class="n">EXPIRED</span> <span class="o">=</span> <span class="s2">&quot;expired&quot;</span>  <span class="c1"># Expired due to time constraint</span></div>



<div class="viewcode-block" id="Order">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.order.Order">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Order</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a trading order.&quot;&quot;&quot;</span>

    <span class="c1"># Core identifiers</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="n">OrderId</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
    <span class="n">asset_id</span><span class="p">:</span> <span class="n">AssetId</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Order specifications</span>
    <span class="n">order_type</span><span class="p">:</span> <span class="n">OrderType</span> <span class="o">=</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span>
    <span class="n">side</span><span class="p">:</span> <span class="n">OrderSide</span> <span class="o">=</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span>
    <span class="n">quantity</span><span class="p">:</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Price constraints</span>
    <span class="n">limit_price</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stop_price</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Advanced order type parameters</span>
    <span class="n">trail_amount</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># For trailing stops (absolute)</span>
    <span class="n">trail_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># For trailing stops (percentage)</span>
    <span class="n">trailing_stop_price</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Current trailing stop level</span>

    <span class="c1"># Bracket order parameters (absolute prices)</span>
    <span class="n">profit_target</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Take profit level (absolute price)</span>
    <span class="n">stop_loss</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Stop loss level (absolute price)</span>

    <span class="c1"># Bracket order parameters (percentage-based, VectorBT compatible)</span>
    <span class="n">tp_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Take profit as percentage (e.g., 0.025 = 2.5%)</span>
    <span class="n">sl_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Stop loss as percentage (e.g., 0.02 = 2%)</span>
    <span class="n">tsl_pct</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Trailing stop as percentage (e.g., 0.01 = 1%)</span>

    <span class="c1"># Time constraints</span>
    <span class="n">time_in_force</span><span class="p">:</span> <span class="n">TimeInForce</span> <span class="o">=</span> <span class="n">TimeInForce</span><span class="o">.</span><span class="n">DAY</span>
    <span class="n">expire_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># State tracking</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">OrderState</span> <span class="o">=</span> <span class="n">OrderState</span><span class="o">.</span><span class="n">PENDING</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">OrderStatus</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CREATED</span>

    <span class="c1"># Timestamps</span>
    <span class="n">created_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
    <span class="n">submitted_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">acknowledged_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">filled_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cancelled_time</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Fill information</span>
    <span class="n">filled_quantity</span><span class="p">:</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">average_fill_price</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fill_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Costs</span>
    <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">slippage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Relationships</span>
    <span class="n">parent_order_id</span><span class="p">:</span> <span class="n">OrderId</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">child_order_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">OrderId</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="c1"># Metadata</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

<div class="viewcode-block" id="Order.__post_init__">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.order.Order.__post_init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate order on creation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Limit orders must have a limit price&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">STOP</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Stop orders must have a stop price&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">STOP_LIMIT</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_price</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Stop-limit orders must have both stop and limit prices&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">TRAILING_STOP</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_amount</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_percent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Trailing stop orders must have trail_amount or trail_percent&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">BRACKET</span><span class="p">:</span>
            <span class="c1"># Allow either absolute prices OR percentage-based parameters</span>
            <span class="n">has_absolute</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profit_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">has_percentage</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tp_pct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sl_pct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsl_pct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">has_absolute</span> <span class="ow">or</span> <span class="n">has_percentage</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Bracket orders must have exit parameters: &quot;</span>
                    <span class="s2">&quot;profit_target/stop_loss (absolute) OR tp_pct/sl_pct/tsl_pct (percentage)&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Order quantity must be positive&quot;</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_buy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this is a buy order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">BUY</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_sell</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this is a sell order.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">side</span> <span class="o">==</span> <span class="n">OrderSide</span><span class="o">.</span><span class="n">SELL</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_filled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if order is completely filled.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OrderState</span><span class="o">.</span><span class="n">FILLED</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_partially_filled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if order is partially filled.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">OrderState</span><span class="o">.</span><span class="n">PARTIALLY_FILLED</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if order is still active.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">OrderState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span>
            <span class="n">OrderState</span><span class="o">.</span><span class="n">SUBMITTED</span><span class="p">,</span>
            <span class="n">OrderState</span><span class="o">.</span><span class="n">ACKNOWLEDGED</span><span class="p">,</span>
            <span class="n">OrderState</span><span class="o">.</span><span class="n">PARTIALLY_FILLED</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if order is in a terminal state.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">OrderState</span><span class="o">.</span><span class="n">FILLED</span><span class="p">,</span>
            <span class="n">OrderState</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">,</span>
            <span class="n">OrderState</span><span class="o">.</span><span class="n">REJECTED</span><span class="p">,</span>
            <span class="n">OrderState</span><span class="o">.</span><span class="n">EXPIRED</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">remaining_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Quantity</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get remaining quantity to fill.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled_quantity</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fill_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the ratio of filled quantity to total.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled_quantity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span>

<div class="viewcode-block" id="Order.can_fill">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.order.Order.can_fill">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">can_fill</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">price</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">high</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">low</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if order can be filled at given price or OHLC range.</span>

<span class="sd">        For intrabar execution (matching VectorBT Pro):</span>
<span class="sd">        - Limit orders (TP): Check if high (for longs) or low (for shorts) reached limit</span>
<span class="sd">        - Stop orders (SL/TSL): Check if low (for longs) or high (for shorts) reached stop</span>
<span class="sd">        - Market orders: Always fill</span>

<span class="sd">        Args:</span>
<span class="sd">            price: Current market price (close) - for backward compatibility</span>
<span class="sd">            high: Bar&#39;s high price (for intrabar limit order checks)</span>
<span class="sd">            low: Bar&#39;s low price (for intrabar stop order checks)</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if order can be filled</span>

<span class="sd">        Note:</span>
<span class="sd">            If high/low are provided, uses intrabar execution logic.</span>
<span class="sd">            If only price is provided, falls back to end-of-bar logic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Market orders always fill</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Determine check price based on order type and available data</span>
        <span class="c1"># For intrabar execution, use high/low to detect if limit/stop was touched</span>
        <span class="n">use_intrabar</span> <span class="o">=</span> <span class="n">high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">use_intrabar</span><span class="p">:</span>
                <span class="c1"># Intrabar check: Did price touch the limit during the bar?</span>
                <span class="c1"># For LIMIT orders, we want to check if the bar touched the favorable side</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="c1"># BUY LIMIT: Want to buy at or below limit (e.g., entry or short TP)</span>
                    <span class="c1"># Check if LOW reached limit (price went down to our buy limit)</span>
                    <span class="k">return</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># SELL LIMIT: Want to sell at or above limit (e.g., long TP)</span>
                    <span class="c1"># Check if HIGH reached limit (price went up to our sell limit)</span>
                    <span class="k">return</span> <span class="n">high</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># End-of-bar check: Use closing price</span>
                <span class="n">check_price</span> <span class="o">=</span> <span class="n">price</span> <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">check_price</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>
                <span class="k">return</span> <span class="n">check_price</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">STOP</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">use_intrabar</span><span class="p">:</span>
                <span class="c1"># Intrabar check: Did price touch the stop during the bar?</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="c1"># Short cover stop: Check if HIGH reached stop</span>
                    <span class="k">return</span> <span class="n">high</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_price</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Long SL: Check if LOW reached stop (price went down to SL)</span>
                    <span class="k">return</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_price</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># End-of-bar check</span>
                <span class="n">check_price</span> <span class="o">=</span> <span class="n">price</span> <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">check_price</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_price</span>
                <span class="k">return</span> <span class="n">check_price</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_price</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">STOP_LIMIT</span><span class="p">:</span>
            <span class="c1"># For simplicity, assume stop has been triggered if we get here</span>
            <span class="c1"># The broker will handle the trigger logic</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">use_intrabar</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">high</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>
                <span class="k">return</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check_price</span> <span class="o">=</span> <span class="n">price</span> <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">check_price</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>
                <span class="k">return</span> <span class="n">check_price</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">TRAILING_STOP</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">use_intrabar</span><span class="p">:</span>
                <span class="c1"># Intrabar check for trailing stops</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="c1"># Short cover: Check if HIGH reached trailing stop</span>
                    <span class="k">return</span> <span class="n">high</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Long TSL: Check if LOW reached trailing stop</span>
                    <span class="k">return</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># End-of-bar check</span>
                <span class="n">check_price</span> <span class="o">=</span> <span class="n">price</span> <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">check_price</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span>
                <span class="k">return</span> <span class="n">check_price</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">BRACKET</span><span class="p">:</span>
            <span class="c1"># Bracket orders fill based on their entry criteria (limit_price if set)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Act like a limit order for entry</span>
                <span class="k">if</span> <span class="n">use_intrabar</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">high</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>
                    <span class="k">return</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">check_price</span> <span class="o">=</span> <span class="n">price</span> <span class="k">if</span> <span class="n">price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">check_price</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>
                    <span class="k">return</span> <span class="n">check_price</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_price</span>
            <span class="c1"># Act like a market order for entry</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># OCO and other special orders</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Order.update_fill">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.order.Order.update_fill">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_fill</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fill_quantity</span><span class="p">:</span> <span class="n">Quantity</span><span class="p">,</span>
        <span class="n">fill_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
        <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update order with fill information.</span>

<span class="sd">        Args:</span>
<span class="sd">            fill_quantity: Quantity filled</span>
<span class="sd">            fill_price: Price of fill</span>
<span class="sd">            commission: Commission charged</span>
<span class="sd">            timestamp: Time of fill</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fill_quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fill quantity must be positive&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fill_quantity</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining_quantity</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Fill quantity </span><span class="si">{</span><span class="n">fill_quantity</span><span class="si">}</span><span class="s2"> exceeds remaining </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remaining_quantity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Update fill tracking</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_fill_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">average_fill_price</span> <span class="o">=</span> <span class="n">fill_price</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Calculate weighted average</span>
            <span class="n">total_value</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filled_quantity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_fill_price</span> <span class="o">+</span> <span class="n">fill_quantity</span> <span class="o">*</span> <span class="n">fill_price</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">average_fill_price</span> <span class="o">=</span> <span class="n">total_value</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filled_quantity</span> <span class="o">+</span> <span class="n">fill_quantity</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filled_quantity</span> <span class="o">+=</span> <span class="n">fill_quantity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission</span> <span class="o">+=</span> <span class="n">commission</span>

        <span class="c1"># Update state</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filled_quantity</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OrderState</span><span class="o">.</span><span class="n">FILLED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">FILLED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filled_time</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OrderState</span><span class="o">.</span><span class="n">PARTIALLY_FILLED</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">PARTIALLY_FILLED</span></div>


<div class="viewcode-block" id="Order.cancel">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.order.Order.cancel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel the order.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot cancel order in state </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OrderState</span><span class="o">.</span><span class="n">CANCELLED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">CANCELED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_time</span> <span class="o">=</span> <span class="n">timestamp</span></div>


<div class="viewcode-block" id="Order.reject">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.order.Order.reject">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reject the order.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OrderState</span><span class="o">.</span><span class="n">REJECTED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">OrderStatus</span><span class="o">.</span><span class="n">REJECTED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;rejection_reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_time</span> <span class="o">=</span> <span class="n">timestamp</span></div>


<div class="viewcode-block" id="Order.update_trailing_stop">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.order.Order.update_trailing_stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_trailing_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update trailing stop price based on current market price.</span>

<span class="sd">        Args:</span>
<span class="sd">            current_price: Current market price</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if trailing stop was updated, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_type</span> <span class="o">!=</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">TRAILING_STOP</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Initialize trailing stop price if not set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_amount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_amount</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_amount</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trail_amount</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trail_percent</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">+</span> <span class="n">trail_amount</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">-</span> <span class="n">trail_amount</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Update trailing stop if price moves favorably</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_amount</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Absolute trailing amount</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                <span class="c1"># For buy stops, trail up when price falls</span>
                <span class="n">new_stop</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_amount</span>
                <span class="k">if</span> <span class="n">new_stop</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">new_stop</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For sell stops, trail down when price rises</span>
                <span class="n">new_stop</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_amount</span>
                <span class="k">if</span> <span class="n">new_stop</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">new_stop</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trail_percent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Percentage trailing amount</span>
            <span class="n">trail_amount</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trail_percent</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                <span class="n">new_stop</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">+</span> <span class="n">trail_amount</span>
                <span class="k">if</span> <span class="n">new_stop</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">new_stop</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_stop</span> <span class="o">=</span> <span class="n">current_price</span> <span class="o">-</span> <span class="n">trail_amount</span>
                <span class="k">if</span> <span class="n">new_stop</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trailing_stop_price</span> <span class="o">=</span> <span class="n">new_stop</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">updated</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Order(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">order_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">side</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">quantity</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">asset_id</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">, state=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, ML4T.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>