

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qengine.execution.fill_simulator &mdash; qengine 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            qengine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/core.html">Core Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/execution.html">Execution Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/portfolio.html">Portfolio Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/strategy.html">Strategy Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/data.html">Data Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/reporting.html">Reporting Module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">qengine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">qengine.execution.fill_simulator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qengine.execution.fill_simulator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Order fill simulation with market realism.</span>

<span class="sd">This module provides order fill simulation functionality extracted from</span>
<span class="sd">SimulationBroker to follow the Single Responsibility Principle.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.core.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">MAX_COMMISSION_CALC_ITERATIONS</span><span class="p">,</span> <span class="n">MIN_FILL_SIZE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.core.event</span><span class="w"> </span><span class="kn">import</span> <span class="n">FillEvent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.core.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Price</span><span class="p">,</span> <span class="n">Quantity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.data.asset_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">AssetRegistry</span><span class="p">,</span> <span class="n">AssetSpec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.commission</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommissionModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.liquidity</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiquidityModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.market_impact</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarketImpactModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">OrderType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.execution.slippage</span><span class="w"> </span><span class="kn">import</span> <span class="n">SlippageModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qengine.portfolio.margin</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarginAccount</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="FillResult">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.fill_simulator.FillResult">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FillResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Result of a successful order fill.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        fill_event: The generated fill event</span>
<span class="sd">        commission: Commission cost for this fill</span>
<span class="sd">        slippage: Slippage cost for this fill (tracking only, already in fill_price)</span>
<span class="sd">        fill_quantity: Actual quantity filled (may be less than order quantity)</span>
<span class="sd">        fill_price: Actual fill price (includes slippage)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fill_event</span><span class="p">:</span> <span class="n">FillEvent</span>
    <span class="n">commission</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">slippage</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">fill_quantity</span><span class="p">:</span> <span class="n">Quantity</span>
    <span class="n">fill_price</span><span class="p">:</span> <span class="n">Price</span></div>



<div class="viewcode-block" id="FillSimulator">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.fill_simulator.FillSimulator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FillSimulator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulates order fills with realistic market constraints.</span>

<span class="sd">    Responsibilities:</span>
<span class="sd">    - Determine if order can fill at market price</span>
<span class="sd">    - Apply market impact to market price</span>
<span class="sd">    - Calculate fill price with slippage</span>
<span class="sd">    - Apply liquidity constraints</span>
<span class="sd">    - Check margin requirements (derivatives)</span>
<span class="sd">    - Check cash constraints (equities)</span>
<span class="sd">    - Calculate commission and slippage costs</span>
<span class="sd">    - Update order state and model states</span>
<span class="sd">    - Generate FillEvent</span>

<span class="sd">    This class does NOT:</span>
<span class="sd">    - Track positions (PositionTracker)</span>
<span class="sd">    - Route orders (OrderRouter)</span>
<span class="sd">    - Manage bracket orders (BracketOrderManager)</span>

<span class="sd">    Design Notes:</span>
<span class="sd">    - Order mutation: FillSimulator calls order.update_fill() to update order state.</span>
<span class="sd">      This is acceptable coupling because fills conceptually update order lifecycle.</span>

<span class="sd">    - Model updates: FillSimulator updates MarketImpactModel and LiquidityModel state</span>
<span class="sd">      after fills. This keeps all fill-related side effects in one place.</span>

<span class="sd">    - Stateless operation: Position and cash are passed as parameters to try_fill_order,</span>
<span class="sd">      not stored in FillSimulator. This allows testing without broker context.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FillSimulator.__init__">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.fill_simulator.FillSimulator.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">asset_registry</span><span class="p">:</span> <span class="n">AssetRegistry</span><span class="p">,</span>
        <span class="n">commission_model</span><span class="p">:</span> <span class="n">CommissionModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">slippage_model</span><span class="p">:</span> <span class="n">SlippageModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">market_impact_model</span><span class="p">:</span> <span class="n">MarketImpactModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">liquidity_model</span><span class="p">:</span> <span class="n">LiquidityModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">margin_account</span><span class="p">:</span> <span class="n">MarginAccount</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_leverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize fill simulator.</span>

<span class="sd">        Args:</span>
<span class="sd">            asset_registry: Registry for asset specifications</span>
<span class="sd">            commission_model: Optional commission calculator</span>
<span class="sd">            slippage_model: Optional slippage calculator</span>
<span class="sd">            market_impact_model: Optional market impact model</span>
<span class="sd">            liquidity_model: Optional liquidity constraint model</span>
<span class="sd">            margin_account: Optional margin account (for derivatives)</span>
<span class="sd">            max_leverage: Maximum leverage allowed (default 1.0 = no leverage).</span>
<span class="sd">                For cash-based trading, limits position size to max_leverage * available_cash.</span>
<span class="sd">                Example: max_leverage=2.0 allows positions up to 2x cash balance.</span>
<span class="sd">                This prevents unlimited leverage as capital depletes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asset_registry</span> <span class="o">=</span> <span class="n">asset_registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commission_model</span> <span class="o">=</span> <span class="n">commission_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slippage_model</span> <span class="o">=</span> <span class="n">slippage_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_impact_model</span> <span class="o">=</span> <span class="n">market_impact_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">liquidity_model</span> <span class="o">=</span> <span class="n">liquidity_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin_account</span> <span class="o">=</span> <span class="n">margin_account</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span> <span class="o">=</span> <span class="n">max_leverage</span>

        <span class="c1"># Track fill count for trade IDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FillSimulator initialized with max_leverage=</span><span class="si">{</span><span class="n">max_leverage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FillSimulator.try_fill_order">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.fill_simulator.FillSimulator.try_fill_order">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">try_fill_order</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
        <span class="n">market_price</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">current_cash</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">current_position</span><span class="p">:</span> <span class="n">Quantity</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">high</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">low</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">close</span><span class="p">:</span> <span class="n">Price</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FillResult</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attempt to fill an order at the given market price or OHLC data.</span>

<span class="sd">        This method applies all market realism constraints:</span>
<span class="sd">        1. Validates order can fill at market price (using intrabar if high/low provided)</span>
<span class="sd">        2. Applies market impact to market price</span>
<span class="sd">        3. Calculates fill price with slippage</span>
<span class="sd">        4. Applies liquidity constraints</span>
<span class="sd">        5. Applies margin or cash constraints</span>
<span class="sd">        6. Calculates commission and slippage costs</span>
<span class="sd">        7. Updates order state</span>
<span class="sd">        8. Updates model states (market impact, liquidity)</span>
<span class="sd">        9. Generates FillEvent</span>

<span class="sd">        Args:</span>
<span class="sd">            order: Order to attempt filling</span>
<span class="sd">            market_price: Current market price (for backward compatibility)</span>
<span class="sd">            current_cash: Available cash for purchases</span>
<span class="sd">            current_position: Current position quantity for the asset</span>
<span class="sd">            timestamp: Event timestamp</span>
<span class="sd">            high: Bar&#39;s high price (for intrabar limit order detection)</span>
<span class="sd">            low: Bar&#39;s low price (for intrabar stop order detection)</span>
<span class="sd">            close: Bar&#39;s close price (used as fill price and fallback)</span>

<span class="sd">        Returns:</span>
<span class="sd">            FillResult if order was filled, None if order cannot be filled</span>

<span class="sd">        Note:</span>
<span class="sd">            This method has side effects:</span>
<span class="sd">            - Modifies order state via order.update_fill()</span>
<span class="sd">            - Updates market impact model state</span>
<span class="sd">            - Updates liquidity model state</span>
<span class="sd">            - Increments internal fill counter</span>

<span class="sd">            For VectorBT Pro compatibility, prefer passing high/low/close for intrabar</span>
<span class="sd">            execution. If only market_price is provided, falls back to end-of-bar logic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine the price to use for checks and fills</span>
        <span class="c1"># Prefer close from OHLC, fallback to market_price for backward compatibility</span>
        <span class="n">check_price</span> <span class="o">=</span> <span class="n">close</span> <span class="k">if</span> <span class="n">close</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">market_price</span>
        <span class="k">if</span> <span class="n">check_price</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No price data provided to try_fill_order&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check if order can be filled using intrabar execution if high/low available</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">can_fill</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">check_price</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="n">low</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Apply market impact to the market price</span>
        <span class="n">impacted_market_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_market_price_with_impact</span><span class="p">(</span>
            <span class="n">order</span><span class="p">,</span>
            <span class="n">check_price</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Determine fill price (with slippage on top of impact)</span>
        <span class="n">fill_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_fill_price</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">impacted_market_price</span><span class="p">)</span>

        <span class="c1"># Determine fill quantity considering liquidity constraints</span>
        <span class="n">fill_quantity</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">remaining_quantity</span>

        <span class="c1"># Get asset specification</span>
        <span class="n">asset_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asset_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">)</span>

        <span class="c1"># Apply liquidity constraints if model is available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquidity_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">adjusted_quantity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_liquidity_constraints</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">fill_quantity</span><span class="p">,</span> <span class="n">check_price</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">adjusted_quantity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">fill_quantity</span> <span class="o">=</span> <span class="n">adjusted_quantity</span>

        <span class="c1"># Check margin requirements for derivatives, or cash for equities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_account</span> <span class="ow">and</span> <span class="n">asset_spec</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">,</span> <span class="s1">&#39;requires_margin&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Margin trading for derivatives</span>
            <span class="n">adjusted_quantity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_margin_constraints</span><span class="p">(</span>
                <span class="n">order</span><span class="p">,</span> <span class="n">fill_quantity</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="n">asset_spec</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">adjusted_quantity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">fill_quantity</span> <span class="o">=</span> <span class="n">adjusted_quantity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Standard cash trading for equities</span>
            <span class="n">adjusted_quantity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_cash_constraints</span><span class="p">(</span>
                <span class="n">order</span><span class="p">,</span> <span class="n">fill_quantity</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="n">current_cash</span><span class="p">,</span> <span class="n">current_position</span><span class="p">,</span> <span class="n">asset_spec</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">adjusted_quantity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">fill_quantity</span> <span class="o">=</span> <span class="n">adjusted_quantity</span>

        <span class="c1"># Calculate costs (asset-specific for different classes)</span>
        <span class="n">commission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_commission</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">fill_quantity</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="n">asset_spec</span><span class="p">)</span>
        <span class="n">slippage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_slippage</span><span class="p">(</span>
            <span class="n">order</span><span class="p">,</span>
            <span class="n">fill_quantity</span><span class="p">,</span>
            <span class="n">check_price</span><span class="p">,</span>
            <span class="n">fill_price</span><span class="p">,</span>
            <span class="n">asset_spec</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update order</span>
        <span class="n">order</span><span class="o">.</span><span class="n">update_fill</span><span class="p">(</span><span class="n">fill_quantity</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="n">commission</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

        <span class="c1"># Update market impact after fill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_market_impact</span><span class="p">(</span>
            <span class="n">order</span><span class="p">,</span>
            <span class="n">fill_quantity</span><span class="p">,</span>
            <span class="n">check_price</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update liquidity model after fill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_liquidity_model</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">fill_quantity</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">)</span>

        <span class="c1"># Increment fill count for trade ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Create fill event</span>
        <span class="n">fill_event</span> <span class="o">=</span> <span class="n">FillEvent</span><span class="p">(</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
            <span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="n">trade_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;T</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span><span class="si">:</span><span class="s2">06d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">asset_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
            <span class="n">fill_quantity</span><span class="o">=</span><span class="n">fill_quantity</span><span class="p">,</span>
            <span class="n">fill_price</span><span class="o">=</span><span class="n">fill_price</span><span class="p">,</span>
            <span class="n">commission</span><span class="o">=</span><span class="n">commission</span><span class="p">,</span>
            <span class="n">slippage</span><span class="o">=</span><span class="n">slippage</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>  <span class="c1"># Copy metadata from order to fill event</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filled order: </span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">fill_event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Return fill result</span>
        <span class="k">return</span> <span class="n">FillResult</span><span class="p">(</span>
            <span class="n">fill_event</span><span class="o">=</span><span class="n">fill_event</span><span class="p">,</span>
            <span class="n">commission</span><span class="o">=</span><span class="n">commission</span><span class="p">,</span>
            <span class="n">slippage</span><span class="o">=</span><span class="n">slippage</span><span class="p">,</span>
            <span class="n">fill_quantity</span><span class="o">=</span><span class="n">fill_quantity</span><span class="p">,</span>
            <span class="n">fill_price</span><span class="o">=</span><span class="n">fill_price</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_liquidity_constraints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
        <span class="n">fill_quantity</span><span class="p">:</span> <span class="n">Quantity</span><span class="p">,</span>
        <span class="n">market_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Quantity</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply liquidity constraints to fill quantity.</span>

<span class="sd">        Args:</span>
<span class="sd">            order: Order being filled</span>
<span class="sd">            fill_quantity: Desired fill quantity</span>
<span class="sd">            market_price: Current market price</span>

<span class="sd">        Returns:</span>
<span class="sd">            Adjusted fill quantity, or None if liquidity too low</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquidity_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fill_quantity</span>

        <span class="n">max_liquidity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquidity_model</span><span class="o">.</span><span class="n">get_max_fill_quantity</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">market_price</span><span class="p">)</span>
        <span class="n">adjusted_quantity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fill_quantity</span><span class="p">,</span> <span class="n">max_liquidity</span><span class="p">)</span>

        <span class="c1"># If liquidity constraint results in very small fill, reject the order</span>
        <span class="k">if</span> <span class="n">adjusted_quantity</span> <span class="o">&lt;</span> <span class="n">MIN_FILL_SIZE</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">adjusted_quantity</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_margin_constraints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
        <span class="n">fill_quantity</span><span class="p">:</span> <span class="n">Quantity</span><span class="p">,</span>
        <span class="n">fill_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
        <span class="n">asset_spec</span><span class="p">:</span> <span class="n">AssetSpec</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Quantity</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply margin requirements to fill quantity for derivatives.</span>

<span class="sd">        Args:</span>
<span class="sd">            order: Order being filled</span>
<span class="sd">            fill_quantity: Desired fill quantity</span>
<span class="sd">            fill_price: Fill price</span>
<span class="sd">            asset_spec: Asset specification</span>

<span class="sd">        Returns:</span>
<span class="sd">            Adjusted fill quantity, or None if insufficient margin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_account</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fill_quantity</span>

        <span class="c1"># Check margin for opening/increasing position</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
            <span class="n">has_margin</span><span class="p">,</span> <span class="n">required_margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_account</span><span class="o">.</span><span class="n">check_margin_requirement</span><span class="p">(</span>
                <span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">,</span>
                <span class="n">fill_quantity</span><span class="p">,</span>
                <span class="n">fill_price</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_margin</span><span class="p">:</span>
                <span class="c1"># Try partial fill within margin</span>
                <span class="n">max_quantity</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">margin_account</span><span class="o">.</span><span class="n">available_margin</span> <span class="o">/</span> <span class="n">required_margin</span> <span class="o">*</span> <span class="n">fill_quantity</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">max_quantity</span> <span class="o">&lt;</span> <span class="n">asset_spec</span><span class="o">.</span><span class="n">min_quantity</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">fill_quantity</span> <span class="o">=</span> <span class="n">max_quantity</span>
        <span class="k">elif</span> <span class="n">order</span><span class="o">.</span><span class="n">is_sell</span><span class="p">:</span>
            <span class="c1"># Short selling - check margin (only if not closing existing position)</span>
            <span class="c1"># The current_position parameter would need to be passed to check this</span>
            <span class="n">has_margin</span><span class="p">,</span> <span class="n">required_margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin_account</span><span class="o">.</span><span class="n">check_margin_requirement</span><span class="p">(</span>
                <span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">,</span>
                <span class="o">-</span><span class="n">fill_quantity</span><span class="p">,</span>
                <span class="n">fill_price</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_margin</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">fill_quantity</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_cash_constraints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
        <span class="n">fill_quantity</span><span class="p">:</span> <span class="n">Quantity</span><span class="p">,</span>
        <span class="n">fill_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
        <span class="n">current_cash</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">current_position</span><span class="p">:</span> <span class="n">Quantity</span><span class="p">,</span>
        <span class="n">asset_spec</span><span class="p">:</span> <span class="n">AssetSpec</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Quantity</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply cash constraints to fill quantity for cash-based trading.</span>

<span class="sd">        Args:</span>
<span class="sd">            order: Order being filled</span>
<span class="sd">            fill_quantity: Desired fill quantity</span>
<span class="sd">            fill_price: Fill price</span>
<span class="sd">            current_cash: Available cash</span>
<span class="sd">            current_position: Current position in asset</span>
<span class="sd">            asset_spec: Asset specification</span>

<span class="sd">        Returns:</span>
<span class="sd">            Adjusted fill quantity, or None if insufficient funds/shares</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
            <span class="c1"># Calculate maximum fill quantity considering cash and commission</span>
            <span class="c1"># We need to solve: quantity * price + commission(quantity) &lt;= cash</span>
            <span class="c1"># For most commission models: commission = quantity * price * fee_rate</span>
            <span class="c1"># So: quantity * price * (1 + fee_rate) &lt;= cash</span>
            <span class="c1"># Therefore: quantity &lt;= cash / (price * (1 + fee_rate))</span>

            <span class="c1"># Get effective commission rate</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission_model</span><span class="p">:</span>
                <span class="c1"># Estimate commission rate as a fraction of notional</span>
                <span class="n">test_quantity</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">test_commission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_commission</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">test_quantity</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="n">asset_spec</span><span class="p">)</span>
                <span class="n">commission_rate</span> <span class="o">=</span> <span class="n">test_commission</span> <span class="o">/</span> <span class="p">(</span><span class="n">test_quantity</span> <span class="o">*</span> <span class="n">fill_price</span><span class="p">)</span> <span class="k">if</span> <span class="n">fill_price</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use asset-specific fee or default</span>
                <span class="n">commission_rate</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">,</span> <span class="s2">&quot;taker_fee&quot;</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span> <span class="k">if</span> <span class="n">asset_spec</span> <span class="k">else</span> <span class="mf">0.001</span>

            <span class="c1"># Calculate max affordable quantity with leverage constraint</span>
            <span class="c1"># max_leverage=1.0 means no leverage (can only buy what you can afford with cash)</span>
            <span class="c1"># max_leverage=2.0 means 2x leverage (can buy 2x your cash balance)</span>
            <span class="n">max_affordable_quantity</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_cash</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fill_price</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">commission_rate</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">max_affordable_quantity</span> <span class="o">&lt;</span> <span class="n">fill_quantity</span><span class="p">:</span>
                <span class="n">fill_quantity</span> <span class="o">=</span> <span class="n">max_affordable_quantity</span>

                <span class="c1"># Ensure minimum fill size</span>
                <span class="k">if</span> <span class="n">fill_quantity</span> <span class="o">&lt;</span> <span class="n">MIN_FILL_SIZE</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="c1"># Double-check we can afford this (in case of non-linear commission)</span>
                <span class="n">actual_commission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_commission</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">fill_quantity</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="n">asset_spec</span><span class="p">)</span>
                <span class="n">required_cash</span> <span class="o">=</span> <span class="n">fill_quantity</span> <span class="o">*</span> <span class="n">fill_price</span> <span class="o">+</span> <span class="n">actual_commission</span>

                <span class="c1"># If still over budget due to non-linear commission, reduce further</span>
                <span class="c1"># Account for leverage when checking if we can afford the position</span>
                <span class="k">if</span> <span class="n">required_cash</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">current_cash</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span><span class="p">):</span>
                    <span class="c1"># Binary search for the right quantity (more accurate for complex commission models)</span>
                    <span class="n">low_qty</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">high_qty</span> <span class="o">=</span> <span class="n">fill_quantity</span>
                    <span class="n">max_budget</span> <span class="o">=</span> <span class="n">current_cash</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_leverage</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_COMMISSION_CALC_ITERATIONS</span><span class="p">):</span>
                        <span class="n">mid_qty</span> <span class="o">=</span> <span class="p">(</span><span class="n">low_qty</span> <span class="o">+</span> <span class="n">high_qty</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="n">mid_commission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_commission</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">mid_qty</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">,</span> <span class="n">asset_spec</span><span class="p">)</span>
                        <span class="n">mid_cost</span> <span class="o">=</span> <span class="n">mid_qty</span> <span class="o">*</span> <span class="n">fill_price</span> <span class="o">+</span> <span class="n">mid_commission</span>

                        <span class="k">if</span> <span class="n">mid_cost</span> <span class="o">&lt;=</span> <span class="n">max_budget</span><span class="p">:</span>
                            <span class="n">low_qty</span> <span class="o">=</span> <span class="n">mid_qty</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">high_qty</span> <span class="o">=</span> <span class="n">mid_qty</span>

                    <span class="n">fill_quantity</span> <span class="o">=</span> <span class="n">low_qty</span>
                    <span class="k">if</span> <span class="n">fill_quantity</span> <span class="o">&lt;</span> <span class="n">MIN_FILL_SIZE</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check if we have enough shares for sell orders (non-short)</span>
        <span class="c1"># Only allow short selling if explicitly enabled in asset spec</span>
        <span class="c1"># Note: This check is only for regular orders, not for triggered stops</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_sell</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">asset_spec</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">,</span> <span class="s2">&quot;short_enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="c1"># Allow sell orders that were originally stop/trailing stops</span>
            <span class="c1"># (they would have been converted to MARKET by now)</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;original_type&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;STOP&quot;</span><span class="p">,</span> <span class="s2">&quot;TRAILING_STOP&quot;</span><span class="p">]:</span>
                <span class="n">available_shares</span> <span class="o">=</span> <span class="n">current_position</span>
                <span class="k">if</span> <span class="n">available_shares</span> <span class="o">&lt;</span> <span class="n">fill_quantity</span><span class="p">:</span>
                    <span class="n">fill_quantity</span> <span class="o">=</span> <span class="n">available_shares</span>
                    <span class="k">if</span> <span class="n">fill_quantity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">fill_quantity</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_market_price_with_impact</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
        <span class="n">market_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Price</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get market price adjusted for market impact.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_impact_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">market_price</span>

        <span class="c1"># Get current cumulative impact for this asset</span>
        <span class="n">current_impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_impact_model</span><span class="o">.</span><span class="n">get_current_impact</span><span class="p">(</span>
            <span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Apply existing impact to market price</span>
        <span class="k">return</span> <span class="n">market_price</span> <span class="o">+</span> <span class="n">current_impact</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_fill_price</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span> <span class="n">market_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Price</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the actual fill price including slippage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage_model</span><span class="o">.</span><span class="n">calculate_fill_price</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">market_price</span><span class="p">)</span>

        <span class="c1"># Default simple slippage: 0.01% for market orders</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">market_price</span> <span class="o">*</span> <span class="mf">1.0001</span>
            <span class="k">return</span> <span class="n">market_price</span> <span class="o">*</span> <span class="mf">0.9999</span>

        <span class="c1"># Limit orders fill at limit price or better</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">LIMIT</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">limit_price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_buy</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">limit_price</span><span class="p">,</span> <span class="n">market_price</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">limit_price</span><span class="p">,</span> <span class="n">market_price</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">market_price</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_commission</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
        <span class="n">fill_quantity</span><span class="p">:</span> <span class="n">Quantity</span><span class="p">,</span>
        <span class="n">fill_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
        <span class="n">asset_spec</span><span class="p">:</span> <span class="n">AssetSpec</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate commission for the fill.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commission_model</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">fill_quantity</span><span class="p">,</span> <span class="n">fill_price</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">asset_spec</span><span class="p">:</span>
            <span class="c1"># Use asset-specific fee structure</span>
            <span class="n">notional</span> <span class="o">=</span> <span class="n">fill_quantity</span> <span class="o">*</span> <span class="n">fill_price</span> <span class="o">*</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">,</span> <span class="s2">&quot;contract_size&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderType</span><span class="o">.</span><span class="n">MARKET</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">notional</span> <span class="o">*</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">,</span> <span class="s2">&quot;taker_fee&quot;</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">notional</span> <span class="o">*</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">,</span> <span class="s2">&quot;maker_fee&quot;</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>

        <span class="c1"># Simple flat commission: $1 per trade for equities</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_slippage</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
        <span class="n">fill_quantity</span><span class="p">:</span> <span class="n">Quantity</span><span class="p">,</span>
        <span class="n">market_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
        <span class="n">fill_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
        <span class="n">asset_spec</span><span class="p">:</span> <span class="n">AssetSpec</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate slippage cost.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slippage_model</span><span class="o">.</span><span class="n">calculate_slippage_cost</span><span class="p">(</span>
                <span class="n">order</span><span class="p">,</span>
                <span class="n">fill_quantity</span><span class="p">,</span>
                <span class="n">market_price</span><span class="p">,</span>
                <span class="n">fill_price</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Default asset-specific slippage</span>
        <span class="k">if</span> <span class="n">asset_spec</span><span class="p">:</span>
            <span class="n">slippage_rate</span> <span class="o">=</span> <span class="mf">0.0001</span>  <span class="c1"># 1 bp default</span>
            <span class="c1"># Check if asset_class exists (full AssetSpec) or fallback to asset_type (simple AssetSpec)</span>
            <span class="n">asset_class_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">asset_spec</span><span class="o">.</span><span class="n">asset_class</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">,</span> <span class="s2">&quot;asset_class&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">,</span> <span class="s2">&quot;asset_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">asset_class_value</span> <span class="o">==</span> <span class="s2">&quot;crypto&quot;</span><span class="p">:</span>
                <span class="n">slippage_rate</span> <span class="o">=</span> <span class="mf">0.001</span>  <span class="c1"># 10 bp for crypto</span>
            <span class="k">elif</span> <span class="n">asset_class_value</span> <span class="o">==</span> <span class="s2">&quot;fx&quot;</span><span class="p">:</span>
                <span class="n">slippage_rate</span> <span class="o">=</span> <span class="mf">0.00005</span>  <span class="c1"># 0.5 bp for FX</span>
            <span class="k">elif</span> <span class="n">asset_class_value</span> <span class="o">==</span> <span class="s2">&quot;future&quot;</span><span class="p">:</span>
                <span class="n">slippage_rate</span> <span class="o">=</span> <span class="mf">0.0002</span>  <span class="c1"># 2 bp for futures</span>

            <span class="n">notional</span> <span class="o">=</span> <span class="n">fill_quantity</span> <span class="o">*</span> <span class="n">market_price</span> <span class="o">*</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">asset_spec</span><span class="p">,</span> <span class="s2">&quot;contract_size&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">notional</span> <span class="o">*</span> <span class="n">slippage_rate</span>

        <span class="c1"># Simple calculation: difference between market and fill price</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fill_price</span> <span class="o">-</span> <span class="n">market_price</span><span class="p">)</span> <span class="o">*</span> <span class="n">fill_quantity</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_market_impact</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
        <span class="n">fill_quantity</span><span class="p">:</span> <span class="n">Quantity</span><span class="p">,</span>
        <span class="n">market_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update market impact state after a fill.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_impact_model</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Calculate new impact from this trade</span>
        <span class="n">permanent_impact</span><span class="p">,</span> <span class="n">temporary_impact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_impact_model</span><span class="o">.</span><span class="n">calculate_impact</span><span class="p">(</span>
            <span class="n">order</span><span class="p">,</span>
            <span class="n">fill_quantity</span><span class="p">,</span>
            <span class="n">market_price</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update market state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">market_impact_model</span><span class="o">.</span><span class="n">update_market_state</span><span class="p">(</span>
            <span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">,</span>
            <span class="n">permanent_impact</span><span class="p">,</span>
            <span class="n">temporary_impact</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_liquidity_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">,</span>
        <span class="n">fill_quantity</span><span class="p">:</span> <span class="n">Quantity</span><span class="p">,</span>
        <span class="n">fill_price</span><span class="p">:</span> <span class="n">Price</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update liquidity model after a fill.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">liquidity_model</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">side</span> <span class="o">=</span> <span class="s2">&quot;buy&quot;</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">is_buy</span> <span class="k">else</span> <span class="s2">&quot;sell&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">liquidity_model</span><span class="o">.</span><span class="n">update_volume</span><span class="p">(</span>
            <span class="n">order</span><span class="o">.</span><span class="n">asset_id</span><span class="p">,</span>
            <span class="n">fill_price</span><span class="p">,</span>
            <span class="n">side</span><span class="p">,</span>
            <span class="n">fill_quantity</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="FillSimulator.reset">
<a class="viewcode-back" href="../../../modules/execution.html#qengine.execution.fill_simulator.FillSimulator.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset fill simulator state.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FillSimulator reset&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, ML4T.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>