# Handoff: 2025-11-23 13:49:55 UTC

## Active Work
Implementing `StopFillMode.NEXT_BAR_OPEN` to achieve EXACT MATCH with Zipline stop-loss/take-profit behavior.

## Current State

### Just Completed
- Added `NEXT_BAR_OPEN` to `StopFillMode` enum in `src/ml4t/backtest/types.py`

### In Progress
- Need to implement the fill logic in `src/ml4t/backtest/risk/position/static.py`
- Need to update Zipline validation scripts to use `StopFillMode.NEXT_BAR_OPEN`

### Earlier This Session (Completed)
1. **Consolidated venvs**: Reduced from 8 to 3
   - `.venv` - Main development
   - `.venv-validation` - VBT OSS + Backtrader + Zipline (all open-source together)
   - `.venv-vectorbt-pro` - VBT Pro only

2. **Created VectorBT OSS validation scripts**:
   - `scenario_03_stop_loss.py` - PASS (EXACT MATCH)
   - `scenario_04_take_profit.py` - PASS (EXACT MATCH)

3. **Created Zipline validation scripts** (currently pass with tolerance, need EXACT):
   - `scenario_03_stop_loss.py` - PASS (~$150 diff)
   - `scenario_04_take_profit.py` - PASS (~$200 diff)

4. **Updated documentation**:
   - `decisions.md` - AD-001 superseded, AD-004 refined
   - `PROJECT_MAP.md` - Venv section, validation status
   - `validation/README.md` - Test matrix, results

## Implementation Details

### StopFillMode.NEXT_BAR_OPEN Behavior
When stop is triggered:
1. Check if stop condition is met at current bar's close
2. Instead of filling at stop price, mark for fill at NEXT bar's open
3. This matches Zipline's `handle_data()` approach where:
   - Stop check happens at close
   - Exit order fills at next bar open

### Files to Modify

1. **`src/ml4t/backtest/risk/position/static.py`** (~lines 150-220)
   - `_get_stop_fill_price()` method needs `NEXT_BAR_OPEN` case
   - Need to handle deferred fill (may require engine coordination)

2. **`validation/zipline/scenario_03_stop_loss.py`**
   - Change: `stop_fill_mode=StopFillMode.NEXT_BAR_OPEN`

3. **`validation/zipline/scenario_04_take_profit.py`**
   - Change: `stop_fill_mode=StopFillMode.NEXT_BAR_OPEN`

### Key Insight
The challenge is that `NEXT_BAR_OPEN` requires knowing the NEXT bar's open price at the time the stop triggers. Options:
1. Defer the fill to next bar processing (complex, requires engine changes)
2. Use current bar's close as approximation (not exact)
3. Pass next bar's open to the rule evaluation (requires feed lookahead or post-processing)

**Recommended approach**: In the risk rule, when `NEXT_BAR_OPEN` mode is set and stop triggers, return a "pending exit" signal that the engine processes on the NEXT bar at open price.

## Test Commands

```bash
# Run Zipline stop-loss validation
.venv-validation/bin/python3 validation/zipline/scenario_03_stop_loss.py

# Run Zipline take-profit validation
.venv-validation/bin/python3 validation/zipline/scenario_04_take_profit.py

# Run all unit tests
source .venv/bin/activate && pytest tests/ -q --tb=no
```

## Virtual Environments (Consolidated)

```
.venv               # Main development (206 tests passing)
.venv-validation    # VBT OSS + Backtrader + Zipline (all work together)
.venv-vectorbt-pro  # VBT Pro only (commercial)
```

## Framework Validation Status

| Framework | Stop-Loss | Take-Profit |
|-----------|-----------|-------------|
| VectorBT Pro | EXACT MATCH | EXACT MATCH |
| VectorBT OSS | EXACT MATCH | EXACT MATCH |
| Backtrader | EXACT MATCH | EXACT MATCH |
| Zipline | ~$150 diff (need EXACT) | ~$200 diff (need EXACT) |

## Key User Requirement
**"ml4t.backtest must be configurable to replicate the behavior of other frameworks exactly"** - not accept "close enough" or "tolerance."

## Session Context
- Working in: `/home/stefan/ml4t/software/backtest`
- Branch: `feature/phase-1-ml-data-foundation`
- All 206 unit tests passing
