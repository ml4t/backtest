# Handoff: 2025-11-23 13:02:46 UTC

## Active Work
Implementing configurable stop/take-profit fill behavior to achieve EXACT MATCH with external backtesting frameworks (VectorBT Pro, Backtrader, and pending: VectorBT OSS, Zipline).

## Current State

### Completed (EXACT MATCH achieved)
- **VectorBT Pro** - stop-loss and take-profit: PASS (0.0000% diff)
- **Backtrader** - stop-loss and take-profit: PASS (0.0000% diff)
- All 206 unit tests passing

### Pending (user interrupted to request)
- **VectorBT OSS** - needs validation scripts created
- **Zipline** - needs validation scripts (note: may have bundle issues per PROJECT_MAP.md)

## Implementation Summary

### New Configuration Options Added

```python
from ml4t.backtest import Engine, StopFillMode, StopLevelBasis, ExecutionMode

# VectorBT Pro with OHLC (same-bar execution)
engine = Engine(
    feed, strategy,
    execution_mode=ExecutionMode.SAME_BAR,
    stop_fill_mode=StopFillMode.STOP_PRICE,      # Exact stop/target price
    stop_level_basis=StopLevelBasis.FILL_PRICE,  # Stop level from fill price
)

# Backtrader (next-bar execution)
engine = Engine(
    feed, strategy,
    execution_mode=ExecutionMode.NEXT_BAR,
    stop_fill_mode=StopFillMode.STOP_PRICE,       # Exact stop/target price
    stop_level_basis=StopLevelBasis.SIGNAL_PRICE, # Stop level from signal close
)
```

### StopFillMode Enum
- `STOP_PRICE` - Fill at exact stop/target price if within bar range (default)
- `CLOSE_PRICE` - Always fill at close price (VBT Pro close-only data)
- `BAR_EXTREME` - Fill at bar's low/high (conservative/optimistic)

### StopLevelBasis Enum
- `FILL_PRICE` - Calculate stop level from actual entry fill price (default)
- `SIGNAL_PRICE` - Calculate stop level from signal close at order time (Backtrader)

### Key Fill Behaviors Implemented
| Scenario | Behavior |
|----------|----------|
| Stop within bar [low, high] | Fill at exact stop price |
| Bar gaps through stop (open below) | Fill at open (Backtrader style) |
| Limit target within bar range | Fill at exact target price |
| Bar opens above limit target | Fill at open (price improvement) |

## Files Modified This Session

### Core Implementation
- `src/ml4t/backtest/types.py` - Added `StopFillMode`, `StopLevelBasis` enums
- `src/ml4t/backtest/__init__.py` - Exported new types
- `src/ml4t/backtest/engine.py` - Added `stop_level_basis` parameter
- `src/ml4t/backtest/broker.py` - Capture signal_price, pass to position context
- `src/ml4t/backtest/risk/position/static.py` - Gap handling, price improvement logic

### Validation Scripts (updated for exact match)
- `validation/vectorbt_pro/scenario_03_stop_loss.py`
- `validation/vectorbt_pro/scenario_04_take_profit.py`
- `validation/backtrader/scenario_03_stop_loss.py`
- `validation/backtrader/scenario_04_take_profit.py`

## Technical Discoveries

### VectorBT Pro OHLC Behavior
- If stop price is within bar's [low, high] range → fill at exact stop price
- If bar gaps through stop (stop outside range) → fill at close price

### Backtrader Limit Order Behavior
- Limit sell fills at OPEN price if bar opens above limit (price improvement)
- Stop orders fill at open if bar gaps through stop

### Signal Price vs Fill Price
In NEXT_BAR mode, there's a difference:
- Signal price = close at time order is placed (bar N)
- Fill price = open of next bar (bar N+1)
Backtrader calculates stop levels from signal price, not fill price.

## Next Steps

### Immediate (user requested)
1. Create VectorBT OSS validation scripts
   - Use `.venv-vectorbt` environment (NOT .venv-vectorbt-pro)
   - Check if OSS behavior matches Pro for OHLC data
   - May need different StopFillMode configuration

2. Create Zipline validation scripts (if feasible)
   - Use `.venv-zipline` environment
   - Note from PROJECT_MAP.md: Zipline has bundle/symbol resolution issues
   - May need to skip if bundle issues persist

### Configuration to Test for VBT OSS
```python
# VectorBT OSS - likely same as Pro
engine = Engine(
    feed, strategy,
    execution_mode=ExecutionMode.SAME_BAR,
    stop_fill_mode=StopFillMode.STOP_PRICE,
    stop_level_basis=StopLevelBasis.FILL_PRICE,
)
```

## Virtual Environments Reference

```
.venv               - Main development (Python 3.12)
.venv-vectorbt-pro  - VectorBT Pro only (COMPLETED)
.venv-vectorbt      - VectorBT OSS only (PENDING)
.venv-backtrader    - Backtrader only (COMPLETED)
.venv-zipline       - Zipline only (PENDING, may have issues)
```

## Session Context
- Working in: `/home/stefan/ml4t/software/backtest`
- Branch: `feature/phase-1-ml-data-foundation`
- Last command: User interrupted after Backtrader validation passed, requesting VBT OSS and Zipline
