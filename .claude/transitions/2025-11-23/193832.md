# Handoff: 2025-11-23 19:38:32 UTC

## Active Work
Performance optimization and futures support for ml4t.backtest, plus architectural planning for ml4t.live (live trading module).

## Current State

### Completed This Session
1. **Performance optimization**: Changed DataFeed from `iter_rows()` to `to_dicts()` (~15% faster, 34s → 28.8s)
2. **Removed unused array infrastructure**: Numba can't help with dict creation bottleneck
3. **Added futures support to ml4t.backtest**: `ContractSpec`, `AssetClass`, multiplier in Position P&L
4. **Moved ContractSpec to ml4t.data**: Canonical location with 34 common futures contracts
5. **Created ml4t.live vision document**: Comprehensive plan for live trading module

### Commits Made
- `08263c7` (backtest): "feat: Add futures support with ContractSpec, optimize DataFeed iteration"
- `cb5d833` (data): "feat: Add ContractSpec and FUTURES_REGISTRY for derivatives support"

### All Validations Pass
- VectorBT OSS: EXACT MATCH
- VectorBT Pro: EXACT MATCH
- Backtrader: EXACT MATCH
- Zipline: EXACT MATCH (within tolerance)

## Key Decisions

### Performance
- Dict-based interface is fundamental bottleneck (~30% of runtime)
- Further optimization requires breaking API changes (not worth it)
- 28.8s is acceptable - 6x faster than Zipline, event-driven (not vectorized like VBT)

### Futures Support
- `ContractSpec` with multiplier, tick_size, margin, exchange
- Position.unrealized_pnl() now uses multiplier
- 34 common futures in `FUTURES_REGISTRY` (ES, NQ, CL, GC, ZB, etc.)
- **Limitation noted**: Cash accounting treats futures like equity (deducts notional instead of margin) - future enhancement

### Architecture: ml4t.live
- Same Strategy interface works for backtest AND live
- Uses `ib_async` (successor to ib_insync - original maintainer passed away)
- Components: IBKRBroker, IBKRFeed, LiveEngine
- Dependency chain: `ml4t.live → ml4t.backtest → ml4t.data`
- Estimated 2-4 weeks for MVP

### Contract Specs Location
- Canonical source: `ml4t.data.assets.contracts`
- ml4t.backtest currently has its own copy (should eventually import from data)
- Helpers: `load_contract_specs()`, `get_contract_spec()`, `register_contract_spec()`

## Files Created/Modified

### ml4t.backtest (this repo)
- `src/ml4t/backtest/types.py`: Added ContractSpec, AssetClass (local copy)
- `src/ml4t/backtest/broker.py`: Added contract_specs, get_multiplier(), uses multiplier in P&L
- `src/ml4t/backtest/engine.py`: Passes contract_specs to Broker
- `src/ml4t/backtest/datafeed.py`: Simplified (removed array infra), uses to_dicts()

### ml4t.data (../data/)
- `src/ml4t/data/assets/contracts.py`: NEW - ContractSpec + FUTURES_REGISTRY (34 contracts)
- `src/ml4t/data/assets/__init__.py`: Exports contract types
- `src/ml4t/data/__init__.py`: Top-level exports for ContractSpec

### Planning Documents
- `../.claude/plans/ml4t_live_vision.md`: Comprehensive live trading module plan

## ml4t.backtest Differentiators (All Working)

| Feature | VectorBT | ml4t.backtest |
|---------|----------|---------------|
| Exit after N bars | Hard | `TimeExit(max_bars=5)` |
| Dynamic stop tightening | Impossible | `broker.update_order()` in loop |
| ML signal → position size | Manual | Native signals_df with confidence |
| Cash vs Margin accounts | N/A | Built-in policy-based |
| Futures multipliers | Manual | ContractSpec |
| Short selling constraints | N/A | Cash rejects, margin allows |

## Next Steps

### Immediate
1. Consider making ml4t.backtest depend on ml4t.data (share ContractSpec)
2. Document the differentiators with examples for users

### Future Work
1. **ml4t.live implementation** (see vision doc):
   - IBKRBroker wrapping ib_async
   - IBKRFeed for streaming data
   - LiveEngine event loop
2. **Proper futures cash accounting**: Margin posting instead of notional deduction
3. **IBKR/Databento contract lookup**: Dynamic specs from API

## Session Context
- Working in: `/home/stefan/ml4t/software/backtest`
- Branch: `feature/phase-1-ml-data-foundation`
- User context: Supporting ML4T book (culminates in live trading chapter)
- Roll handling for futures: Should be preprocessing step (continuous series before backtest)

## Usage Examples

### Futures in ml4t.backtest
```python
from ml4t.backtest import Engine, Strategy, ContractSpec, AssetClass

es_spec = ContractSpec(
    symbol='ES',
    asset_class=AssetClass.FUTURE,
    multiplier=50.0,
    tick_size=0.25,
)

engine = Engine(
    feed, strategy,
    account_type='margin',
    contract_specs={'ES': es_spec}
)
```

### From ml4t.data
```python
from ml4t.data import load_contract_specs, FUTURES_REGISTRY

# Load specific contracts
specs = load_contract_specs(['ES', 'NQ', 'CL'])

# Or all 34 contracts
all_specs = load_contract_specs(include_all=True)
```

## Open Questions for Next Session
1. Should ml4t.backtest add ml4t.data as a dependency?
2. Priority: Documentation vs ml4t.live implementation?
3. Contract spec maintenance strategy (static file + optional IBKR/Databento lookup)
