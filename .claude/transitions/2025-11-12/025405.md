# Handoff: 2025-11-12 02:54:05 UTC

**From**: Session - Real data migration + Test 2.1 phantom trade investigation
**To**: Next Session - Fix qengine phantom trade bug and continue Phase 2 validation
**Context**: 125K/200K tokens (62.5%)
**Project**: qengine backtesting library validation

---

## üéØ Active Work

**Work Unit 006**: Systematic Baseline Validation
- **Location**: `.claude/work/current/006_systematic_baseline_validation/`
- **Status**: Phase 1 complete, Phase 2 blocked by critical bug
- **Goal**: Implement 17-test validation roadmap (qengine vs VectorBT)
- **Progress**: 1/15 tasks complete (7%)

**Current Task**: TASK-002 (Test 2.1: Percentage Commission) - **BLOCKED**

## ‚úÖ Completed This Session

### 1. Real Data Migration (MAJOR ACCOMPLISHMENT)

**User Directive**: "Please do not use synthetic data; we have multiple actual data sources in ~/ml4t/projects, e.g. crypto_futures"

**Implementation**:
- Created `load_real_crypto_data()` function in `tests/validation/common/data_generator.py`
- Loads from `../projects/crypto_futures/data/spot/BTC_spot.parquet`
- 2.1M minute bars of BTC spot data (2021-2024)
- Supports date range filtering and n_bars limiting

**Updated Tests**:
- ‚úÖ Test 1.1: Baseline entries (now uses real data)
- ‚úÖ Test 1.2: Entry/exit pairs (now uses real data)
- ‚úÖ Test 1.3: Multiple round trips (now uses real data)

**All Phase 1 tests still pass with real data** - prices match exactly, confirming correct execution.

**Files Modified**:
- `tests/validation/common/data_generator.py` - Added `load_real_crypto_data()`
- `tests/validation/common/__init__.py` - Exported new function
- `tests/validation/test_1_1_baseline_entries.py` - Now uses real data
- `tests/validation/test_1_2_entry_exit_pairs.py` - Now uses real data
- `tests/validation/test_1_3_multiple_round_trips.py` - Now uses real data
- `.claude/memory/validation_data_sources.md` - Complete documentation

**Committed**: Commit `76ca9a2` - "feat: Migrate validation tests from synthetic to real BTC data"

### 2. Test 2.1 Implementation and Critical Bug Discovery

**Test Created**: `tests/validation/test_2_1_percentage_commission.py`
- Tests 0.1% commission (fees=0.001)
- 20 entry/exit pairs with 10-bar hold
- Real BTC spot data (1000 bars)

**üî¥ CRITICAL BUG DISCOVERED**: Phantom trades when commission enabled!

**Evidence**:
- **WITHOUT fees** (0.0%): Both engines produce 3 trades, perfect match ‚úÖ
- **WITH fees** (0.1%): qengine produces 4 trades, VectorBT produces 3 trades ‚ùå

**Diagnostic Test Results** (`test_diagnostic_signal_timing.py`):
```
Expected: 3 trades at bars (10-20, 60-70, 110-120)

NO FEES:
  qengine: 3 trades, final $100,459.10 ‚úÖ
  VectorBT: 3 trades, final $100,459.10 ‚úÖ

WITH FEES (0.1%):
  qengine: 4 trades, final $99,581.13 ‚ùå (phantom trade!)
  VectorBT: 3 trades, final $99,858.15 ‚úÖ

Phantom Trades:
  Trade 2: qengine enters at bar 21 ($28,835.08) instead of bar 60 ($29,044.99)
  Trade 4: qengine phantom trade at bar 121 ($29,507.11) - should not exist!
```

**Pattern**: qengine enters immediately after exits (bars 20‚Üí21, 120‚Üí121) **even when there's no entry signal**.

**Verified**: Signal Series is correct - bars 21 and 121 have `entry=False` ‚úÖ

### 3. Investigation Progress

**Confirmed Facts**:
1. ‚úÖ Signals are correct (verified with `test_debug_signals.py`)
2. ‚úÖ Phase 1 tests validated - prices match perfectly
3. ‚úÖ Bug only occurs when fees > 0
4. ‚úÖ QEngineWrapper entry logic checks: `if entry_signal and current_qty == 0:`
5. ‚úÖ Phantom trades occur at bar AFTER exits (N+1 where exit is at bar N)

**Root Cause Hypothesis**:
The bug is in qengine's signal processing when `execution_delay=False` and fees are enabled. Possible causes:
1. Event bus synchronous processing causing state corruption
2. Cash calculation after commission triggering unexpected code path
3. Position tracking desync between Strategy._positions and actual fills
4. Bar index increment timing issue

**Investigation Status**: Deep in debugging, about to identify exact bug location.

### 4. Bug Fixes Applied

**Fixed Polars schema error** in `engine_wrappers.py:272-282`:
- Changed from Polars concat to pandas concat to avoid type incompatibility
- Issue occurred when concatenating open position trades with completed trades
- Now uses pandas consistently to avoid schema errors

## üìä Current State

### Test Status
- ‚úÖ **Phase 1 (Baseline)**: 3/3 tests passing with real data
  - Test 1.1: Entries only ($111,140.65 match)
  - Test 1.2: Entry/exit pairs ($132,825.62 match)
  - Test 1.3: Multiple round trips ($100,240.84 match, 40 trades)

- üî¥ **Phase 2 (Fees)**: 0/3 tests - BLOCKED by phantom trade bug
  - Test 2.1: BLOCKED - commission test reveals phantom trades
  - Test 2.2: Not started (combined fees)
  - Test 2.3: Not started (asset-specific fees)

- ‚è∏Ô∏è **Phases 3-6**: 12 tests pending

### Work Unit Status
- **Active**: 006_systematic_baseline_validation
- **Phase**: Phase 2 blocked
- **Next Task**: Fix phantom trade bug, then complete TASK-002

### Files Modified (Uncommitted)
```
M tests/validation/common/engine_wrappers.py  # Polars schema fix
A tests/validation/test_2_1_percentage_commission.py  # Test implementation
A tests/validation/test_diagnostic_signal_timing.py  # Diagnostic test
A tests/validation/test_debug_signals.py  # Signal verification
A .claude/memory/test_2_1_findings.md  # Complete bug documentation
```

## üîë Recent Decisions

### Decision 1: Use Real Data for All Validation Tests
**Context**: User explicitly requested no synthetic data.

**Decision**: Implement `load_real_crypto_data()` and migrate all tests to use real BTC spot data from `projects/crypto_futures/`.

**Rationale**:
- Real market behavior (volatility, gaps, extremes)
- Reproducible with fixed historical data
- More trustworthy validation results

**Impact**: All validation tests now use 2.1M bars of real BTC data.

**Location**: `.claude/memory/validation_data_sources.md`

### Decision 2: Block Phase 2 Until Phantom Trade Bug Fixed
**Context**: Test 2.1 revealed qengine generates phantom trades when fees enabled.

**Decision**: Pause TASK-002 and all Phase 2 tests until bug is fixed.

**Rationale**:
- Cannot validate commission if trades don't match
- Bug affects ALL fee-related tests
- Phase 1 baseline validity confirmed

**Impact**: Must fix qengine signal processing before continuing validation roadmap.

### Decision 3: Use Diagnostic Test to Isolate Bug
**Context**: Test 2.1 showed $1,389 discrepancy, unclear root cause.

**Decision**: Create minimal diagnostic test with explicit 3-trade signal set to isolate the issue.

**Rationale**:
- Simpler scenario (3 trades vs 20) easier to debug
- Explicit signals remove ambiguity
- Can compare NO FEES vs WITH FEES directly

**Result**: Successfully isolated phantom trade pattern (bars N‚ÜíN+1 after exits).

## üöß Active Challenges

### Challenge 1: Phantom Trade Bug (CRITICAL üî¥)

**Issue**: qengine generates phantom entry trades immediately after exits when commission enabled.

**Symptoms**:
- NO fees: 3 trades, perfect match ‚úÖ
- WITH fees (0.1%): 4 trades (phantom at bars 21, 121) ‚ùå
- Entry signal at phantom bars is FALSE ‚úÖ (verified)
- Only occurs with fees > 0

**Investigation Status**:
- ‚úÖ Verified signals are correct
- ‚úÖ Confirmed wrapper entry logic looks correct
- ‚úÖ Isolated to fee-related execution path
- ‚è≥ Need to trace event bus execution flow with fees enabled
- ‚è≥ Suspect `execution_delay=False` + commission interaction

**Next Investigation Steps**:
1. Add detailed logging to SignalStrategy.on_market_event
2. Trace event bus synchronous processing when fees enabled
3. Check if FillEvent updates _positions before entry check completes
4. Verify broker.cash calculation after commission deduction
5. Check if bar_idx increment timing causes signal re-read

**Potential Fixes**:
- Add flag to prevent re-entry on same bar as exit
- Ensure _positions update completes before next signal check
- Verify event processing order with execution_delay=False
- Check if commission affects position size calculation triggering re-entry

### Challenge 2: Incomplete Test Implementation

**Issue**: Test 2.1 created but cannot assert success due to phantom trades.

**Current State**: Test uses `pytest.skip()` to document discrepancy without failing.

**Resolution Needed**: After fixing phantom trade bug:
1. Remove pytest.skip() workaround
2. Update acceptance criteria validation
3. Re-run test to verify match
4. Mark TASK-002 complete

## üìù Next Steps (Priority Order)

### CRITICAL: Fix Phantom Trade Bug

**Immediate** (Next 2-4 hours):
1. Add detailed logging to QEngineWrapper.SignalStrategy:
   ```python
   def on_market_event(self, event):
       entry_signal = self.entries.iloc[self.bar_idx]
       exit_signal = self.exits.iloc[self.bar_idx]
       current_qty = self._positions.get(event.asset_id, 0.0)

       print(f"Bar {self.bar_idx}: entry={entry_signal}, exit={exit_signal}, qty={current_qty}")

       # Rest of logic...
   ```

2. Run diagnostic test with logging to see exact execution flow

3. Identify where phantom entry_signal=True comes from

4. Implement fix (likely one of):
   - Add "just_exited" flag to prevent same-bar re-entry
   - Fix event processing order
   - Correct position state update timing
   - Fix bar_idx increment location

5. Verify fix:
   - Diagnostic test: 3 trades with fees ‚úÖ
   - Test 2.1: Final values within $5 ‚úÖ
   - All 20 trades at correct bars ‚úÖ

**After Fix** (Next 2-3 hours):
1. Complete TASK-002 (Test 2.1)
2. Update state.json to mark TASK-002 complete
3. Commit fix + Test 2.1 with appropriate message
4. Continue with TASK-003 (Test 2.2: Combined fees)

### If Bug Proves Complex (Fallback Plan)

If phantom trade bug requires deep qengine refactoring:

**Option A - Pause validation, fix qengine**:
1. Create issue in qengine repo documenting bug
2. Fix qengine core signal processing
3. Return to validation after fix

**Option B - Document and continue**:
1. Document discrepancy as "known difference"
2. Continue validation with caveat
3. Create separate work unit for qengine fix

**User Decision Required**: Which approach if bug is deep in qengine?

## üí° Session-Specific Context

### Test Infrastructure (Robust)

**Location**: `tests/validation/common/`

**Components**:
- `data_generator.py`: Real data loading + synthetic fallback
- `signal_generator.py`: Fixed and random signal patterns
- `engine_wrappers.py`: Standardized interfaces for qengine, VectorBT
- `comparison.py`: Validation reporting and assertions

**Quality**: Production-ready, no changes needed.

### Diagnostic Tests Created This Session

**test_diagnostic_signal_timing.py**:
- Minimal 3-trade scenario
- Tests both NO FEES and WITH FEES
- Explicit signals at bars 10, 60, 110 (entries) and 20, 70, 120 (exits)
- **Successfully isolated phantom trade pattern**

**test_debug_signals.py**:
- Verifies signal Series values at problem bars
- Confirms bars 21, 71, 121 have entry=False ‚úÖ

**Usage**: These tests are investigation tools, not part of the 17-test roadmap.

### Key File Locations

**Validation Tests**:
- `tests/validation/test_1_1_baseline_entries.py` ‚úÖ Passing
- `tests/validation/test_1_2_entry_exit_pairs.py` ‚úÖ Passing
- `tests/validation/test_1_3_multiple_round_trips.py` ‚úÖ Passing
- `tests/validation/test_2_1_percentage_commission.py` üî¥ Blocked

**Infrastructure**:
- `tests/validation/common/data_generator.py` - Real data loader
- `tests/validation/common/engine_wrappers.py` - QEngineWrapper (lines 90-290)

**Documentation**:
- `.claude/memory/validation_data_sources.md` - Real data usage guide
- `.claude/memory/test_2_1_findings.md` - Complete bug analysis
- `tests/validation/VALIDATION_ROADMAP.md` - 17-test specification

**State Management**:
- `.claude/work/current/006_systematic_baseline_validation/state.json` - Task tracking

### Real Data Details

**Source**: `/home/stefan/ml4t/software/projects/crypto_futures/data/spot/BTC_spot.parquet`

**Stats**:
- 2,102,401 minute bars
- Date range: 2021-01-01 to 2024-12-31 (4 years)
- Columns: timestamp, open, high, low, close, volume, symbol, source
- Source: CryptoCompare

**Loading**:
```python
from common import load_real_crypto_data

ohlcv = load_real_crypto_data(
    symbol="BTC",
    data_type="spot",
    n_bars=1000,  # Optional limit
    start_date="2021-01-01",  # Optional
    end_date="2021-01-31",  # Optional
)
```

### Git Status

**Last Commit**: `76ca9a2` - Real data migration

**Uncommitted**:
- M `tests/validation/common/engine_wrappers.py` (Polars fix)
- A `tests/validation/test_2_1_percentage_commission.py`
- A `tests/validation/test_diagnostic_signal_timing.py`
- A `tests/validation/test_debug_signals.py`
- A `.claude/memory/test_2_1_findings.md`

**To Commit After Bug Fix**:
```
fix: Resolve phantom trade bug in qengine signal processing

Root cause: [TO BE DETERMINED - currently investigating]

Changes:
- Fixed signal processing when execution_delay=False and fees > 0
- Added safeguards to prevent same-bar re-entry after exits
- Test 2.1 now passes with 0.1% commission

Validation Results:
- Diagnostic test: 3 trades with fees (was 4, phantom eliminated)
- Test 2.1: 20 trades, final values within $5 (was $1,389 diff)
- All trades execute at correct signal bars

Tests passing: 4/17 (1.1, 1.2, 1.3, 2.1)
```

## üéì Learnings (For Permanent Memory)

### Real vs Synthetic Data

**Discovery**: User explicitly required real data for validation.

**Implementation**: Created `load_real_crypto_data()` with access to 2.1M bars of BTC spot data.

**Benefits**:
- Real volatility, gaps, and market behavior
- Reproducible with fixed historical data
- More trustworthy validation results

**Application**: Always use real data for validation tests, synthetic only for unit tests.

### Systematic Validation Approach

**Discovery**: Systematic testing successfully identified a subtle bug that baseline tests missed.

**Pattern**: Phase-by-phase validation (baseline ‚Üí fees ‚Üí slippage ‚Üí order types) progressively tests complexity.

**Success**: Test 2.1 revealed phantom trade bug that would have corrupted all fee/slippage validation.

**Application**: Trust the systematic approach - bugs revealed are validation working correctly.

### Diagnostic Test Strategy

**Discovery**: When validation fails, create minimal diagnostic test to isolate root cause.

**Pattern**:
1. Validation test finds discrepancy (Test 2.1: $1,389 diff)
2. Create minimal scenario (3 trades vs 20 trades)
3. Test with/without the variable (fees=0.0 vs fees=0.001)
4. Observe pattern (phantom trades only with fees)

**Success**: Diagnostic test isolated bug to specific bars (N‚ÜíN+1 after exits).

### Event-Driven Architecture Debugging

**Discovery**: With `execution_delay=False`, order fills happen synchronously during `on_market_event`.

**Complexity**: Event bus processing order affects state visibility:
- Order published
- Fill executed
- Position updated
- **All during same on_market_event call**

**Application**: When debugging event-driven systems, trace exact synchronous execution flow with detailed logging.

## üîó References

**Previous Handoff**: `.claude/transitions/2025-11-11/225220.md`
- TradeTracker fixes (open position reporting)
- Work Unit 006 creation
- Systematic validation roadmap

**Current Work Unit**: `.claude/work/current/006_systematic_baseline_validation/`
- `state.json` - Task tracking (TASK-001 complete, TASK-002 blocked)
- `requirements.md` - 17-test specifications
- `exploration.md` - Implementation approach

**Key Documentation**:
- `.claude/memory/validation_data_sources.md` - Real data usage
- `.claude/memory/test_2_1_findings.md` - Phantom trade bug analysis
- `tests/validation/VALIDATION_ROADMAP.md` - Test specifications

**Relevant Code**:
- `tests/validation/common/engine_wrappers.py:90-290` - QEngineWrapper.SignalStrategy
- `src/qengine/execution/broker.py` - SimulationBroker
- `src/qengine/core/engine.py` - BacktestEngine event loop

## ‚ö†Ô∏è Important Notes

### Critical Finding: Phantom Trade Bug

This bug is BLOCKING all Phase 2+ validation tests. It's not a validation failure - it's a real qengine bug that validation successfully discovered.

**Do not proceed with TASK-003+ until this is fixed.**

### Test Environment

**Python**: 3.13.5
**Virtual env**: `.venv`
**Test command**: `.venv/bin/python -m pytest tests/validation/test_*.py -v`
**Direct execution**: `.venv/bin/python tests/validation/test_*.py`

### Context Usage

**Current**: 125K/200K tokens (62.5%)
**Safe**: Continue investigation
**Threshold**: Create another handoff if approaching 80% (160K)

---

## üöÄ To Continue This Session

**Focus**: Fix phantom trade bug, complete Test 2.1, continue Phase 2 validation

**First Steps**:
1. Add detailed logging to QEngineWrapper.SignalStrategy.on_market_event
2. Run diagnostic test with logging enabled
3. Identify exact source of phantom entry signals
4. Implement fix and verify with diagnostic test
5. Re-run Test 2.1 to confirm resolution
6. Mark TASK-002 complete and commit changes

**Key Question**: Why does qengine enter at bars 21, 71, 121 when `entry_signal=False`?

**Debugging Strategy**: Trace synchronous event execution flow with fees enabled.

---

**Session Complete**: Real data migration successful ‚úÖ, Phase 2 blocked by phantom trade bug üî¥

**Priority**: Fix bug before continuing validation roadmap
