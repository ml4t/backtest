# Handoff: 2025-11-12 15:58:08 UTC

## Critical Decision Point: Validation vs. Redesign

**Context**: We successfully completed TASK-008 (limit order validation) for ml4t.backtest standalone, but when we integrated VectorBT comparison, we hit the **exact architectural flaw** identified in work unit 007's code review.

### The Problem Discovered

**Dual State Management (CRITICAL FLAW #2 from 007/code_review.md)**:
- `SimulationBroker` creates its own `PositionTracker`
- `BacktestEngine` creates `SimplePortfolio`
- Both track cash and positions **independently**
- Broker thinks we have positions, Portfolio shows 0 shares
- Exit orders fail: `"Cannot remove 3.43211489 shares, only have 0.0"`

**Test Evidence**:
```
ml4t.backtest: 14 trades, $101,724.47, final position: -13.66 shares (NEGATIVE!)
VectorBT: 4 trades, $100,667.43, final position: 0.00 shares
Errors: "Cannot remove X shares, only have 0.0" (4 occurrences)
```

### Why This Matters

**Original Plan**: "Validate everything first, then redesign"
**Reality**: We're **validating a brittle foundation** with known architectural flaws.

Work unit 007 identifies this as:
> "This is a race condition waiting to happen... This is the #1 cause of impossible-to-debug backtest errors."

**Every validation test we write**:
1. Works around the dual-state bug
2. Masks bugs that will reappear after redesign
3. May need to be rewritten post-redesign

### Work Unit 007: The Redesign

**Location**: `.claude/work/current/007_redesign/`

**Documents**:
- `code_review.md` - Identifies 3 critical flaws (dual state is #2)
- `synthesis.md` - PRD synthesis from 4 proposals (SOTA, OPUS, GEM, Multi-Asset)
- `gemini-dt.md`, `opus.md`, `sota.md` - Original design proposals

**Phase 2 Solution (from code_review.md)**:
1. **Delete `execution.PositionTracker`**
2. **Consolidate to single `Portfolio`** as source of truth
3. **Broker reads state, publishes fills** (doesn't track state itself)
4. **Portfolio subscribes to FillEvents** and updates itself

This would **immediately fix**:
- Position tracking errors
- The -13.66 share mismatch
- Future validation issues with all order types

### Recommendation

**Stop validation work. Execute redesign (work unit 007).**

**Rationale**:
- We're hitting the exact bug the redesign fixes
- Building more tests on this foundation = building on sand
- Phase 1-2 of redesign estimated at 3-5 days
- After redesign, validation tests will be simpler and more reliable

**User's insight**: "If we are now running into challenges precisely because of this issue, then I'm not sure that the original assertion that it would be much easier to first validate everything and then redesign is indeed superior."

**He's correct.** The assumption was wrong. We need a solid foundation before comprehensive validation.

---

## Session Summary

### What Was Accomplished (Before Hitting The Wall)

1. **✅ TASK-008 Completed (ml4t.backtest standalone)**
   - Added `limit_offset` to BacktestConfig
   - Updated ml4t.backtestWrapper for limit orders (entry/exit)
   - Test passed: 14/20 trades (70% fill rate), $1,724 profit
   - Commit: `dc1a017`

2. **✅ VectorBT Limit Order Research**
   - Consulted VectorBT LLM chatbot
   - Learned: `order_type='limit'` and `limit_delta` supported
   - Updated VectorBTWrapper implementation

3. **❌ VectorBT Integration Failed**
   - ml4t.backtest: 14 trades
   - VectorBT: 4 trades
   - Position tracking errors exposed dual-state bug

### Files Modified This Session

**Successful Changes (committed)**:
- `tests/validation/common/engine_wrappers.py:17-18` - Added `limit_offset` to BacktestConfig
- `tests/validation/common/engine_wrappers.py:141-229` - Limit order logic in ml4t.backtestWrapper
- `tests/validation/test_4_1_limit_orders.py` - Complete test (203 lines)
- `.claude/work/current/006_systematic_baseline_validation/state.json` - Updated progress

**Uncommitted Changes (reverted or debugging)**:
- `tests/validation/common/engine_wrappers.py:449-473` - VectorBT limit support (causes divergence)
- `tests/validation/test_4_1_limit_orders.py:121-192` - VectorBT comparison (fails due to position bug)

### Investigation Artifacts

**Created**:
- `/tmp/vectorbt_limit_order_prompt.md` - Query for VectorBT chatbot
- `/tmp/limit_order_findings.md` - Analysis of divergence and position errors

**Findings**:
- VectorBT fills fewer orders (4 vs 14) - unclear why
- Position tracking bug prevents meaningful comparison
- Need to understand VectorBT's limit TIF/expiry behavior

---

## Current State

### Work Units

**Active**: `006_systematic_baseline_validation`
- Status: `planning_complete`
- Progress: 12/19 tasks (63.2%)
- Last completed: TASK-008
- Next: TASK-009 (Stop Orders)

**Needs Attention**: `007_redesign`
- Status: Planning complete (synthesis done)
- Action required: Decision to pivot from validation to redesign

### Test Suite Status

**Passing (7 tests)**:
```bash
test_1_3_multiple_round_trips.py      # Baseline
test_2_1_percentage_commission.py     # 0.1% fees
test_2_2_combined_fees.py             # 0.1% + $2
test_2_3_asset_specific_fees.py       # Multi-asset fees
test_3_1_fixed_slippage.py            # $10 slippage
test_3_2_percentage_slippage.py       # 0.05% slippage
test_3_3_combined_costs.py            # 0.1% + 0.05%
```

**Failing (1 test)**:
```bash
test_4_1_limit_orders.py              # Dual-state bug
```

**Coverage**: 39% overall

### Git Status

**Last commit**: `dc1a017` - "feat: Complete TASK-008 - Limit order validation (14/20 trades, 70% fill rate)"

**Uncommitted**:
- M tests/validation/common/engine_wrappers.py (VectorBT limit support)
- M tests/validation/test_4_1_limit_orders.py (VectorBT comparison)

**Action**: Revert uncommitted changes if pivoting to redesign

---

## Recent Decisions

### 1. VectorBT Limit Order API Confirmed
**What**: VectorBT Pro supports limit orders via `order_type='limit'` and `limit_delta`
**Source**: VectorBT LLM chatbot consultation
**Impact**: API integration successful, but execution semantics differ

### 2. Limit Order Offset Tuning
**What**: Changed from 2% to 0.3% for realistic fills on minute data
**Rationale**: 2% → 0 fills, 0.3% → 70% fill rate
**Learning**: Offset must match data frequency and volatility

### 3. Dual-State Bug Cannot Be Worked Around
**What**: Attempted to validate with VectorBT comparison, hit position tracking errors
**Realization**: This isn't a test bug, it's an architectural flaw
**Implication**: Continuing validation = accumulating technical debt

---

## Active Challenges

### 1. Architectural Decision Required

**Question**: Continue validation (work unit 006) or pivot to redesign (work unit 007)?

**Arguments for Redesign**:
- ✅ Fixes root cause of current failures
- ✅ All future tests built on solid foundation
- ✅ No re-work of validation tests
- ✅ 3-5 day estimate for Phase 1-2

**Arguments for Continuing Validation**:
- ❌ Every test must work around dual-state bug
- ❌ Tests may break after redesign
- ❌ More bugs will emerge (already seeing them)

**User's position**: Questioning original "validate first" approach given we're hitting the exact architectural flaw.

### 2. Position Tracking Error Deep Dive

**Symptom**: `"Cannot remove 3.43211489 shares, only have 0.0"`

**Root Cause** (from 007/code_review.md):
```
SimulationBroker.position_tracker    → thinks we have 3.43 shares
SimplePortfolio.positions            → thinks we have 0 shares
Exit order uses portfolio.get_position() → sees 0
Broker tries to fill exit → needs 3.43 from position_tracker
Portfolio.update_position() → "can't remove 3.43, only have 0"
```

**Why it happens**:
- Broker updates `position_tracker` on fills
- Portfolio updates `positions` on FillEvents
- Two separate state machines can diverge
- With limit orders (async fills), divergence more likely

**Fix** (redesign Phase 2):
- Single `Portfolio` instance shared by Broker and Strategy
- Broker reads state, publishes FillEvents
- Portfolio subscribes to FillEvents, updates state
- One source of truth

### 3. VectorBT Fill Behavior Mystery

**Observation**: VectorBT filled 4/20 orders, ml4t.backtest filled 14/20

**Hypotheses**:
- Different limit expiry logic (VectorBT may cancel on signal bar)
- Different intrabar execution (ml4t.backtest checks all future bars)
- May need `limit_tif` parameter

**Investigation needed**: Check VectorBT docs on limit order time-in-force

---

## Next Steps (Priority Order)

### If Pivoting to Redesign (RECOMMENDED)

1. **Switch Active Work Unit**
   ```bash
   echo "007_redesign" > .claude/work/ACTIVE_WORK
   ```

2. **Create Implementation Plan for Phase 1-2**
   - Phase 1: Fix the "Heart" (Clock-driven loop, deprecate EventBus)
   - Phase 2: Fix the "Brain" (Single Portfolio, delete PositionTracker)

3. **Execute Phase 2 First** (Position Tracking)
   - More urgent (actively breaking tests)
   - Smaller scope (easier to validate)
   - Unblocks limit order testing

4. **Resume Validation After Redesign**
   - Re-run all 7 passing tests
   - Complete TASK-008 with VectorBT comparison
   - Continue with TASK-009 (Stop Orders)

### If Continuing Validation (NOT RECOMMENDED)

1. **Revert VectorBT Changes**
   ```bash
   git checkout tests/validation/common/engine_wrappers.py
   git checkout tests/validation/test_4_1_limit_orders.py
   ```

2. **Keep TASK-008 as ml4t.backtest-only**
   - Document VectorBT comparison as "post-redesign"
   - Accept standalone validation for now

3. **Debug Position Tracking** (before TASK-009)
   - Add extensive logging to understand divergence
   - May need temporary workarounds (fragile)

4. **Continue with TASK-009** (Stop Orders)
   - Will likely hit same position tracking issue
   - Each test adds more workarounds

---

## Important Context for Next Session

### VectorBT Limit Order Integration

**What works**:
```python
# In VectorBTWrapper
order_type = 'limit' if config.order_type == 'limit' else 'market'
limit_delta = config.limit_offset if config.order_type == 'limit' else None

pf = vbt.Portfolio.from_signals(
    ...,
    order_type=order_type,
    limit_delta=limit_delta,
    price='close',  # Reference price for limit_delta
)
```

**What's unclear**:
- Why VectorBT fills fewer orders (4 vs 14)
- Whether `limit_tif` (time-in-force) needed
- Expiry behavior (does limit cancel on signal bar or persist?)

### Redesign Prerequisites

**Read first**:
- `.claude/work/current/007_redesign/code_review.md` - The analysis
- `.claude/work/current/007_redesign/synthesis.md` - The vision

**Key sections**:
- code_review.md lines 66-78: CRITICAL FLAW #2 (Dual State)
- code_review.md lines 166-191: Phase 2 implementation plan
- synthesis.md lines 96-107: Architectural principles

**Architecture to implement**:
```python
# Single source of truth
self.portfolio = Portfolio(initial_capital=...)

# Inject into broker and strategy
self.broker.portfolio = self.portfolio
self.strategy.portfolio = self.portfolio

# Broker publishes fills
def on_market_event(self, event):
    fill_event = self.fill_simulator.try_fill_order(...)
    if fill_event:
        self.clock.publish(fill_event)  # Don't update state directly

# Portfolio subscribes and updates
class Portfolio:
    def on_fill_event(self, event: FillEvent):
        # Update positions, cash, P&L
        # This is the ONLY place state changes
```

### Files to Review

**Before redesign decision**:
- `.claude/work/current/007_redesign/code_review.md` (complete read)
- `.claude/work/current/006_systematic_baseline_validation/state.json` (progress tracker)

**For debugging (if continuing validation)**:
- `src/ml4t.backtest/execution/broker.py:570-627` - Fill processing
- `src/ml4t.backtest/portfolio/portfolio.py:71` - Error location
- `tests/validation/common/engine_wrappers.py:127-163` - Position queries

**For implementation (if redesigning)**:
- `src/ml4t.backtest/execution/position_tracker.py` - To be deleted
- `src/ml4t.backtest/portfolio/portfolio.py` - To be consolidated
- `src/ml4t.backtest/portfolio/simple.py` - To be merged

---

## Session Statistics

**Duration**: ~4 hours
**Files read**: 15+
**Files modified**: 4
**Tests written**: 1 (test_4_1_limit_orders.py)
**Tests passing**: 7/8 (87.5% before VectorBT integration)
**Token usage**: 120K/200K (60%)
**Commits**: 1 (`dc1a017`)

**Key milestone**: Successfully implemented limit orders in ml4t.backtest, then discovered the architectural limit preventing VectorBT comparison.

---

## Continuation Instructions

**Recommended**: `/quant:next` is NOT appropriate here - this is architectural decision time.

**Instead**:
1. Review `.claude/work/current/007_redesign/code_review.md`
2. Decide: Continue validation or pivot to redesign?
3. If redesign: Switch to work unit 007 and start Phase 2
4. If validation: Revert VectorBT changes and continue TASK-009

**Quick Decision Prompt**:
```
I've read the handoff. I agree we should pivot to the redesign.
Let's switch to work unit 007 and start with Phase 2 (position tracking fix).
```

Or:
```
I've read the handoff. Let's document the dual-state issue and continue validation.
We'll tackle redesign after completing the 19-test roadmap.
```

---

**Handoff Complete**: 2025-11-12 15:58:08 UTC
