# Handoff: 2025-11-12 10:05:29 UTC

**From**: Session - Fixed phantom trade bug, completed Test 2.1, started Test 2.2
**To**: Next Session - Resolve TASK-003 (combined fees) blocking issue
**Context**: 128K/200K tokens (64%)
**Project**: qengine backtesting library validation

---

## üéØ Active Work

**Work Unit 006**: Systematic Baseline Validation
- **Location**: `.claude/work/current/006_systematic_baseline_validation/`
- **Status**: Phase 2 in progress (Transaction Fees)
- **Goal**: Implement 17-test validation roadmap (qengine vs VectorBT)
- **Progress**: 2/15 tasks complete (13%)

**Current Task**: TASK-003 (Test 2.2: Combined Fees) - **BLOCKED**

## ‚úÖ Completed This Session

### 1. Fixed Critical Phantom Trade Bug (MAJOR)

**Issue**: When percentage commission was enabled, qengine generated phantom trades (extra trades not in signal series).

**Root Cause**: Strategy calculated entry size as `cash / price` WITHOUT accounting for commission. Broker's fill simulator reduced quantity to fit cash budget AFTER commission, creating position tracking mismatch.

**Solution**: Updated entry size calculation to account for commission:
```python
# Before:
size = cash / price

# After:
commission_rate = config.fees if config.fees > 0 else 0.0
size = cash / (price * (1 + commission_rate))
```

**Results**:
- ‚úÖ Test 2.1 (0.1% commission) now PASSES perfectly
- ‚úÖ Final values match VectorBT exactly: $97,299.63
- ‚úÖ All 20 trades execute at correct bars
- ‚úÖ No phantom trades

**Committed**: Commit `5286d3c` - "fix: Account for commission when calculating entry size to prevent phantom trades"

### 2. Completed TASK-002 (Test 2.1: Percentage Commission)

**Test**: `tests/validation/test_2_1_percentage_commission.py`
**Status**: ‚úÖ PASSING
**Configuration**: 0.1% commission, 20 entry/exit pairs, real BTC data
**Results**: Perfect match with VectorBT (20 trades, $97,299.63 final value)

**State Updated**: `state.json` marked TASK-002 as completed, progress now 2/15 (13%)

### 3. Enhanced Wrapper for Combined Fees

**BacktestConfig Enhancement**:
```python
fees: float | dict = 0.0  # Float for percentage, or dict for combined fees
```

**QEngineWrapper Updates**:
- Integrated `VectorBTCommission(fee_rate, fixed_fee)` for combined fees
- Updated entry size calculation for fixed fees: `(cash - fixed_fee) / (price * (1 + pct_rate))`
- Commission model selection based on config.fees type

**VectorBTWrapper Updates**:
- Handle dict fees: extract 'percentage' and 'fixed' components
- Pass to VectorBT as separate parameters: `fees=pct, fixed_fees=fixed`

**Files Modified**:
- `tests/validation/common/engine_wrappers.py` - Combined fee support
- `tests/validation/test_2_2_combined_fees.py` - Test implementation

## üî¥ Current Blocker

### TASK-003: Combined Fees Test Failing

**Issue**: QEngine generates wrong number of trades (14-28 vs expected 20) when fixed fees are enabled.

**Symptoms**:
- Test 2.1 (percentage only): ‚úÖ 20 trades, perfect match
- Test 2.2 (0.1% + $2 fixed): ‚ùå qengine 14-28 trades, VectorBT 20 trades
- Phantom trades appear at bars immediately after exits (e.g., bar 11 after exit at bar 20)

**Root Cause Hypothesis**: The phantom trade bug recurs with fixed fees due to:
1. More complex commission calculation with fixed component
2. Rounding differences amplified by fixed fee subtraction
3. Position tracking mismatch between strategy._positions and broker.position_tracker

**Diagnostic Evidence**:
```
Test 2.2 Results (0.1% + $2 fixed fees):
- qengine: 28 trades, final $98,160.28
- VectorBT: 20 trades, final $97,221.11
- Difference: $939.17 (too large)

Phantom trades at:
- Trade 2: bar 11 (should be bar 60)
- Trade 3: entry at exit price $28,804.54 (wrong bar)
```

**Attempted Fixes**:
1. ‚úÖ Percentage-only entry size: Fixed
2. ‚ùå Combined fee entry size: `(cash - fixed) / (price * (1 + pct))` - Still has issues
3. ‚ùå Exit quantity padding (1.01x): Caused negative cash and fewer trades

**Current State**: Test 2.2 implemented but not passing. Wrapper enhancements complete but blocked by position tracking bug.

## üìä Test Status Summary

### Phase 1: Baseline (COMPLETE ‚úÖ)
- Test 1.1: Entries only - PASSING
- Test 1.2: Entry/exit pairs - PASSING
- Test 1.3: Multiple round trips - PASSING

### Phase 2: Transaction Fees (IN PROGRESS ‚ö†Ô∏è)
- Test 2.1: Percentage commission (0.1%) - ‚úÖ PASSING
- Test 2.2: Combined fees (0.1% + $2) - ‚ùå BLOCKED
- Test 2.3: Asset-specific fees - PENDING

### Phases 3-6: Pending
- 12 tests remaining (slippage, order types, advanced features, stress tests)

## üîë Recent Decisions

### Decision 1: Skip Complex Investigation, Document as Known Issue
**Context**: Test 2.2 blocked by position tracking bug with fixed fees.

**Options**:
1. Deep-dive investigation of broker position tracking (2-4 hours)
2. Document as known limitation, skip to simpler tests
3. Commit wrapper improvements, create separate issue

**Recommendation**: Option 1 or 3 - Either fix properly or defer to separate task.

**Rationale**:
- Wrapper enhancements are valuable (combined fee support)
- Bug is complex and may require core qengine changes
- Simpler tests (slippage, order types) don't have this issue

### Decision 2: Use 1.01x Exit Quantity (REVERTED)
**Context**: Tried padding exit quantity by 1% to compensate for rounding.

**Result**: Failed - caused negative cash and worse trade mismatches.

**Learning**: Cannot over-request exit quantity; broker's position validation prevents over-selling but creates other issues.

## üöß Active Challenges

### Challenge 1: Fixed Fee Position Tracking Bug (CRITICAL üî¥)

**Issue**: With fixed fees, tiny position leftovers prevent proper re-entry.

**Investigation Needed**:
1. Trace broker's fill simulator with fixed fees enabled
2. Compare position_tracker.update_position() calls vs strategy._positions updates
3. Check VectorBTCommission.calculate() for rounding issues
4. Verify cash constraint calculations account for fixed fees correctly

**Potential Root Causes**:
- Fill simulator's binary search (lines 397-413) may not handle fixed fees correctly
- Position update timing with synchronous fills (execution_delay=False)
- Cash available after fixed fee deduction may cause partial fills
- Strategy orders full position but broker has slightly less due to rounding

**Next Investigation Steps**:
1. Add comprehensive logging to fill_simulator.py _apply_cash_constraints()
2. Log exact quantities: requested vs filled vs position_tracker vs strategy._positions
3. Compare with VectorBT's handling of same scenario
4. Check if issue exists with execution_delay=True

### Challenge 2: Entry Size Calculation with Fixed Fees

**Current Formula**:
```python
size = (cash - fixed_fee) / (price * (1 + pct_rate))
```

**Verification**:
- Total cost: size * price * (1 + pct) + fixed
- Should equal: cash
- Formula is algebraically correct ‚úÖ

**But**: May not match broker's EXACT calculation due to:
- Binary search iterations in fill simulator
- Floating point precision differences
- Order of operations in commission calculation

## üìù Next Steps (Priority Order)

### Option A: Fix TASK-003 Now (Recommended if time available)

**Immediate** (2-4 hours):
1. Create diagnostic test with verbose logging:
   - Log strategy._positions after each fill
   - Log broker.position_tracker.get_position() after each fill
   - Log requested order quantity vs filled quantity
   - Compare QEngine vs VectorBT position values bar-by-bar

2. Identify exact point where positions diverge

3. Implement proper fix (likely one of):
   - Adjust VectorBTCommission calculation to match fill simulator exactly
   - Fix cash constraint logic in fill_simulator for fixed fees
   - Ensure position_tracker and strategy._positions stay in perfect sync
   - Add position reconciliation after exits

4. Verify fix:
   - Test 2.2: 20 trades, final values within $10 ‚úÖ
   - Test 2.1 still passes (no regression) ‚úÖ
   - All trades at correct signal bars ‚úÖ

5. Commit combined fee support + fix

### Option B: Skip TASK-003, Continue Validation (Alternative)

**If Option A too complex**:
1. Commit wrapper improvements with note about fixed fee limitation
2. Create GitHub issue documenting the bug
3. Update state.json to mark TASK-003 as "blocked - known issue"
4. Continue with TASK-005 (Test 3.1: Fixed Slippage)
5. Return to TASK-003 after completing simpler tests

**Rationale**:
- Slippage and order type tests don't involve fixed fees
- Can make progress on other validation areas
- Fixed fee bug can be addressed separately

### Option C: Simplify TASK-003 (Compromise)

**Modified approach**:
1. Change Test 2.2 to use ONLY fixed fees ($2, no percentage)
2. Or reduce fixed fee amount ($0.10 instead of $2)
3. See if smaller fixed fees avoid rounding issues
4. Document any differences as expected

## üí° Session-Specific Context

### Key File Locations

**Modified (Uncommitted)**:
- `tests/validation/common/engine_wrappers.py` - Combined fee support + attempted fixes
- `tests/validation/test_2_2_combined_fees.py` - Test implementation

**Completed & Committed**:
- `tests/validation/test_2_1_percentage_commission.py` - Passing test
- `tests/validation/test_diagnostic_signal_timing.py` - Diagnostic for phantom bug
- `.claude/work/current/006_systematic_baseline_validation/state.json` - Progress tracking

**Infrastructure**:
- `tests/validation/common/data_generator.py` - Real BTC data loading
- `tests/validation/common/signal_generator.py` - Entry/exit signal creation
- `tests/validation/common/comparison.py` - Validation reporting
- `tests/validation/VALIDATION_ROADMAP.md` - 17-test specification

### Git Status

**Last Commit**: `5286d3c` - Phantom trade bug fix

**Uncommitted Changes**:
```
M tests/validation/common/engine_wrappers.py
A tests/validation/test_2_2_combined_fees.py
```

**To Commit (After Resolving Block)**:
```
feat: Add combined fee support to validation wrappers

- Enhanced BacktestConfig to accept dict fees
- Integrated VectorBTCommission in QEngineWrapper
- Updated VectorBTWrapper for separate fee parameters
- Implemented Test 2.2 (combined fees)

Note: Test 2.2 currently blocked by position tracking
issue with fixed fees. Investigation ongoing.
```

### Technical Details

**QEngine Commission Models Available**:
- `NoCommission` - For zero-fee tests
- `PercentageCommission(rate)` - Simple percentage (e.g., 0.1%)
- `VectorBTCommission(fee_rate, fixed_fee)` - Combined fees
- Other models: Flat, PerShare, Tiered, MakerTaker, AssetClass, InteractiveBrokers

**VectorBT Fee Parameters**:
- `fees`: Percentage fee as decimal (0.001 = 0.1%)
- `fixed_fees`: Fixed dollar amount per trade
- Both can be used simultaneously

**Position Tracking Components**:
- `Strategy._positions`: Dict updated on FillEvent via `on_fill_event()`
- `PositionTracker._positions`: Dict updated by broker via `update_position()`
- `Portfolio.positions`: Separate object (can be stale)

**Known Working**:
- Percentage-only fees (0.1%): ‚úÖ Perfect match
- No fees (baseline): ‚úÖ Perfect match
- Real BTC data: ‚úÖ 2.1M bars available
- Signal generation: ‚úÖ Deterministic and correct

**Known Broken**:
- Combined fees (0.1% + $2): ‚ùå Position tracking mismatch
- Fixed fees alone: ‚ùì Not tested yet

## üéì Learnings (For Permanent Memory)

### Commission and Position Tracking

**Discovery**: Entry size calculation MUST account for commission before ordering, not after.

**Pattern**:
```python
# Wrong (causes phantom trades):
size = cash / price
# Broker reduces size, creates mismatch

# Right (prevents phantom trades):
size = cash / (price * (1 + commission_rate))
# Strategy and broker agree on fill size
```

**Application**: Always pre-calculate affordable size including ALL costs (commission, slippage, fixed fees).

### Fixed Fees Amplify Rounding Errors

**Discovery**: Fixed fee subtraction from cash creates larger relative errors than percentage fees.

**Example**:
- With 0.1% fee: $100,000 ‚Üí fill ~3.4537 BTC (error ~0.01%)
- With 0.1% + $2 fee: $99,998 ‚Üí fill ~3.4551 BTC (error varies with leftover cash)
- Small cash remainders after fixed fee create larger position discrepancies

**Application**: Fixed fees require more careful position reconciliation. Consider:
- Always clear positions fully (query broker's actual position)
- Use larger tolerance for position == 0 checks (1e-6 instead of 1e-9)
- Reconcile positions after every trade

### VectorBT API for Combined Fees

**Discovery**: VectorBT uses separate parameters, not a dict.

**API**:
```python
Portfolio.from_signals(
    fees=0.001,       # Percentage component
    fixed_fees=2.0,   # Fixed component
    # NOT: fees={'percentage': 0.001, 'fixed': 2.0}
)
```

**Application**: When wrapping multiple engines, normalize to internal format (dict) then convert to each engine's API.

## üîó References

**Previous Handoff**: `.claude/transitions/2025-11-12/025405.md`
- Real data migration
- Diagnostic test creation
- Initial phantom trade bug discovery

**Current Work Unit**: `.claude/work/current/006_systematic_baseline_validation/`
- `state.json` - Task tracking (TASK-001, TASK-002 complete)
- `requirements.md` - 17-test specifications
- `exploration.md` - Implementation approach

**Key Commits**:
- `76ca9a2` - Real data migration
- `5286d3c` - Phantom trade bug fix (percentage fees)

**Relevant Code**:
- `tests/validation/common/engine_wrappers.py:10-17` - BacktestConfig
- `tests/validation/common/engine_wrappers.py:225-244` - Commission model selection
- `tests/validation/common/engine_wrappers.py:146-167` - Entry size calculation
- `src/qengine/execution/commission.py:358-417` - VectorBTCommission
- `src/qengine/execution/fill_simulator.py:340-428` - Cash constraints
- `src/qengine/execution/position_tracker.py:43-94` - Position updates

## ‚ö†Ô∏è Important Notes

### Context Usage

**Current**: 128K/200K tokens (64%)
**Safe**: Continue with current session if fixing TASK-003
**If exceeds 80%**: Create another handoff before completing fix

### Test Environment

**Python**: 3.13.5
**Virtual env**: `.venv`
**Test command**: `.venv/bin/python -m pytest tests/validation/test_*.py -v`
**Direct execution**: `.venv/bin/python tests/validation/test_2_2_combined_fees.py`

### VectorBT Pro Requirement

Test 2.2 requires VectorBT Pro (not open-source VectorBT):
```python
import vectorbtpro as vbt
```

If not available, test will skip with import error.

---

## üöÄ To Continue This Session

**Focus**: Resolve TASK-003 combined fee bug or skip to TASK-005

**First Decision**: Choose Option A, B, or C from Next Steps

**If Option A (Fix Now)**:
1. Create `test_diagnostic_combined_fees.py` with extensive logging
2. Run and compare position values bar-by-bar
3. Identify exact divergence point
4. Implement fix in fill_simulator or position_tracker
5. Verify Test 2.2 passes
6. Commit all changes

**If Option B (Skip)**:
1. Commit wrapper improvements with caveat
2. Mark TASK-003 as blocked in state.json
3. Create GitHub issue for the bug
4. Continue with TASK-005 (slippage tests)

**If Option C (Simplify)**:
1. Modify Test 2.2 to use smaller fixed fee or fixed-only
2. Re-run and check if issue persists
3. Document any differences as expected behavior

**Key Question**: How much time is available? (Option A = 2-4 hours, Option B = 30 min, Option C = 1 hour)

---

**Session Complete**: TASK-002 ‚úÖ completed, TASK-003 ‚ö†Ô∏è blocked by fixed fee bug

**Priority**: Resolve blocker before continuing validation roadmap
