# Handoff: 2025-11-21 15:09:52 UTC

## Active Work

Fixing validation test failures after ml4t.backtest API migration. Working on cross-framework validation to ensure ml4t.backtest can replicate VectorBT, Backtrader, and Zipline execution patterns.

## Current State

**Test Results**: **143 passed, 11 failed, 2 skipped (92.9% pass rate)**

**Progress from Previous Session**:
- Started: 142 passed, 12 failed (91.0%)
- Current: 143 passed, 11 failed (92.9%)
- **+1 test fixed**: test_1_1_baseline_entries.py

**What Was Completed This Session**:

1. ✅ **Created `generate_exit_on_next_entry()` helper function**
   - Location: `tests/validation/common/signal_generator.py:114-154`
   - Generates explicit exit signals one bar before each subsequent entry
   - Includes `close_final=True` parameter to close final position
   - Framework-agnostic solution avoiding VectorBT conflict resolution issues

2. ✅ **Exported helper in common module**
   - Added to `tests/validation/common/__init__.py`
   - Available: `from common import generate_exit_on_next_entry`

3. ✅ **Fixed test_1_1_baseline_entries.py**
   - Added explicit exit signal generation
   - Test now passes: 20 trades both frameworks, $968 PnL, identical results

## Critical Architectural Issue Identified

**USER FEEDBACK RECEIVED**: The approach of forcing other frameworks to match ml4t.backtest's "close on next entry" behavior is backwards.

**Correct Requirement**: ml4t.backtest must be **configurable** to replicate VectorBT/Backtrader/Zipline execution patterns, not the other way around.

**Root Problem Located**:
- File: `tests/validation/common/engine_wrappers.py:133`
- BacktestWrapper implements "close on next entry" as hardcoded behavior
- Code: `should_exit = (exit_signal and current_qty != 0) or (entry_signal and current_qty != 0)`
- This is a **strategy-level decision**, not a framework feature
- VectorBT, Backtrader, Zipline do NOT have this behavior by default

**Why This Matters**:
- Validation framework exists to prove ml4t.backtest can match established frameworks
- Making VectorBT/Backtrader match ml4t.backtest defeats the purpose
- "Close on next entry" should be opt-in strategy logic, not framework default

## Recent Decisions

### Decision 1: Wrong Approach Identified (This Session)
**What**: Adding `generate_exit_on_next_entry()` helper and using it to make VectorBT match ml4t.backtest
**Status**: Completed but BACKWARDS
**Why Wrong**: Forces validation frameworks to adapt to ml4t.backtest's non-standard behavior
**Correct Approach**: Remove "close on next entry" from BacktestWrapper entirely

### Decision 2: Proper Fix Required (User Directed)
**What**: Make ml4t.backtest configurable to match other frameworks
**Status**: Not yet implemented
**Options**:
1. **Remove "close on next entry" logic** (simplest, recommended)
   - Change line 133: `should_exit = (exit_signal and current_qty != 0)` only
   - Makes ml4t.backtest behave like VectorBT/Backtrader by default

2. **Add configuration parameter** (more flexible)
   - Add `close_on_next_entry: bool = False` to BacktestConfig
   - Conditional: `(config.close_on_next_entry and entry_signal and current_qty != 0)`

3. **Match framework behavior exactly** (most complex)
   - Per-framework execution modes
   - Not recommended for initial fix

## Remaining 11 Failures

These are NOT related to "close on next entry" issue:

1. `test_all_platforms_scenario_001.py` - Integration test (runner.py)
2. `test_diagnostic_signal_timing.py` - Different issue
3. `test_diagnostic_with_logging.py` - Uses old event-driven API (should delete)
4. `test_integrated_framework_alignment.py` (3 tests) - Adapter-based
5. `test_pytest_integration.py` - Adapter-based
6. `test_qengine_signal_processing.py` - Uses removed MarketEvent API (should delete)
7. `test_validation.py` (2 tests) - Import path issues

## Next Steps (CRITICAL PRIORITY)

**Immediate Action Required**:

1. **UNDO recent changes** (they're solving the wrong problem):
   - Revert test_1_1_baseline_entries.py changes
   - Keep `generate_exit_on_next_entry()` helper (useful for tests)
   - Remove usage of helper from test_1_1

2. **Fix BacktestWrapper** (`tests/validation/common/engine_wrappers.py:133`):
   ```python
   # OLD (WRONG):
   should_exit = (exit_signal and current_qty != 0) or (entry_signal and current_qty != 0)

   # NEW (CORRECT):
   should_exit = (exit_signal and current_qty != 0)  # Only exit on explicit signals
   ```

3. **Verify test_1_1 passes** with the corrected BacktestWrapper

4. **Run full validation suite** - expect significantly more tests to pass

5. **Add configuration if needed** - if some tests genuinely need "close on next entry"

## Key Files Modified (This Session)

**Created/Modified**:
1. `tests/validation/common/signal_generator.py` - Added `generate_exit_on_next_entry()` function
2. `tests/validation/common/__init__.py` - Exported new helper
3. `tests/validation/test_1_1_baseline_entries.py` - Added explicit exit generation (REVERT THIS)

**Files NOT Yet Modified (But Should Be)**:
1. `tests/validation/common/engine_wrappers.py:133` - BacktestWrapper exit logic (FIX THIS FIRST)

## Files to Delete (Obsolete Tests)

These use removed event-driven API:
- `tests/validation/test_diagnostic_with_logging.py`
- `tests/validation/test_qengine_signal_processing.py`

## Virtual Environments

- **`.venv`**: Main environment (no comparison frameworks)
- **`.venv-validation`**: Has VectorBT Pro 2025.7.27, Backtrader, Zipline, Python 3.12.11

**Test Command**:
```bash
source .venv-validation/bin/activate && pytest tests/validation/ -q --tb=no
```

## Branch & Git Status

**Branch**: `feature/phase-1-ml-data-foundation`

**Uncommitted Changes**:
```
M tests/validation/common/__init__.py
M tests/validation/common/signal_generator.py
M tests/validation/test_1_1_baseline_entries.py
M tests/validation/README.md
M tests/validation/common/engine_wrappers.py (from previous session)
?? .claude/transitions/2025-11-21/
```

**Recent Commits**:
```
6c7f8d0 fix: Update validation tests to use new ml4t.backtest API
8e71680 fix: Fix import paths in runner.py for new modular API structure
```

## Open Questions

1. ~~Should we make "close on next entry" configurable?~~ → NO, remove it entirely (user decision)
2. Should we add per-framework execution modes? → Maybe later, not priority
3. Can other obsolete tests be safely deleted? → Yes, 2 tests using removed API

## Investigation Resources

**VectorBT Source** (all available locally):
- Conflict resolution: `resources/vectorbt.pro-main/vectorbtpro/portfolio/nb/from_signals.py:134-196`
- Portfolio API: `resources/vectorbt.pro-main/vectorbtpro/portfolio/base.py`

**Backtrader Source**: `resources/backtrader-master/backtrader/brokers/bbroker.py`
**Zipline Source**: `resources/zipline-reloaded-main/src/zipline/`

## Session Summary

**Hours Spent**: ~2 hours
**Major Realization**: Was solving the problem backwards - forcing validation frameworks to match ml4t.backtest instead of making ml4t.backtest match them
**Blocker Removed**: User clarified correct architectural approach
**Recommendation**: Implement simple fix (remove "close on next entry") immediately, expect most tests to pass

---

**Working Directory**: `/home/stefan/ml4t/software/backtest/`
**Last Test Run**: 143 passed, 11 failed, 2 skipped (203s)
**Git Branch**: `feature/phase-1-ml-data-foundation`
**Context**: Previous handoff at `.claude/transitions/2025-11-21/141553.md`
