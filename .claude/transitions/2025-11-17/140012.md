# Handoff: 2025-11-17 14:00:12 UTC

**Session Type**: Planning - Integration & Implementation Plan Creation
**Location**: `/home/stefan/ml4t/software/backtest`
**Work Unit**: `009_integrated_ml_risk` (renamed from `009_risk_management_exploration`)
**Status**: ✅ Planning Complete, Ready for Implementation

---

## Active Work

**Successfully integrated two major feature sets into unified implementation plan**:
1. **ML Data Architecture** (27 tasks, 320 hours, 8 weeks)
2. **Risk Management** (66 tasks, 280 hours, 7.5 weeks)
3. **Result**: 50 integrated tasks, 420 hours, 10 weeks (46% task reduction, 35% timeline reduction)

**Key Achievement**: Created comprehensive implementation plan for integrated ML-first data architecture and risk management system.

---

## Current State

### Completed Deliverables

**1. state.json** (50 integrated tasks)
- **Location**: `.claude/work/009_risk_management_exploration/state.json`
- **Structure**: 4 phases with clear dependencies
  - Phase 1: ML Data Foundation (15 tasks, 110h, 3 weeks) - CRITICAL
  - Phase 2: Risk Management Core (10 tasks, 85h, 2 weeks) - HIGH
  - Phase 3: Advanced Features (15 tasks, 120h, 3 weeks) - PARALLEL EXECUTION
  - Phase 4: Integration & Documentation (10 tasks, 105h, 2 weeks)
- **Quality**: Each task has acceptance criteria, dependencies, file locations, priority

**2. INTEGRATED_IMPLEMENTATION_PLAN.md** (11,000+ words)
- **Location**: `.claude/work/009_risk_management_exploration/INTEGRATED_IMPLEMENTATION_PLAN.md`
- **Sections**: 10 comprehensive sections covering architecture, specifications, quality, risks
- **Highlights**:
  - Complete system architecture diagrams
  - Technical specifications for all components
  - Performance targets: 10-30k events/sec, <2GB memory
  - Quality gates for each phase (80%+ coverage target)
  - Complete Top 25 ML strategy example

**3. metadata.json** (updated)
- **Location**: `.claude/work/009_risk_management_exploration/metadata.json`
- **Work Unit Renamed**: `009_integrated_ml_risk` (broader scope)
- **Metrics**: Task reduction (46%), timeline reduction (35%), effort savings (30%)
- **Status**: `planning_complete`, `ready_for_implementation`

---

## Recent Decisions

### Critical Dependency Discovered

**Decision**: Merge ML Data and Risk Management into single implementation
**Rationale**: Risk Management requires ML Data Architecture as foundation
**Evidence**:
```python
# Risk Management needs this:
class RiskContext:
    features: dict[str, float]       # From MarketEvent.indicators
    market_features: dict[str, float]  # From MarketEvent.context

# But MarketEvent currently only has:
class MarketEvent:
    signals: dict[str, float]  # ✅ Exists
    # ❌ Missing: indicators dict
    # ❌ Missing: context dict

# ML Data Architecture adds foundation pieces Risk needs
```

**Impact**: Implementing separately would require rework. Integration saves 43 tasks, 180 hours, 5.5 weeks.

### Work Unit Renaming

**Old Name**: `009_risk_management_exploration`
**New Name**: `009_integrated_ml_risk`
**Reason**: Broader scope - covers both ML Data Architecture AND Risk Management
**Note**: Directory name still `009_risk_management_exploration/` (filesystem unchanged)

### Shared Infrastructure (Eliminates Duplication)

Both systems share:
1. **Enhanced MarketEvent** (signals, indicators, context dicts)
2. **FeatureProvider** (unified interface for ML + Risk)
3. **Configuration System** (YAML/JSON)
4. **PolarsDataFeed** (lazy loading, validation, performance optimizations)
5. **Performance Optimizations** (caching, lazy evaluation)

### Phase Structure

**Phase 1 → Phase 2 → Phase 3 → Phase 4** (strict dependencies)

**Critical Path**: Phase 1 must complete before Phase 2 (foundation required)

**Parallel Opportunity**: Phase 3 has 3 independent tracks:
- Track A: Trade Recording (5 tasks, 38h)
- Track B: Advanced Risk Rules (7 tasks, 50h)
- Track C: Enhanced Slippage (3 tasks, 32h)

Can execute in parallel (120h wall-clock vs 150h sequential).

---

## Key Technical Specifications

### Enhanced MarketEvent Design

```python
@dataclass
class MarketEvent(Event):
    timestamp: datetime
    asset_id: str
    # OHLCV data
    open: float
    high: float
    low: float
    close: float
    volume: float
    # ML predictions
    signals: dict[str, float] = field(default_factory=dict)
    # Per-asset technical indicators
    indicators: dict[str, float] = field(default_factory=dict)
    # Market-wide context
    context: dict[str, float] = field(default_factory=dict)
```

**Usage**:
- ML Strategy: `event.signals.get('ml_score')`
- Risk Rules (per-asset): `context.features.get('atr')` (from `event.indicators`)
- Risk Rules (market): `context.market_features.get('vix')` (from `event.context`)

### PolarsDataFeed Architecture

**Design Principles**:
1. **Lazy loading**: `scan_parquet()` not `read_parquet()`
2. **Chunking**: Monthly batches for large datasets
3. **group_by iteration**: O(N) not O(T×N) - **10-50x speedup**
4. **Multi-source merging**: Price + signals + features

**Critical Optimization** (NON-NEGOTIABLE):
```python
# BAD: O(T × N)
for ts in timestamps:
    rows = df.filter(pl.col('timestamp') == ts)

# GOOD: O(N) - 10-50x faster
for (ts, group) in df.group_by('timestamp', maintain_order=True):
    # Process group
```

### Performance Targets

| Metric | Target | Notes |
|--------|--------|-------|
| Throughput (empty strategy) | 100k+ events/sec | Data layer only |
| Throughput (ML + Risk realistic) | 10-30k events/sec | Full system |
| Memory (250 symbols × 1 year) | <2GB | With all features |
| Backtest time (typical workload) | 2-5 minutes | 250 symbols × 1 year |
| Data layer overhead | <5% | vs baseline |
| Risk layer overhead | <3% | vs no risk |
| Total overhead | <8% | Integrated system |

### Quality Gates

**Phase 1 Exit**:
- ✅ Event generation >100k events/sec
- ✅ Memory <2GB for 250 symbols × 1 year
- ✅ No look-ahead bias possible
- ✅ 80%+ coverage for data layer

**Phase 2 Exit**:
- ✅ RiskManager overhead <3%
- ✅ All 3 hooks working (exit check, order validation, fill recording)
- ✅ Backward compatible (existing tests pass with `risk_manager=None`)
- ✅ 80%+ coverage for risk module

**Phase 3 Exit**:
- ✅ All advanced features implemented
- ✅ Overhead <5% vs simple rules
- ✅ All 3 parallel tracks integrated

**Phase 4 Exit**:
- ✅ All examples executable
- ✅ Cross-framework alignment <0.5% variance
- ✅ 80%+ overall coverage
- ✅ Release ready

---

## Next Steps

### Immediate Actions (Ready to Execute)

**1. Begin Implementation**:
```bash
cd /home/stefan/ml4t/software/backtest
/workflow:next
# This starts TASK-INT-001: Enhanced MarketEvent
```

**2. Create Feature Branch**:
```bash
git checkout -b feature/integrated-ml-risk
```

**3. Set Up CI**:
- Configure GitHub Actions for integrated system
- Add benchmarks to CI pipeline
- Ensure quality gates enforced

### Task Execution Order

**Phase 1 (Sequential - 3 weeks)**:
1. TASK-INT-001: Enhanced MarketEvent (4h) - **START HERE**
2. TASK-INT-002: FeatureProvider interface (4h)
3. TASK-INT-003: PolarsDataFeed core (16h)
4. TASK-INT-004: Event generation optimization - group_by (8h) - **CRITICAL**
5. TASK-INT-005: Signal timing validation (6h) - **CRITICAL**
6. ... (continue through TASK-INT-015)

**Phase 2 (Sequential - 2 weeks)**:
- Depends on Phase 1 completion
- Starts with TASK-INT-016: RiskContext

**Phase 3 (Parallel - 3 weeks)**:
- Can execute 3 tracks simultaneously
- Or batch: Track B (high priority) → Track A → Track C

**Phase 4 (Sequential - 2 weeks)**:
- Final integration and validation
- TASK-INT-041: Top 25 ML strategy example - **THE reference example**

### Validation Strategy

After each phase, STOP and validate quality gates before proceeding:

```bash
# After Phase 1
pytest tests/benchmarks/benchmark_data_layer.py
# Verify: >100k events/sec, <2GB memory

# After Phase 2
pytest tests/benchmarks/benchmark_risk_core.py
# Verify: <3% overhead

# After Phase 3
pytest tests/integration/test_advanced_risk_scenarios.py
# Verify: All features working

# After Phase 4
pytest tests/validation/test_integrated_framework_alignment.py
# Verify: <0.5% variance from VectorBT/Backtrader
```

---

## Open Questions / Considerations

### Performance Optimization (Phase 1, TASK-INT-004)

**Critical Decision**: Use `group_by()` not `filter()` for event generation
- **Impact**: 10-50x performance difference
- **Implementation**: Must use `maintain_order=True` to preserve chronological order
- **Validation**: Benchmark comparing to filter approach, verify order correctness

**If issues arise**: Keep filter approach as fallback with feature flag

### Backward Compatibility (Throughout)

**Critical Requirement**: Existing strategies must work unchanged
- MarketEvent changes are backward compatible (new fields optional)
- RiskManager is opt-in (`risk_manager=None` default)
- FillSimulator refactor (TASK-INT-038) supports both old and new signatures

**Feature Flags**:
- `USE_POLARS_FEED` (default False in Phase 1)
- `USE_RISK_MANAGER` (default False in Phase 2)

### High-Risk Tasks

**TASK-INT-038** (FillSimulator refactor):
- **Risk**: Breaking change to core execution
- **Mitigation**: 100+ backward compat tests, both signatures supported
- **Contingency**: Defer to Phase 4 if issues arise

**TASK-INT-004** (group_by optimization):
- **Risk**: Event ordering bugs
- **Mitigation**: `maintain_order=True`, compare to baseline
- **Contingency**: Feature flag fallback to filter approach

**TASK-INT-019** (Engine integration):
- **Risk**: Breaking existing workflows
- **Mitigation**: Feature flag, default to `risk_manager=None`
- **Contingency**: Rollback hooks if critical issues

---

## Session Context

### Files Modified This Session

**Created**:
- `.claude/work/009_risk_management_exploration/state.json` (50 integrated tasks)
- `.claude/work/009_risk_management_exploration/INTEGRATED_IMPLEMENTATION_PLAN.md` (11k+ words)
- `.claude/transitions/2025-11-17/140012.md` (this handoff)

**Updated**:
- `.claude/work/009_risk_management_exploration/metadata.json` (work unit name, metrics)

**Previous Session Files** (context):
- `.claude/work/009_risk_management_exploration/ML_DATA_ARCHITECTURE_PROPOSAL.md`
- `.claude/work/009_risk_management_exploration/ML_DATA_ARCHITECTURE_TASKS.md`
- `.claude/work/009_risk_management_exploration/MERGE_ANALYSIS.md`
- `.claude/work/009_risk_management_exploration/PHASE_0_COMPLETION_SUMMARY.md`
- `.claude/work/009_risk_management_exploration/implementation-plan.md` (superseded)

### Git Status

```
M .claude/work/ACTIVE_WORK
M .claude/work/current/007_redesign/state.json
M .claude/work/009_risk_management_exploration/metadata.json
M .claude/work/009_risk_management_exploration/state.json
?? .claude/transitions/2025-11-17/
?? .claude/work/009_risk_management_exploration/INTEGRATED_IMPLEMENTATION_PLAN.md
```

### Current Branch

```
main
```

**Recommended**: Create feature branch before starting implementation.

---

## Integration Points

### With Existing Codebase

**Files to Modify** (Phase 1):
- `src/ml4t/backtest/core/event.py` - Add indicators/context dicts to MarketEvent
- `src/ml4t/backtest/data/feature_provider.py` - New file, FeatureProvider interface
- `src/ml4t/backtest/data/polars_data_feed.py` - New file, PolarsDataFeed implementation
- `src/ml4t/backtest/strategy/base.py` - Add on_timestamp_batch() method
- `src/ml4t/backtest/engine.py` - Integrate PolarsDataFeed

**Files to Create** (Phase 2):
- `src/ml4t/backtest/risk/context.py` - RiskContext
- `src/ml4t/backtest/risk/decision.py` - RiskDecision
- `src/ml4t/backtest/risk/rule.py` - RiskRule interface
- `src/ml4t/backtest/risk/manager.py` - RiskManager
- `src/ml4t/backtest/risk/position_state.py` - PositionTradeState

### External Dependencies

**Production**:
- `polars ^1.15.0` - Already in dependencies
- `pydantic ^2.9.2` - Already in dependencies

**Development** (validation):
- `vectorbtpro ^2.0.5` - Already in dependencies
- `backtrader ^1.9.78.123` - Already in dependencies

No new external dependencies required.

---

## Reference Documentation

### Key Documents

**Implementation Plan**:
- `.claude/work/009_risk_management_exploration/INTEGRATED_IMPLEMENTATION_PLAN.md`
  - Complete technical specifications
  - 10 sections covering all aspects
  - Code examples for Top 25 ML strategy

**Task Definitions**:
- `.claude/work/009_risk_management_exploration/state.json`
  - 50 tasks with acceptance criteria
  - Dependencies and file locations
  - Priority and hour estimates

**Integration Analysis**:
- `.claude/work/009_risk_management_exploration/MERGE_ANALYSIS.md`
  - Why merge (critical dependency)
  - Task-by-task comparison
  - Savings calculation (46% tasks, 35% timeline)

**Architecture Proposal** (ML Data):
- `.claude/work/009_risk_management_exploration/ML_DATA_ARCHITECTURE_PROPOSAL.md`
  - Detailed design for PolarsDataFeed
  - Performance optimization strategies
  - Validation requirements

**Transition Document** (previous session):
- `.claude/transitions/2025-11-17/073800.md`
  - Merge analysis completion
  - Requirements for final deliverables

### Project Context

**Location**: `/home/stefan/ml4t/software/backtest/`
**Project**: ml4t.backtest - Event-driven backtesting engine
**Current Coverage**: 44% (target: 80%+)
**Architecture**: Event-driven + hybrid vectorized

**Related Work Units**:
- `007_redesign` - Current work (separate from this)
- `008_ml_signal_integration` - Related ML work

---

## Success Metrics

### Planning Success (✅ Completed)

- ✅ Identified critical dependency (Risk needs ML Data)
- ✅ Eliminated 46% of duplicate tasks (93 → 50)
- ✅ Reduced timeline by 35% (15.5 weeks → 10 weeks)
- ✅ Created coherent phase structure with dependencies
- ✅ Comprehensive implementation plan with technical specifications

### Implementation Success (Targets)

- [ ] All 50 tasks completed across 4 phases
- [ ] Performance targets met: 10-30k events/sec, <2GB memory
- [ ] Integration validated: ML + Risk working seamlessly
- [ ] 80%+ test coverage across all modules
- [ ] Cross-framework validation: <0.5% variance from VectorBT/Backtrader
- [ ] Complete executable example: Top 25 ML strategy with risk management

---

## Notes for Next Session

### Context to Preserve

**User Feedback Incorporated**:
- Work unit renamed to reflect broader scope (ML + Risk, not just Risk)
- Emphasis on "for posterity" - comprehensive documentation for future reference
- Clear integration story with technical rationale

**Critical Insights**:
1. **group_by optimization is NON-NEGOTIABLE** - 10-50x difference, not optional
2. **Context caching gives 10x speedup** with multiple rules (O(n) not O(n×m))
3. **Lazy properties reduce build time 50-70%** when rules don't use all fields
4. **Phase 1 must complete before Phase 2** - foundation dependency is real

**Implementation Philosophy**:
- Start simple, validate quality gates, proceed incrementally
- Backward compatibility throughout (feature flags, optional parameters)
- Performance validation at each phase (benchmarks in CI)
- Integration testing early and often

### Quick Commands Reference

```bash
# Begin implementation
/workflow:next

# After Phase 1 completes
pytest tests/benchmarks/benchmark_data_layer.py

# Check coverage
pytest --cov=src/ml4t/backtest --cov-report=html

# Validate integration
pytest tests/integration/

# Cross-framework validation (Phase 4)
pytest tests/validation/test_integrated_framework_alignment.py
```

### Token Usage Note

This session used ~122k / 200k tokens (61%). Planning work is token-intensive due to comprehensive analysis and document creation. Implementation sessions will be lighter (focused on specific tasks).

---

**Handoff Complete**: ✅ Planning phase finished, ready for implementation

**Next Session Focus**: Begin Phase 1 implementation with TASK-INT-001 (Enhanced MarketEvent)

**Estimated Timeline**: 10 weeks total (3+2+3+2), starting with critical 3-week Phase 1

**Status**: Planning complete, implementation ready to begin

---

*Created: 2025-11-17 14:00:12 UTC*
*Location: /home/stefan/ml4t/software/backtest*
*Work Unit: 009_integrated_ml_risk*
