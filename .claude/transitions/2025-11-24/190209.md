# Handoff: 2025-11-24 19:02:09 UTC

## Session Summary

Completed comprehensive external code review process for ml4t.backtest v0.2.0. Two independent reviewers (Opus and Gemini) analyzed the codebase and identified critical bugs requiring immediate attention before v1.0 release.

---

## Active Work

**External Code Review Synthesis**: Analyzed feedback from two expert reviewers on ml4t.backtest correctness, feature completeness, and design quality.

**Location**: `/home/stefan/ml4t/software/backtest/`

---

## Current State

### Review Package Created

Created comprehensive review bundle at `.claude/code_review/251124-02/`:

| File | Size | Purpose |
|------|------|---------|
| `README.md` | 1,134 lines | Complete feature documentation |
| `REVIEW_REQUEST.md` | 616 lines | Detailed questions and context |
| `EXTERNAL_REVIEW_BUNDLE.md` | 303 lines | Reviewer guide |
| `backtest_src.xml` | 244KB | All 33 source files packaged |

### Reviews Received

Two independent external reviews completed:
- `opus-01.md` (532 lines) - Detailed technical review
- `gemini-01.md` (208 lines) - Correctness-focused review

**Overall Assessment**: Both reviewers agree architecture is solid (‚≠ê‚≠ê‚≠ê‚≠ê) but found **3 critical bugs** that must be fixed immediately.

---

## Critical Findings (P0 - Must Fix)

### üî¥ Bug #1: Margin Buying Power Formula Wrong

**File**: `accounting/policy.py:MarginAccountPolicy.calculate_buying_power()`

**Problem**: Uses **maintenance margin** instead of **initial margin**, allowing 4x leverage instead of 2x.

**Current (buggy)**:
```python
buying_power = (nlv - maintenance_margin_requirement) / self.initial_margin
```

**Correct**:
```python
total_market_value = sum(abs(pos.market_value) for pos in positions.values())
required_initial_margin = total_market_value * self.initial_margin
excess_equity = nlv - required_initial_margin
buying_power = max(0.0, excess_equity / self.initial_margin)
```

**Impact**: Users can achieve 4x leverage when Reg T limits to 2x. Makes margin backtests unrealistic.

**Found by**: Both Opus and Gemini (same bug, same fix)

### üî¥ Bug #2: Stop Order Gap Fill Price

**File**: `broker.py:_check_fill()`

**Problem**: When price gaps through stop, fills at stop price instead of open price.

**Scenario** (sell stop):
- Yesterday close: $150, Stop: $145
- Today: Open=$140 (gap), High=$142, Low=$138
- **Current**: Fills at min($145, $142) = $142 ‚ùå
- **Correct**: Should fill at $140 (open)

**Fix** (from Opus):
```python
elif order.side == OrderSide.SELL and low <= order.stop_price:
    bar_open = self._current_opens.get(order.asset, price)
    if bar_open <= order.stop_price:
        return bar_open  # Gap through
    else:
        return order.stop_price  # Normal trigger
```

**Found by**: Both Opus and Gemini (same issue, different examples)

### üî¥ Bug #3: Commission Split on Position Flip

**File**: `broker.py:_execute_fill()`

**Problem**: When flipping position (Long 100 ‚Üí Short 100 via -200 order), commission calculated on 200 shares but only applied to closing trade.

**Current**:
```python
pnl = (fill_price - pos.entry_price) * old_qty - commission  # All commission
self.trades.append(Trade(..., commission=commission))
# New position has no commission tracked
```

**Correct**:
```python
close_qty = abs(old_qty)
open_qty = abs(new_qty)
close_commission = commission_model.calculate(asset, close_qty, price)
open_commission = commission_model.calculate(asset, open_qty, price)

pnl = (fill_price - pos.entry_price) * old_qty - close_commission
self.trades.append(Trade(..., commission=close_commission))
# Track open_commission with new position
```

**Found by**: Opus only

---

## Significant Findings (P1 - Should Fix)

### üü° Bug #4: Bracket Orders Not Cancelled on Position Flip

**File**: `broker.py:_execute_fill()`

**Problem**: When position flips (Long ‚Üí Short), old bracket orders remain active and dangerous.

**Scenario**:
1. Long 100 AAPL with stop-loss at $145
2. Flip to short 100 via sell -200
3. Old stop-loss still active
4. Price drops to $145 ‚Üí stop triggers ‚Üí now short 200!

**Fix**:
```python
elif (old_qty > 0) != (new_qty > 0):
    # Position flipped - cancel all pending orders for this asset
    for o in list(self.pending_orders.values()):
        if o.asset == order.asset and o.order_id != order.order_id:
            o.status = OrderStatus.CANCELLED
            del self.pending_orders[o.order_id]
```

**Found by**: Opus only

### üü° Bug #5: Gatekeeper Position Flip Validation

**File**: `accounting/gatekeeper.py`

**Problem**: When flipping, validates short margin while long is still held. Should simulate close first, then validate short against post-close buying power.

**Found by**: Gemini only

### üü° Edge Case: Zero Volume Bars

**File**: `models.py:VolumeShareSlippage`

**Problem**: If `volume=0`, slippage returns 0 cost. Should block trade or assume infinite slippage.

**Found by**: Gemini only

---

## Feature Gaps Identified

### Critical Missing Features

| Feature | Impact | Priority |
|---------|--------|----------|
| Stock splits | Position quantities wrong | **Must add** |
| Dividends | Cash not credited | High |
| Delisting | Zombie positions | Medium |
| Futures margin (SPAN) | Can't model futures | High (if targeting futures) |
| PARTIALLY_FILLED status | API confusion | Medium |

### Document Limitations

| Limitation | Current | Recommendation |
|------------|---------|----------------|
| Margin model | Treats long/short symmetrically | Document Reg T simplification |
| T+2 settlement | Immediate | Document BP overstatement |
| Margin interest | Not modeled | Add optional borrow rate |

---

## Validation Test Cases Needed

Both reviewers suggested these unit tests:

```python
def test_margin_buying_power_correct():
    """Verify max leverage is 2x, not 4x."""
    # Cash: $10k, IM=50%
    # Buy $20k stock ‚Üí OK
    # Try buy $1 more ‚Üí FAIL

def test_gap_through_sell_stop():
    """Stop fills at open when gapped through."""
    # Long 100 @ $150, stop at $145
    # Open=$140, High=$142, Low=$138
    # Expected: Fill at $140

def test_position_flip_cancels_brackets():
    """Bracket orders cancelled on flip."""
    # Long 100 with SL=$145, TP=$160
    # Sell -200 ‚Üí brackets cancelled

def test_commission_split_on_flip():
    """Commission split between close and open."""
    # Long 100 @ $100, Sell -200 @ $110
    # Expected: Close commission on 100, open on 100

def test_zero_volume_bar():
    """Orders blocked or rejected on zero volume."""
```

---

## API Design Feedback

### Keep As-Is ‚úÖ
- Order return type (both reviewers: keep returning Order object)
- Performance (100k events/sec is excellent)
- Exit-first processing (correct implementation)

### Consider Changing üîÑ

1. **Position Access** (both reviewers)
   - Current: `broker.get_position("AAPL")` (method)
   - Better: `broker.positions["AAPL"]` (dict-like)

2. **ExecutionResult.success** (Opus)
   - Add `all_executed` (all orders submitted)
   - Add `complete` (all executed, no skips)
   - Keep `success` (no hard errors)

3. **DataFeed Iteration** (Gemini)
   - Current: `(timestamp, data, context)` tuple
   - Better: `BarData` dataclass (easier to extend)

---

## Recent Decisions

### Live Trading Design Complete

- Created comprehensive design document (v3.0) for ml4t-live
- Addressed Gemini's v1 + v2 reviews
- Handed off to live project for implementation
- Location: `/home/stefan/ml4t/software/live/DESIGN.md`

### Backtest Review Process

- Created comprehensive README (1,134 lines) documenting all features
- Packaged all 33 source files into XML for review
- Created detailed review request with specific questions
- Received two independent expert reviews
- Identified 5 critical/significant bugs requiring immediate fixes

---

## Next Steps (Priority Order)

### Immediate (P0) - Block v1.0 Release

1. **Fix margin buying power formula** (Bug #1)
   - File: `accounting/policy.py:MarginAccountPolicy.calculate_buying_power()`
   - Use initial margin, not maintenance margin
   - Add unit test: `test_margin_buying_power_correct()`

2. **Fix stop gap-through fill price** (Bug #2)
   - File: `broker.py:_check_fill()`
   - Fill at open when price gaps through stop
   - Add unit test: `test_gap_through_sell_stop()`

3. **Fix commission split on position flip** (Bug #3)
   - File: `broker.py:_execute_fill()`
   - Split commission between close and open
   - Add unit test: `test_commission_split_on_flip()`

4. **Cancel brackets on position flip** (Bug #4)
   - File: `broker.py:_execute_fill()`
   - Cancel all pending orders when position flips
   - Add unit test: `test_position_flip_cancels_brackets()`

5. **Fix gatekeeper position flip validation** (Bug #5)
   - File: `accounting/gatekeeper.py`
   - Simulate close before validating new position

### High Priority (P1) - Before v1.0

6. Add stock split handling
7. Add dividend handling
8. Document margin model limitations in README
9. Handle zero volume bars (VolumeShareSlippage)
10. Add PARTIALLY_FILLED status

### Medium Priority (P2) - Consider for v1.x

11. Futures margin policy (SPAN)
12. T+2 settlement option
13. API consistency improvements
14. Deterministic stop order processing

---

## File Locations

### Review Materials
```
.claude/code_review/251124-02/
‚îú‚îÄ‚îÄ REVIEW_REQUEST.md           # Detailed review questions
‚îú‚îÄ‚îÄ EXTERNAL_REVIEW_BUNDLE.md   # Reviewer guide
‚îú‚îÄ‚îÄ backtest_src.xml            # All source code (33 files)
‚îú‚îÄ‚îÄ opus-01.md                  # Opus review (received)
‚îî‚îÄ‚îÄ gemini-01.md                # Gemini review (received)
```

### Source Files Requiring Changes
```
src/ml4t/backtest/
‚îú‚îÄ‚îÄ broker.py                   # Bugs #2, #3, #4
‚îî‚îÄ‚îÄ accounting/
    ‚îú‚îÄ‚îÄ policy.py               # Bug #1 (critical)
    ‚îî‚îÄ‚îÄ gatekeeper.py           # Bug #5
```

### Documentation
```
README.md                       # Updated (1,134 lines)
.claude/PROJECT_MAP.md          # Current architecture
```

---

## Session Context

**Working Directory**: `/home/stefan/ml4t/software/backtest/`
**Branch**: `feature/phase-1-ml-data-foundation`
**Python Version**: 3.12
**Virtual Environment**: `.venv` (main development)
**Tests**: 154 passing (before fixes)

**Code Quality**:
- Ruff: Passing
- Mypy: 16 errors (relaxed config, not blocking)
- Lines of Code: ~2,800 (source)

**Framework Validation**:
- VectorBT Pro: ‚úÖ EXACT (4/4 scenarios)
- VectorBT OSS: ‚úÖ EXACT (4/4 scenarios)
- Backtrader: ‚úÖ EXACT (4/4 scenarios)
- Zipline: ‚úÖ Within tolerance (4/4 scenarios)

---

## Open Questions

1. **Stock splits**: Should we auto-adjust or require user to provide split data?
2. **Futures**: Should we add FuturesAccountPolicy or document as limitation?
3. **PARTIALLY_FILLED**: Add new status or keep PENDING?
4. **API breaking changes**: Position access style (method vs dict)
5. **Performance**: Is 100k events/sec sufficient for minute bars?

---

## Resources

### External Reviews
- Opus review: 532 lines, comprehensive technical analysis
- Gemini review: 208 lines, correctness-focused

### Reference Implementations
- VectorBT Pro: Vectorized, same-bar, fractional shares
- Backtrader: Event-driven, next-bar, integer shares
- Zipline: Pipeline API, next-bar, volume slippage

### Documentation
- README.md: Complete feature docs (1,134 lines)
- PROJECT_MAP.md: Architecture overview
- REVIEW_REQUEST.md: Specific questions for reviewers (616 lines)

---

## Continuation Instructions

To resume work on fixing the critical bugs:

```bash
cd /home/stefan/ml4t/software/backtest
source .venv/bin/activate

# Start with Bug #1 (most critical)
# File: src/ml4t/backtest/accounting/policy.py
# Function: MarginAccountPolicy.calculate_buying_power()
```

**Suggested workflow**:
1. Fix Bug #1 (margin formula) + add test
2. Run all tests to ensure no regressions
3. Fix Bug #2 (stop gaps) + add test
4. Fix Bug #3 (commission split) + add test
5. Fix Bug #4 (bracket cancellation) + add test
6. Fix Bug #5 (gatekeeper validation) + add test
7. Run validation suite against VectorBT/Backtrader
8. Update README with margin model documentation

---

## Key Insights from Reviews

### What Reviewers Praised
- Clean, minimal codebase (~2,800 lines)
- Protocol-based design (extensible)
- Exit-first processing (correct)
- Framework compatibility presets
- Good documentation
- Impressive validation (EXACT matches)

### What Needs Improvement
- Margin buying power calculation (fundamental math error)
- Stop order edge cases (gap handling)
- Position flip edge cases (commission, brackets)
- Corporate action handling (splits, dividends)
- Zero volume bar handling

### Consensus
"With the P0 fixes applied, this is a solid backtesting engine suitable for daily/hourly equity strategies. The framework compatibility and validation approach sets it apart from many alternatives."

---

*Handoff created at 2025-11-24 19:02:09 UTC*
*Session focus: External code review synthesis and bug identification*
*Next session: Apply P0 bug fixes and add validation tests*
