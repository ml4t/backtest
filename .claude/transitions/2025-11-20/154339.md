# Handoff: 2025-11-20 15:43:39 UTC

## Active Work

Implementing Phase 1 of robust accounting logic for backtest engine - creating accounting infrastructure to support both cash accounts (no leverage, no shorts) and margin accounts (leverage enabled, shorts allowed).

**Current Task**: TASK-003 (Create AccountPolicy interface) - next in sequence
**Work Unit**: `.claude/work/2025-11-20_01_accounting/`

## Current State

### Completed Tasks (Phase 1: 2/5)

**TASK-001**: ✅ Accounting Package Structure (15 min)
- Created `src/ml4t/backtest/accounting/` package
- Files: `__init__.py`, `models.py`, `policy.py`, `account.py`, `gatekeeper.py`
- All files have docstring headers and structure ready

**TASK-002**: ✅ Unified Position Class (30 min)
- Implemented `Position` dataclass in `models.py` (93 lines)
- Supports both long (qty > 0) and short (qty < 0) positions
- Tracks weighted average cost basis (`avg_entry_price`)
- Calculates `market_value` and `unrealized_pnl` properties
- All tests pass (long profit, short profit, short loss scenarios)

### Files Created/Modified

**New files**:
- `src/ml4t/backtest/accounting/__init__.py` (exports for public API)
- `src/ml4t/backtest/accounting/models.py` (Position class - complete)
- `src/ml4t/backtest/accounting/policy.py` (placeholder)
- `src/ml4t/backtest/accounting/account.py` (placeholder)
- `src/ml4t/backtest/accounting/gatekeeper.py` (placeholder)

**Completion reports**:
- `.claude/work/2025-11-20_01_accounting/TASK-001-completion.md`
- `.claude/work/2025-11-20_01_accounting/TASK-002-completion.md`

### Planning Artifacts

**Complete implementation plan** in `.claude/work/2025-11-20_01_accounting/`:
- `requirements.md` - Functional requirements (cash + margin accounts)
- `exploration.md` - Architecture analysis (policy pattern approach)
- `plan.md` - 20 tasks across 4 phases (~20 hours)
- `state.json` - Machine-readable task definitions
- `metadata.json` - Phase breakdown

## Recent Decisions

### Architecture: Policy Pattern for Account Types

**Decision**: Use Strategy/Policy pattern instead of forcing margin accounting on all accounts.

```python
AccountState(cash, positions, policy: AccountPolicy)
  ├── CashAccountPolicy: buying_power = cash, no shorts
  └── MarginAccountPolicy: buying_power = (NLV - MM) / IM, shorts allowed
```

**Rationale**:
- Simpler for cash accounts (no confusing margin calculations)
- Clear user intent (explicit `account_type="cash"` or `"margin"`)
- Extensible (can add portfolio margin, futures margin later)

### Design: Unified Position Class

**Decision**: Single Position class handles both long and short positions.

**Key features**:
- Quantity sign indicates direction (positive=long, negative=short)
- Market value is positive for longs, negative for shorts (liability accounting)
- Unrealized P&L formula: `(current_price - avg_entry_price) * quantity` works for both
- Weighted average cost basis tracked in `avg_entry_price`

### External Review Integration

Received comprehensive architectural review from Gemini (`.claude/code_review/251120-01/gemini_01.md`):
- ✅ Verdict: "Build (Refactor)" - keep custom engine (32x speed advantage)
- ✅ Recommended: Margin Account model (NLV, MM, BP formulas)
- ✅ Recommended: Exit-first sequencing
- ✅ Recommended: Gatekeeper validation pattern
- ⚠️ Adapted: Policy pattern instead of forced margin model (our enhancement)

## Critical Bug Being Fixed

**Line 587 in `engine.py`**:
```python
self.cash += cash_change  # No constraint check! Can go negative!
```

**Impact**: Engine executes ALL orders without validation, allowing unlimited debt (-$652k in tests).

**VectorBT Comparison**:
- Current engine: -$652,580 (broken - executes into massive debt)
- VectorBT: -$3,891 (correct - respects cash limits)
- Difference: 99.4%

**Target**: Fix via Gatekeeper pre-execution validation in Phase 2.

## Next Steps (Immediate)

### TASK-003: Create AccountPolicy Interface (45 min)
**File**: `src/ml4t/backtest/accounting/policy.py`

Create ABC with methods:
```python
class AccountPolicy(ABC):
    @abstractmethod
    def calculate_buying_power(cash, positions) -> float

    @abstractmethod
    def allows_short_selling() -> bool

    @abstractmethod
    def validate_new_position(asset, qty, price, positions, cash) -> (bool, str)
```

### TASK-004: Implement CashAccountPolicy (1 hour)
Implement concrete class:
- `calculate_buying_power()` returns `max(0, cash)`
- `allows_short_selling()` returns `False`
- `validate_new_position()` checks cash >= order_cost

### TASK-005: Write Unit Tests (1 hour)
Create comprehensive tests:
- `tests/accounting/test_position.py`
- `tests/accounting/test_cash_account_policy.py`
- Target: >= 90% coverage for accounting package

## Phase Overview

**Phase 1** (Accounting Infrastructure): 2/5 complete (40%)
- ✅ TASK-001: Package structure
- ✅ TASK-002: Position class
- ⏳ TASK-003: AccountPolicy interface (next)
- ⏳ TASK-004: CashAccountPolicy
- ⏳ TASK-005: Unit tests

**Phase 2** (Cash Account Integration): 0/5 complete
- Broker integration with account_type parameter
- Gatekeeper validation
- Exit-first sequencing
- Update 17 existing tests
- VectorBT validation (fix 99.4% diff)

**Phase 3** (Margin Account Support): 0/6 complete
- MarginAccountPolicy (NLV/BP/MM)
- Short position tracking
- Position reversals
- Margin tests, Bankruptcy Test, Flipping Test

**Phase 4** (Documentation): 0/4 complete
- README updates
- Margin calculations doc
- Architecture decision records
- Final cleanup

## Technical Context

### Current Engine Structure
```
src/ml4t/backtest/
├── engine.py (744 lines) - Main engine, needs integration
└── accounting/ (NEW)
    ├── __init__.py (exports)
    ├── models.py (Position - complete)
    ├── policy.py (placeholder)
    ├── account.py (placeholder)
    └── gatekeeper.py (placeholder)
```

### Test Status
- 17 existing tests in `tests/test_core.py` (all passing currently)
- Validation tests in `tests/validation/` (currently failing - 99.4% diff vs VectorBT)
- New accounting tests will be in `tests/accounting/`

### Key Formulas (for reference)

**Cash Account**:
```
buying_power = max(0, cash)
```

**Margin Account** (Phase 3):
```
NLV = Cash + Σ(position.market_value)
MM = Σ(|position.market_value| × maintenance_rate)
BP = (NLV - MM) / initial_rate
```

**Position Calculations** (implemented):
```
market_value = quantity × current_price
unrealized_pnl = (current_price - avg_entry_price) × quantity
```

## Open Questions

None currently - architecture is clear, plan is approved, implementation proceeding.

## Session-Specific Notes

### Position Class Testing
Verified calculations manually:
- Long 100 @ $150 → $155: market_value=$15,500, pnl=+$500 ✓
- Short -100 @ $150 → $145: market_value=-$14,500, pnl=+$500 ✓
- Short -100 @ $150 → $155: market_value=-$15,500, pnl=-$500 ✓

### Import Testing
Note: Cannot test full package import yet because:
1. Main `__init__.py` tries to import all classes
2. Policy classes not implemented yet (placeholders)
3. Engine.py imports fail due to missing polars in dev environment

This is expected and will resolve as we implement each component.

## Git Status

**Branch**: `feature/phase-1-ml-data-foundation`

**Untracked files**:
- `.claude/work/2025-11-20_01_accounting/` (work unit - don't commit yet)
- `src/ml4t/backtest/accounting/` (new package - ready for commit after Phase 1)

**Strategy**: Commit after each phase completes, not per task.

## Performance Context

**Target**: Maintain 30x+ speed advantage over Backtrader
- Current engine: 32x faster than Backtrader
- Phase 1 overhead: Minimal (simple dataclasses and properties)
- Phase 2 overhead: < 5% expected (validation checks)
- Phase 3 overhead: < 10% expected (margin calculations)

## Success Criteria (Reminder)

**Critical milestones**:
1. ✅ Phase 1 complete: Accounting infrastructure ready
2. ⏳ Phase 2 complete: VectorBT validation within 0.1% (fix 99.4% diff)
3. ⏳ Phase 3 complete: Bankruptcy Test passes (equity >= 0 always)
4. ⏳ Phase 4 complete: Documentation updated

## Continuation Instructions

After `/clear`, resume with:

```
Continue with TASK-003: Create AccountPolicy interface in policy.py
```

Or use workflow command:

```
/workflow:next
```

This will automatically pick up TASK-003 from `state.json`.

---

**Working Directory**: `/home/stefan/ml4t/software/backtest/`
**Active Work Unit**: `2025-11-20_01_accounting`
**Progress**: Phase 1: 2/5 tasks (40%), Overall: 2/20 tasks (10%)
**Estimated Remaining**: ~18 hours (Phase 1: 2.25h, Phase 2: 5.75h, Phase 3: 7.5h, Phase 4: 3h)
