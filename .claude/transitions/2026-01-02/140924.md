# Handoff: 2026-01-02 14:09:24 UTC

## Active Work
VBT Pro trailing stop exact matching validation - achieving framework parity via configuration.

## Current State
**99.3% exact match achieved** (1,015/1,022 trades) with VBT Pro at scale (100 assets, 1000 bars each).

### Key Changes Made This Session
1. **Added `InitialHwmSource` enum** in `config.py` - controls initial HWM on position entry
   - `FILL_PRICE` (default) - use actual fill price with slippage
   - `BAR_CLOSE` - use bar's close price (VBT Pro behavior)

2. **Updated Broker** to accept `initial_hwm_source` parameter

3. **Restored StopFillMode logic** in `TrailingStop` rule:
   - `STOP_PRICE`: Fill at trail level (VBT Pro default)
   - `CLOSE_PRICE`: Fill at bar's close
   - `BAR_EXTREME`: Fill at bar's low/high

4. **Removed HWM update from `_update_time()`** - now only in `_update_water_marks()` called after rule evaluation

## VBT Pro Trailing Stop Configuration (Validated)
```python
from ml4t.backtest import Broker, TrailHwmSource, InitialHwmSource, StopFillMode

broker = Broker(
    trail_hwm_source=TrailHwmSource.HIGH,           # HWM updates from bar HIGH
    initial_hwm_source=InitialHwmSource.BAR_CLOSE,  # Initial HWM = bar close
    stop_fill_mode=StopFillMode.STOP_PRICE,         # Fill at trail level
)
```

## Remaining 7 Mismatches (0.7%)
| Category | Count | PnL Impact |
|----------|-------|------------|
| Exit bar differences | 3 | -$3.97 |
| Price differences (same bar) | 4 | -$29.64 |
| **Total** | **7** | **-$33.61** |

**Root cause**: Floating-point precision edge cases where bar LOW â‰ˆ trail level.
**Total PnL difference**: -$33.61 / -$50,538.44 = **0.0665%**

## Important Principle Enforced
User reminded: **Match frameworks via configuration, NOT hardcoding**. Initial fix hardcoded VBT Pro behavior directly in broker - this was wrong. Now all behaviors are configurable:
- `trail_hwm_source`: HIGH vs CLOSE
- `initial_hwm_source`: FILL_PRICE vs BAR_CLOSE
- `stop_fill_mode`: STOP_PRICE vs CLOSE_PRICE vs BAR_EXTREME

## Files Modified
- `src/ml4t/backtest/config.py` - Added `InitialHwmSource` enum
- `src/ml4t/backtest/__init__.py` - Export `InitialHwmSource`
- `src/ml4t/backtest/broker.py` - Accept and use `initial_hwm_source` parameter
- `src/ml4t/backtest/risk/position/dynamic.py` - Restored StopFillMode logic in TrailingStop
- `.claude/memory/framework_behavior_reference.md` - Updated with configurable approach

## Test Status
- 635 tests passing
- VBT Pro validation: 99.3% match at scale

## Next Steps (if continuing validation work)
1. Consider investigating the 3 exit bar mismatches to understand floating-point edge cases
2. Add VBT Pro preset configuration to `BacktestConfig`
3. Update PROJECT_MAP.md with new configuration options
4. Create similar validation for Backtrader with its specific config

## Session Context
- Working in: `/home/stefan/ml4t/software/backtest`
- Branch: `feature/phase-1-ml-data-foundation`
- VBT Pro venv: `.venv-vectorbt-pro`
- Main venv: `.venv`

## Key Discovery: VBT Pro Trailing Stop Behavior
1. **Initial HWM**: Bar's CLOSE (not fill price with slippage)
2. **HWM Updates**: From bar's HIGH on subsequent bars
3. **HWM Update Timing**: AFTER position rule evaluation (previous bar's HWM used for trigger check)
4. **Trigger Check**: Bar's LOW < trail_level
5. **Fill Price**: Trail level directly (not min/max with close)
