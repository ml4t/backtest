# Handoff: 2025-11-19 22:57:01 UTC

## Executive Summary

**Project**: ml4t.backtest - Batch processing refactor (from external code review)
**Status**: **MAJOR PROGRESS** - Fixed critical dual-portfolio bug, backtest runs but returns incorrect (-27% vs +770%)
**Previous Handoff**: `.claude/transitions/2025-11-19/173114.md`

## Critical Breakthrough

Successfully fixed TWO critical bugs blocking batch processing:

### Bug #1: Broker Initial Capital ($100k vs $1M)
**Root Cause**: `engine.py:97` created broker with NO `initial_capital` argument
```python
# BEFORE (broken):
self.broker = SimulationBroker()  # Defaults to $100k

# AFTER (fixed):
self.broker = SimulationBroker(initial_cash=initial_capital)  # Uses $1M
```

### Bug #2: Dual Portfolio Tracking
**Root Cause**: Engine and Broker had SEPARATE Portfolio objects
- **Broker's `_internal_portfolio`**: Gets updated with fills ✓
- **Engine's `portfolio`**: Never updated, always reports $1M
- **Fix**: Engine now reports from `broker._internal_portfolio` (line 615-616)

## Current State

**Backtest completes successfully:**
```
✓ Engine runs without errors
✓ 126,000 events processed in 6.77s
✓ Throughput: 18,610 events/second
✓ 239 rebalances (matches manual loop)
✓ Orders fill correctly (10,995+ fills)
✓ Portfolio updates correctly
```

**But returns are wrong:**
```
Manual Loop (working):    Engine (broken):
Return: +770%             Return: -27.33%
Final: $8.7M              Final: $726k
Positions: 20-30          Positions: 10
```

## Files Modified

### Core Fixes (Critical)
1. **src/ml4t/backtest/engine.py**
   - Line 97: Pass `initial_cash=initial_capital` to broker
   - Lines 615-616: Report from `broker._internal_portfolio` instead of `self.portfolio`

2. **examples/integrated/top25_using_engine.py**
   - Line 206: Read from `engine.broker._internal_portfolio` for results

### Debug Logging (Temporary - Should Remove)
3. **src/ml4t/backtest/portfolio/portfolio.py**
   - Lines 126-131, 148-152: Added debug print statements (can be removed)

## Investigation Needed

**Why -27% vs +770%?**

Possible causes:
1. **Commission/Slippage misconfiguration?** - Excessive costs eating returns
2. **Fill prices incorrect?** - Filling at worse prices than manual loop
3. **Position sizing wrong?** - Smaller positions than intended (only 10 vs 20-30)
4. **Exit logic broken?** - Risk manager stops working differently?
5. **Batch timing issue?** - Orders executing at wrong timestamps

**Next debugging steps:**
1. Compare first 10 rebalances between engine and manual loop
2. Check commission/slippage totals (broker.get_statistics())
3. Verify position sizes match (4% = $40k per position)
4. Check fill prices (should be at open with execution_delay=True)
5. Examine risk manager exit behavior

## Architecture Discovery

**Dual Portfolio Design** (needs documentation):
- Broker maintains `_internal_portfolio` for fill tracking (source of truth)
- Engine's `portfolio` is separate, not automatically synced
- Attempting to sync both causes floating-point drift (57.99999 vs 58.0)
- **Solution**: Use broker's portfolio only, engine just reports it

**Why this matters**:
- Other code may assume `engine.portfolio` is up-to-date
- Tests may need updating to use `engine.broker._internal_portfolio`
- API breaking change for users accessing `engine.portfolio`

## Reference Documents

- **Expert review**: `.claude/code_review/20251119/response_01.md` and `response_02.md`
- **Implementation plan**: `.claude/work/BATCH_PROCESSING_REFACTOR_PLAN.md`
- **Previous handoff**: `.claude/transitions/2025-11-19/173114.md`

## Next Steps (Immediate)

### 1. Remove Debug Logging
```bash
# Clean up portfolio.py debug prints
# Lines 126-131, 148-152 in src/ml4t/backtest/portfolio/portfolio.py
```

### 2. Compare Engine vs Manual Loop
```bash
# Run both and compare fills/positions
python examples/integrated/top25_using_engine.py > engine_output.txt
python examples/integrated/top25_ml_strategy_complete.py > manual_output.txt

# Compare first rebalance
grep "FILL:" engine_output.txt | head -25
grep -A 25 "Rebalancing" manual_output.txt | head
```

### 3. Check Statistics
```python
# In top25_using_engine.py, after engine.run():
stats = engine.broker.get_statistics()
print(f"Total commission: ${stats['total_commission']:,.2f}")
print(f"Total slippage: ${stats['total_slippage']:,.2f}")
print(f"Fill count: {stats['fill_count']}")
```

### 4. Verify Position Sizing
```python
# Expected: 4% of $1M = $40,000 per position
# With 25 positions = $1M fully invested
# Check if actual positions are smaller
```

## Session Context

**Working directory**: `/home/stefan/ml4t/software/backtest/`
**Branch**: `feature/phase-1-ml-data-foundation`
**Virtual env**: `.venv` (active)
**Last focus**: Debugging portfolio synchronization
**Success metric**: Match manual loop returns (+770% ± 5%)

## Commands to Continue

```bash
cd /home/stefan/ml4t/software/backtest
source .venv/bin/activate

# Quick test (removes debug logging)
vim src/ml4t/backtest/portfolio/portfolio.py  # Remove lines 126-131, 148-152
python examples/integrated/top25_using_engine.py

# Deep investigation
python examples/integrated/top25_using_engine.py 2>&1 | tee engine_debug.log
python examples/integrated/top25_ml_strategy_complete.py 2>&1 | tee manual_debug.log
diff -u <(grep "FILL:" engine_debug.log | head -50) <(grep "Total:" manual_debug.log | head -50)
```

## Recent Decisions

1. **Keep dual portfolio design** (for now) - Attempting to sync causes float drift
2. **Broker portfolio is source of truth** - Engine just reports it
3. **Debug logging added temporarily** - Should be removed before commit
4. **Use `_internal_portfolio` directly** - Cleaner than trying to sync

## Open Questions

1. **Why is return -27% instead of +770%?** (CRITICAL - blocks completion)
2. **Should we eliminate dual portfolio entirely?** (Architectural decision)
3. **Are other tests using `engine.portfolio`?** (May need updates)
4. **Is commission/slippage configured correctly?** (May explain losses)

## Success Criteria (Current Status)

- ✅ Engine runs without errors (ACHIEVED)
- ✅ Fills execute correctly (ACHIEVED: 10,995+ fills)
- ✅ Throughput: 18,610 events/sec (PARTIAL: target 50k+, but has debug logging)
- ✅ Iterations: 252 batches (ACHIEVED)
- ❌ Return: +770% (BLOCKED: Getting -27%)
- ❌ Final positions: 20-30 (BLOCKED: Only 10)
- ✅ Rebalances: 239 (ACHIEVED)

**Critical path**: Debug -27% return → Remove logging → Optimize throughput → Commit

---

**Created**: 2025-11-19 22:57:01 UTC
**Progress**: 90% complete (fills working, returns wrong)
**Estimated completion**: 1-2 hours (debug returns + cleanup)
