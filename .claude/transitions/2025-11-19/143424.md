# Handoff: 2025-11-19 14:34:24 UTC

## Active Work

**Task**: Cross-framework validation - implementing multi-asset adapters and analyzing variance sources

**Context**: User requested 4-way framework comparison (ml4t.backtest, VectorBT, Backtrader, Zipline) to validate execution fidelity at scale (25 stocks, 1 year) and understand EXACT sources of variance.

**Location**: `/home/stefan/ml4t/software/backtest/tests/validation/`

## Current State

### ‚úÖ Completed

1. **Backtrader Multi-Asset Adapter** - FULLY WORKING
   - File: `tests/validation/frameworks/backtrader_adapter.py`
   - Added `_run_multi_asset_with_signals()` method (lines 514-776)
   - Routing logic in `run_with_signals()` detects dict input and routes to multi-asset (lines 276-280)
   - Uses `order_target_value()` for 20% equal weighting per position
   - Uses COC (Cheat-On-Close) for same-bar fills
   - **Result**: 36 trades, $84,233.93 final value, -15.77% return

2. **Zipline Multi-Asset Bundle** - INFRASTRUCTURE COMPLETE
   - File: `tests/validation/bundles/test_data_bundle.py`
   - Added global `_MULTI_ASSET_TEST_DATA` variable
   - Added `set_multi_asset_data()` function for dynamic data injection
   - Updated `ingest()` to handle multiple symbols
   - Fixed pandas compatibility issues (removed `pd.UTC` references)

3. **Zipline Multi-Asset Adapter** - PARTIALLY WORKING
   - File: `tests/validation/frameworks/zipline_adapter.py`
   - Added `_run_multi_asset_with_signals()` method (lines 426-633)
   - Routing logic added (lines 264-268)
   - Dynamic bundle re-ingestion with `set_multi_asset_data()`
   - Trading day filtering using NYSE calendar (lines 471-495)
   - Signal filtering to trading days only (lines 512-514)

4. **3-Way Validation Working**
   - ml4t.backtest: ‚úÖ $84,088.02, 521 trades, -15.91%, 4.4s
   - VectorBT: ‚úÖ $85,231.74, 80 trades, -14.77%, 15.7s
   - Backtrader: ‚úÖ $84,233.93, 36 trades, -15.77%, 5.0s
   - Zipline: ‚ùå Timezone compatibility issue

### ‚ö†Ô∏è Blocking Issues

**Zipline Timezone Issue**:
```
Error: 'datetime.timezone' object has no attribute 'key'
```

**Root Cause**: Zipline expects `pytz` timezone objects but code uses `datetime.timezone.utc`

**Attempted Fixes**:
- ‚úÖ Fixed `pd.UTC` references ‚Üí use timezone check instead
- ‚úÖ Trading day filtering with NYSE calendar
- ‚úÖ Dynamic bundle re-ingestion
- ‚ùå Timezone object compatibility not resolved

**Next Step for Zipline**: Replace all timezone handling to use `pytz.UTC` consistently instead of `datetime.timezone.utc`

## Key Findings - Variance Analysis

### 3-Framework Comparison Results

**Test Configuration**:
- 25 stocks (STOCK00-STOCK24)
- 252 days (2020-01-02 to 2020-09-09)
- 98 signals (49 BUY, 49 SELL)
- 0.1% commission, 0.1% slippage
- Equal-weight portfolio (20% per position, 5 positions max)

**Results**:

| Framework | Final Value | Return | Trades | Time | Status |
|-----------|------------|--------|--------|------|--------|
| ml4t.backtest | $84,088.02 | -15.91% | 521 | 4.4s | ‚úÖ |
| VectorBT | $85,231.74 | -14.77% | 80 | 15.7s | ‚úÖ |
| Backtrader | $84,233.93 | -15.77% | 36 | 5.0s | ‚úÖ |

**Variance**: $1,143.72 (1.14% of initial capital)

### Variance Source Hypothesis

**Primary Driver: Trade Count Differences**

1. **ml4t.backtest: 521 trades**
   - 6.5x more than VectorBT (80 trades)
   - 14.5x more than Backtrader (36 trades)
   - Appears to be rebalancing positions continuously
   - Each rebalance incurs commission (0.1%)

2. **VectorBT: 80 trades**
   - Signal-based execution only
   - Some rebalancing but minimal

3. **Backtrader: 36 trades**
   - Minimal rebalancing
   - Closest to signal count (98 signals ‚Üí 36 trades suggests ~50% fill rate)

**Estimated Cost Impact**:
- Extra 441 trades (521 - 80) √ó ~$1,000 avg trade √ó 0.1% commission = ~$441
- This explains significant portion of $1,143.72 variance

**Remaining Questions**:
1. WHY does ml4t.backtest rebalance so much more?
2. Are the extra trades legitimate rebalancing or a bug?
3. What's the EXACT price/timing difference on matching trades?

### User Requirements (Not Yet Met)

**User explicitly requested**:
> "We need to know EXACTLY where it comes from. For this, you need to compare the trades - different entry times, different prices? fees, slippage? Need to know EXACTLY why."

**What's needed**:
1. ‚úÖ Trade count comparison (done)
2. ‚ùå Trade-by-trade price comparison (not done)
3. ‚ùå Trade-by-trade timing comparison (not done)
4. ‚ùå Cumulative cost analysis (fees + slippage) (not done)
5. ‚ùå Identify systematic differences (always early/late?) (not done)

**Blocker**: Attempted to create analysis script (`tests/validation/analyze_variance.py`) but hit import issues. Need proper pytest-based approach.

## Recent Decisions

### Decision 1: Use 3-Way Validation (Drop Zipline Temporarily)
**Context**: Zipline has persistent timezone/calendar issues requiring deeper refactoring
**Decision**: Proceed with ml4t.backtest + VectorBT + Backtrader for variance analysis
**Rationale**: 3 frameworks sufficient to identify variance sources; Zipline can be fixed separately
**Status**: Accepted by necessity (Zipline 1-2 hours estimated to fix)

### Decision 2: Multi-Asset Bundle Architecture
**Context**: Zipline bundle originally only supported AAPL single-asset
**Decision**: Use global variable + `set_multi_asset_data()` for dynamic data injection
**Rationale**: Simpler than creating/managing multiple bundle versions
**Status**: Implemented and working (bundle ingestion successful)

### Decision 3: Trading Day Filtering
**Context**: Synthetic test data has 252 days (includes weekends), Zipline expects 174 NYSE trading days
**Decision**: Filter data to NYSE trading days before ingestion using `get_calendar('NYSE')`
**Rationale**: Match Zipline's calendar expectations
**Status**: Implemented, resolves "expected 174 rows" error

### Decision 4: Variance Threshold for Multi-Asset
**Context**: Single-asset tests achieve 0.03% variance, multi-asset showing 1.14%
**Decision**: Defer threshold decision until trade-by-trade analysis complete
**Proposal**: Accept 1.5% for multi-asset tests (vs 0.5% for single-asset)
**Status**: Pending user approval after variance source identified

## Next Steps (Immediate Priority)

### Step 1: Extract Trade Logs for Exact Comparison (CRITICAL)

**Why**: User explicitly requested trade-by-trade analysis to find EXACT variance source

**Approach**:
```python
# Modify test to dump trades to files
results = {}
for name, adapter in adapters.items():
    result = adapter.run_with_signals(test_data, signals, config)
    results[name] = result

    # Save trades to CSV for analysis
    trades_df = pd.DataFrame([
        {
            'timestamp': t.timestamp,
            'action': t.action,
            'quantity': t.quantity,
            'price': t.price,
            'value': t.value,
            'commission': t.commission,
        }
        for t in result.trades
    ])
    trades_df.to_csv(f'trades_{name}.csv', index=False)
```

**Then analyze**:
1. Load all 3 trade CSVs
2. Match trades by timestamp (or closest timestamp)
3. Compare prices, quantities, commissions
4. Identify systematic differences

**Files to modify**:
- `tests/validation/test_integrated_framework_alignment.py` - add trade export after line 395

### Step 2: Investigate ml4t.backtest Rebalancing Logic

**Why**: 521 trades vs 80 (VectorBT) suggests excessive rebalancing

**Investigation**:
1. Check `tests/validation/frameworks/qengine_adapter.py:494-545` - RotationStrategy logic
2. Verify position sizing: `target_value = portfolio_value * 0.20` (line 523)
3. Check if strategy rebalances on EVERY bar vs only on signals
4. Compare to VectorBT's `from_signals()` approach (signal-driven only)

**Hypothesis**: ml4t.backtest may be:
- Rebalancing to maintain 20% per position as portfolio value changes
- Executing on every bar instead of signal-only
- Has continuous rebalancing logic not present in VectorBT

**Test**: Modify strategy to ONLY trade on signals (no rebalancing between signals)

### Step 3: Fix Zipline Timezone Issue (1-2 hours)

**File**: `tests/validation/frameworks/zipline_adapter.py`

**Changes needed**:
```python
# Replace datetime.timezone usage with pytz
import pytz

# Instead of:
if df.index.tz is None:
    df.index = df.index.tz_localize('UTC')
else:
    df.index = df.index.tz_convert('UTC')

# Use:
if df.index.tz is None:
    df.index = df.index.tz_localize(pytz.UTC)
else:
    df.index = df.index.tz_convert(pytz.UTC)
```

**Also check**: `tests/validation/bundles/test_data_bundle.py` for similar issues

### Step 4: Document Variance Findings

**File**: Create `tests/validation/VARIANCE_ANALYSIS.md`

**Contents**:
1. Trade-by-trade comparison table
2. Price/timing differences
3. Commission/slippage breakdown
4. Root cause identification with code citations
5. Recommendations for alignment (if desired)

### Step 5: Update Validation Status

**File**: `tests/validation/INTEGRATED_VALIDATION_STATUS.md`

**Add**:
- 3-way validation results
- Variance analysis summary
- Trade count investigation findings
- Zipline status (partial - needs timezone fix)

## Files Modified This Session

### Created
1. `tests/validation/analyze_variance.py` - Variance analysis script (incomplete - import issues)

### Modified
1. `tests/validation/frameworks/backtrader_adapter.py`
   - Added `_run_multi_asset_with_signals()` (lines 514-776)
   - Added routing logic (lines 276-280)

2. `tests/validation/frameworks/zipline_adapter.py`
   - Added `_run_multi_asset_with_signals()` (lines 426-633)
   - Added routing logic (lines 264-268)
   - Added trading day filtering (lines 471-495, 512-514)
   - Fixed import path: `zipline.utils.calendar_utils.get_calendar`

3. `tests/validation/bundles/test_data_bundle.py`
   - Added `_MULTI_ASSET_TEST_DATA` global variable
   - Added `set_multi_asset_data()` function
   - Updated `load_test_data()` to support multi-asset
   - Updated `ingest()` to handle multiple symbols
   - Fixed pandas compatibility (removed `pd.UTC` checks)

## Test Results This Session

**Command**: `pytest tests/validation/test_integrated_framework_alignment.py::TestIntegratedFrameworkAlignment::test_all_frameworks_alignment -xvs`

**Results**:
```
ml4t.backtest   $  84,088.02  -15.91%  521  4.4s   ‚úÖ
VectorBT        $  85,231.74  -14.77%   80 15.7s   ‚úÖ
Backtrader      $  84,233.93  -15.77%   36  5.0s   ‚úÖ
Zipline         ERROR (timezone)                    ‚ùå

Variance: $1,143.72 (1.14%)
FAILED: Value variance 1.1437% exceeds 0.5% threshold
```

## Critical Code Patterns

### Multi-Asset Adapter Pattern

**Routing in `run_with_signals()`**:
```python
def run_with_signals(
    self,
    data: pd.DataFrame | dict[str, pd.DataFrame],
    signals: pd.DataFrame,
    config: FrameworkConfig | None = None,
) -> ValidationResult:
    # Check if multi-asset (dict) or single-asset (DataFrame)
    is_multi_asset = isinstance(data, dict)

    if is_multi_asset:
        return self._run_multi_asset_with_signals(data, signals, config)

    # Single-asset path (original logic)
    ...
```

### Zipline Bundle Dynamic Data Injection

```python
# In bundle file
_MULTI_ASSET_TEST_DATA = None

def set_multi_asset_data(data_dict):
    global _MULTI_ASSET_TEST_DATA
    _MULTI_ASSET_TEST_DATA = data_dict

def load_test_data():
    global _MULTI_ASSET_TEST_DATA
    if _MULTI_ASSET_TEST_DATA is not None:
        return _MULTI_ASSET_TEST_DATA
    # ... fallback to AAPL

# In adapter
from bundles.test_data_bundle import set_multi_asset_data
set_multi_asset_data(prepared_data)
ingest('test_data', show_progress=False)  # Re-ingest with new data
```

### Trading Day Filtering (Zipline)

```python
from zipline.utils.calendar_utils import get_calendar

nyse_calendar = get_calendar('NYSE')
trading_days = nyse_calendar.sessions_in_range(
    df.index[0],
    df.index[-1]
)
df_filtered = df[df.index.isin(trading_days)]
```

## Important Context for Next Session

### User's Core Requirements

1. **"Figure out how to make Zipline work"**
   - We maintain the package, can't say "don't know how"
   - Status: 90% done, timezone issue remaining

2. **"Need to know EXACTLY where variance comes from"**
   - Not acceptable: "Different trade counts explain it"
   - Required: Trade-by-trade price/timing/cost comparison
   - Status: Hypothesis formed, detailed analysis NOT done

### What User Will Likely Ask

1. **"Show me the exact trades side-by-side"**
   - Need: CSV exports of all trades from 3 frameworks
   - Need: Matched comparison showing price differences
   - Ready: Trade export code pattern

2. **"Why does ml4t.backtest have 6.5x more trades?"**
   - Need: Code citation showing rebalancing logic
   - Need: Explanation of when rebalancing triggers
   - Ready: File locations identified

3. **"Is the 1.14% variance acceptable?"**
   - Need: Trade-by-trade cost breakdown
   - Need: Systematic difference identification
   - Ready: 3 frameworks working for comparison

### Key Files for Next Session

**To analyze**:
- `tests/validation/frameworks/qengine_adapter.py:494-545` - ml4t.backtest strategy logic
- `tests/validation/frameworks/vectorbt_adapter.py:477-706` - VectorBT multi-asset (working)
- `tests/validation/frameworks/backtrader_adapter.py:514-776` - Backtrader multi-asset (working)

**To modify**:
- `tests/validation/test_integrated_framework_alignment.py` - Add trade export
- `tests/validation/frameworks/zipline_adapter.py` - Fix timezone (pytz vs datetime.timezone)
- `tests/validation/bundles/test_data_bundle.py` - Fix timezone (pytz vs datetime.timezone)

**To create**:
- `tests/validation/VARIANCE_ANALYSIS.md` - Detailed findings
- Trade CSV files for comparison (`trades_qengine.csv`, `trades_vectorbt.csv`, `trades_backtrader.csv`)

## Background Processes

**Note**: There are 3 background bash processes running from earlier in session:
- `207f28` - ML strategy example (likely failed/completed)
- `ad104e` - Benchmark test (likely completed)
- `60cc5a` - Benchmark test (likely completed)

**Action**: Can safely ignore or kill these processes - not related to current validation work

## Questions Left Open

1. **Trade count difference**: Is ml4t.backtest's 521 trades a bug or feature?
   - VectorBT: 80 trades
   - Backtrader: 36 trades
   - Is continuous rebalancing intended?

2. **Variance threshold**: Accept 1.5% for multi-asset?
   - Single-asset: 0.5% threshold (achieved 0.03%)
   - Multi-asset: Seeing 1.14% with 3 frameworks
   - User decision pending

3. **Zipline priority**: Fix now or defer?
   - Estimated 1-2 hours to fix timezone
   - 3 frameworks already working
   - User wants all 4 working

4. **Rebalancing logic**: Should frameworks align?
   - ml4t.backtest rebalances continuously
   - VectorBT/Backtrader signal-only
   - Which behavior is "correct"?

## Session Quality

**Achievements**: üéØ Strong
- ‚úÖ Backtrader multi-asset complete
- ‚úÖ Zipline bundle infrastructure complete
- ‚úÖ 3-way validation working
- ‚úÖ Variance hypothesis identified

**Blockers**: ‚ö†Ô∏è 2 critical items
1. Trade-by-trade analysis not completed (user explicitly requested)
2. Zipline timezone issue (1-2 hours estimated)

**User Satisfaction**: Medium
- Appreciated honest approach ("we maintain it, must fix")
- Wants EXACT variance sources, not just hypotheses
- Expects detailed trade comparison

**Next Session Priority**: CRITICAL - Extract and compare trades to satisfy user's explicit requirement for exact variance analysis

---

**To continue this work**:
1. Run `/clear` to reset conversation context
2. Say: `continue from .claude/transitions/2025-11-19/143424.md`
3. First task: Extract trade logs and do side-by-side comparison
