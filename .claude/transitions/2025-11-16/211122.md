# Handoff: 2025-11-16 21:11:22 UTC

## Active Work

**Cross-framework validation for realistic daily backtesting** - Achieving <0.1% variance across ml4t.backtest, VectorBT, Backtrader, and Zipline by fixing systematic execution differences.

**User requirement**: "We need to get this right. For daily data, there is literally no other way [than next bar's open]."

## Current State

### âœ… MAJOR BREAKTHROUGH: ml4t.backtest â†” VectorBT Perfect Alignment

**Trade #1 Results (2020-04-08)**:
- **ml4t.backtest**: 1522.418 shares @ $65.685 âœ“ CORRECT
- **VectorBT**: 1522.418 shares @ $65.685 âœ“ PERFECT MATCH
- **Backtrader**: 1500.000 shares @ $66.518 âœ— (2 issues remaining)
- **Zipline**: 1541.000 shares @ $66.518 âœ— (3 issues remaining)

**Expected next-bar open price**: $65.685 (2020-04-08 open)
**ml4t.backtest and VectorBT**: EXACT match on price and quantity!

### Files Modified This Session

**Core Engine (ml4t.backtest)**:
1. `src/ml4t/backtest/execution/broker.py`:
   - Lines 611-622: Move pendingâ†’open to START of event (Fix #1)
   - Lines 628-635: Use event.open when execution_delay=True (Fix #2)
   - Lines 648-655: Pass event.open as close param to fill_simulator (Fix #3)

2. `tests/validation/common/engine_wrappers.py`:
   - Line 344: Changed `execution_delay=False` â†’ `execution_delay=True`

3. `tests/validation/frameworks/qengine_adapter.py`:
   - Line 280: Set `execution_delay_days=0` (broker handles delay internally)

**Framework Adapters**:
4. `tests/validation/frameworks/vectorbt_adapter.py`:
   - Lines 310-311: Fixed price selection (use open without shift after signal shift)

**Analysis Tools**:
5. `tests/validation/detailed_trade_comparison.py`: NEW
   - Trade-by-trade comparison (all 67 trades)
   - Shows price, quantity, net cash impact differences
   - Correctly calculates value as qty*price (framework 'value' field unreliable)

**Documentation**:
6. `tests/validation/SYSTEMATIC_DIFFERENCES_ANALYSIS.md`: NEW
   - Root cause analysis of 2.4% variance
   - Three critical issues identified (fractional shares, fill prices, margin)

7. `tests/validation/NEXT_OPEN_FIX_DESIGN.md`: NEW
   - Technical design for next-open fills
   - Execution flow diagrams (before/after)
   - Implementation plan

8. `tests/validation/PROGRESS_REPORT.md`: NEW
   - Current status summary
   - Issues fixed vs remaining
   - Next steps

## Recent Decisions

### AD-007: ml4t.backtest Must Fill at Next Bar's Open (Not Close)
**Date**: 2025-11-16
**Status**: Implemented
**Context**: For daily data, filling at same bar's close introduces look-ahead bias. Industry standard is next bar's open.

**Root Causes Fixed**:
1. **Double delay**: Orders went Tâ†’T+2 instead of Tâ†’T+1
   - Pending orders were moved to open at END of event
   - Fixed by moving them at START (broker.py:611-622)

2. **Wrong fill price**: Filled at CLOSE instead of OPEN
   - `event.close` used for price determination
   - Fill simulator received `close=event.close` parameter
   - Fixed by using `event.open` when execution_delay=True (broker.py:628-635, 648-655)

3. **External signal shifting conflict**:
   - Signals shifted +1 day externally AND broker delayed +1 bar = T+2
   - Fixed by disabling external shift (qengine_adapter.py:280)

**Result**: ml4t.backtest now fills at next bar's open (industry standard)

### AD-008: VectorBT Signal/Price Coordination
**Date**: 2025-11-16
**Status**: Fixed
**Problem**: VectorBT was shifting signals forward AND prices backward, canceling out
**Solution**: After shifting signals, use prices WITHOUT shift (vectorbt_adapter.py:310-311)
**Result**: VectorBT now matches ml4t.backtest exactly

### AD-009: Trade Value Calculation Standardization
**Date**: 2025-11-16
**Status**: Documented
**Finding**: Framework 'value' field has different meanings:
- Backtrader: Uses `closedvalue` (cost basis, not proceeds)
- Others: Use actual transaction value

**Solution**: Always calculate value as `quantity * price` in comparison scripts
**Implementation**: detailed_trade_comparison.py:62

## Active Challenges

### Challenge #1: Backtrader Fill Price (In Progress)

**Symptom**: Fills at $66.518 (close) instead of $65.685 (open)

**Current config**:
```python
FrameworkConfig.for_zipline_matching():
    fill_timing="next_open"
    backtrader_coc=True  # Cheat-on-Close enabled
```

**Hypothesis**: Backtrader COC may be executing on shifted signal bar's close, not open

**Investigation needed**:
1. Check Backtrader source: `resources/backtrader-master/backtrader/`
2. Verify what price COC uses when order placed end-of-day
3. May need different Backtrader configuration or adapter logic

**Files**: `tests/validation/frameworks/backtrader_adapter.py`

### Challenge #2: Backtrader Fractional Shares

**Symptom**: 1500.000 shares (integer) instead of 1522.418 (fractional)

**Current config**: `fractional_shares=True` in FrameworkConfig (not working)

**Investigation needed**:
1. Search Backtrader source for "fractional" or "decimals"
2. Check if Backtrader supports fractional shares at all
3. If not supported, document limitation and adjust test expectations

**Alternative**: If unsupported, may need to use slightly different capital amounts for Backtrader to compensate

### Challenge #3: Zipline Fill Price

**Symptom**: Fills at $66.518 (close) instead of $65.685 (open)

**Hypothesis**: Zipline's `handle_data()` may be designed to fill at close (T+1 close instead of T+1 open)

**Investigation needed**:
1. Read Zipline source: `resources/zipline-reloaded-main/src/zipline/`
2. Check `finance/execution.py` and `TradingAlgorithm`
3. Verify if custom execution can specify open prices

**Files**: `tests/validation/frameworks/zipline_adapter.py`

### Challenge #4: Zipline Margin/Leverage

**Symptom**: Spending $102,504 with only $100k capital (2.5% leverage)

**Root cause**: Zipline may have margin enabled by default

**Fix needed**:
```python
# In TradingAlgorithm.initialize():
context.set_leverage(1.0)  # No leverage
```

**Files**: `tests/validation/frameworks/zipline_adapter.py`

### Challenge #5: Zipline Fractional Shares

**Symptom**: 1541.000 shares (integer) instead of 1522.418 (fractional)

**Investigation needed**: Check if Zipline supports fractional shares and how to enable

## Next Steps (Prioritized)

### Immediate (Next Session)

1. **Fix Backtrader fill price**
   - Read Backtrader source code for COC behavior
   - Test different configurations (COO vs COC)
   - May need to adjust signal timing or adapter logic
   - **Goal**: Match $65.685 open price

2. **Investigate Backtrader fractional shares**
   - Search source for fractional share support
   - If unsupported, document as framework limitation
   - **Goal**: Either enable or document workaround

3. **Fix Zipline margin**
   - Add `set_leverage(1.0)` to TradingAlgorithm
   - **Goal**: Prevent spending more than available capital

4. **Fix Zipline fill price**
   - Read Zipline execution model in source code
   - Determine if next-open fills possible
   - **Goal**: Match $65.685 open price

5. **Investigate Zipline fractional shares**
   - Check configuration options
   - **Goal**: Enable fractional shares if supported

### Verification (After Fixes)

6. **Run full 67-trade comparison**
   ```bash
   cd /home/stefan/ml4t/software/backtest/tests/validation
   uv run python detailed_trade_comparison.py > final_results.txt 2>&1
   ```

7. **Verify cumulative variance <0.1%**
   - Check final portfolio values
   - Confirm all frameworks within tolerance
   - **Goal**: <$100 difference on $200k final value

8. **Document final configuration**
   - Update SYSTEMATIC_DIFFERENCES_ANALYSIS.md with solutions
   - Create FINAL_VALIDATION_RESULTS.md
   - Update FrameworkConfig presets if needed

## Session Context

**Working Directory**: `/home/stefan/ml4t/software/backtest/tests/validation/`

**Test Data**: `signals/sp500_top10_sma_crossover.pkl`
- Asset: AAPL
- Signal on 2020-04-07 (entry=True)
- Expected fill: 2020-04-08 at open ($65.685)
- 34 entry signals, 33 exit signals
- Test period: 2020-01-02 to 2025-11-14

**Configuration**: `FrameworkConfig.for_zipline_matching()`
```python
{
    "fill_timing": "next_open",
    "commission_pct": 0.0,
    "slippage_pct": 0.0,
    "fractional_shares": True,
    "backtrader_coc": True,
    "close_final_position": False,
}
```

**Test Command**:
```bash
cd /home/stefan/ml4t/software/backtest/tests/validation
uv run python detailed_trade_comparison.py
```

**Framework Source Code Locations** (for investigation):
- Backtrader: `resources/backtrader-master/backtrader/`
- VectorBT: `resources/vectorbt/vectorbt/`
- VectorBT Pro: `resources/vectorbt.pro-main/vectorbtpro/`
- Zipline: `resources/zipline-reloaded-main/src/zipline/`

## Key Learnings (Permanent)

### Execution Timing for Daily Data

**Industry Standard**: Signal on day T â†’ Fill on day T+1 at OPEN
- Most realistic point for market orders
- Next bar's open is first available price after signal
- Close-on-close fills introduce look-ahead bias

**Implementation**:
- Enable `execution_delay=True` in broker
- Move pending orders to open at START of event (not end)
- Use `event.open` for fill price when delay enabled
- Pass `event.open` as `close` parameter to fill_simulator

### Framework-Specific 'Value' Field Semantics

**Critical**: Don't trust framework's 'value' field for comparisons!

**Backtrader**: `order.executed.value = closedvalue + openedvalue`
- For SELL: `closedvalue` is original cost basis (not proceeds!)
- Misleading for P&L calculations

**Solution**: Always calculate value as `quantity * price` in validation scripts

### Signal Shifting vs Broker Delay

**Don't do both!**
- If broker has `execution_delay=True`, signals should NOT be shifted
- Shifting signals + broker delay = double delay (Tâ†’T+2)
- Choose one approach and stick with it

**Recommendation**: Use broker's `execution_delay` (cleaner, less error-prone)

## Tools & Commands

**Run trade comparison**:
```bash
cd /home/stefan/ml4t/software/backtest/tests/validation
uv run python detailed_trade_comparison.py
```

**Check specific framework source**:
```bash
# Backtrader COC implementation
grep -rn "cheat.*close\|coc" resources/backtrader-master/backtrader/

# Zipline execution model
grep -rn "handle_data\|order.*fill" resources/zipline-reloaded-main/src/zipline/finance/
```

**Verify test data**:
```bash
uv run python -c "
import pickle
with open('signals/sp500_top10_sma_crossover.pkl', 'rb') as f:
    data = pickle.load(f)
print('First signal:', data['assets']['AAPL']['signals'].loc['2020-04-07'])
print('Open on 2020-04-08:', data['assets']['AAPL']['data'].loc['2020-04-08', 'open'])
"
```

## References

**Zero Tolerance Policy**: NEVER say "I don't know" about framework behavior - all source code is available locally in `resources/`

**Mandatory Investigation Protocol**:
1. Search for relevant code: `grep -rn "keyword" resources/framework/`
2. Read the implementation: `Read resources/framework/relevant_file.py`
3. Cite specific files and line numbers
4. Explain the exact implementation difference with code evidence
5. Document findings in validation report

**Framework Source Files** (key locations):
- Backtrader broker: `resources/backtrader-master/backtrader/brokers/bbroker.py`
- Backtrader orders: `resources/backtrader-master/backtrader/order.py`
- VectorBT portfolio: `resources/vectorbt/vectorbt/portfolio/base.py`
- VectorBT execution: `resources/vectorbt/vectorbt/portfolio/nb/from_signals.py`
- Zipline execution: `resources/zipline-reloaded-main/src/zipline/finance/execution.py`
- Zipline algorithm: `resources/zipline-reloaded-main/src/zipline/algorithm.py`

---

## Status Summary

**âœ… Completed**: ml4t.backtest and VectorBT now perfectly aligned on next-open fills
**â³ In Progress**: Fixing Backtrader and Zipline to match
**ðŸŽ¯ Goal**: <0.1% variance across all 4 frameworks
**ðŸ“Š Progress**: 50% complete (2/4 frameworks validated)

**Next agent should**: Continue with Backtrader investigation (COC behavior + fractional shares), then Zipline (margin + execution timing + fractional shares).
