# Handoff Document - 2025-11-04 23:59:00

**From**: Session - Attempted fill price fix (INCORRECT)
**To**: Next Session - Investigate actual VectorBT behavior
**Context**: ~110K tokens
**Date**: 2025-11-04 23:59:00 UTC

---

## Critical Learning: Don't Trust Existing Reports

### ðŸš¨ Key Mistake Made

**What I Did**:
- Read `.claude/transitions/2025-11-04/234500.md` which stated:
  - "VectorBT uses `open + slippage` for entries"
  - "ml4t.backtest uses `close` for entries"  
  - "$7 difference on first trade"
- Implemented "fix" to make ml4t.backtest use `open` for entries
- Committed changes

**What User Corrected**:
> "Do not trust any report you find. I believe vectorbt uses close by default - or whatever price is provided for the 'close' or 'price' argument of .from_signals()"

**Result of "Fix"**:
- Before: 462 trades, +$5,423 PnL
- After: 4,681 trades, +$240,244 PnL (10x more trades!)
- Something went very wrong

### What Actually Happened

**VectorBT Configuration** (from `vectorbt_wrapper.py:155-172`):
```python
pf = vbt.Portfolio.from_signals(
    close=ohlcv_adjusted["close"],  # â† Provided
    open=ohlcv_adjusted["open"],    # â† Also provided
    high=ohlcv_adjusted["high"],
    low=ohlcv_adjusted["low"],
    entries=signals_adjusted,
    fees=0.0002,
    slippage=0.0002,
    ...
)
```

**Question**: When both `close` and `open` are provided, which does VectorBT use for fills?
**User's Answer**: Close (by default)

---

## Changes Made and Reverted

### Attempted Fix (REVERTED)

**Modified Files**:
1. `src/ml4t.backtest/execution/fill_simulator.py:111-185`
   - Added `open` parameter to `try_fill_order()`
   - Added entry/exit detection logic
   - Used `open` for entries, `close` for exits

2. `src/ml4t.backtest/execution/broker.py:548-816`
   - Added `open=event.open` to 4 `try_fill_order()` calls

**Commit**: `d59745f` "fix: Use open price for entry fills (VectorBT compatibility)"

**Reversion**:
- Manually reverted both files back to original state
- Removed `open` parameter and entry/exit logic
- All tests pass (49 tests, 35% coverage)

---

## Next Steps

### Priority 1: Verify VectorBT's Actual Fill Behavior

**Need to Determine**:
1. When both `close` and `open` are provided to `from_signals()`, which price is used?
2. Is slippage applied to the fill price?  
3. Are exits treated differently than entries?

**Approaches**:
1. **Read VectorBT Source**: Check `/home/stefan/ml4t/software/backtest/resources/vectorbt.pro-main/vectorbtpro/portfolio/nb/from_signals.py`
2. **Empirical Test**: Create minimal test with known OHLC and check actual fill prices
3. **Compare First Trade**: Look at actual OHLC data at first signal timestamp and see which price matches VectorBT's fill

### Priority 2: Compare First Trade Carefully

**From Previous Validation** (needs verification):
- Signal timestamp: 2021-02-03 22:31:00-06:00
- VectorBT entry: $37,632.53
- ml4t.backtest entry: $37,625.00 (before "fix")

**Calculate What Each Price Model Would Give**:
- If close = $37,625:
  - close + 0.02% slippage = $37,625 * 1.0002 = $37,632.525 â‰ˆ $37,632.53 âœ“
- If open = $37,XXX:
  - Need to check actual open price at that timestamp

**This suggests VectorBT uses close + slippage, not open!**

### Priority 3: Understand the 117 Missing Trades Issue

**Original Problem** (from 234500.md handoff):
- VectorBT: 579 trades
- ml4t.backtest: 462 trades  
- 117 fewer trades (20%)

**Hypothesis**: Re-entry logic or position tracking differences
**Need to Investigate**:
1. Compare trade timestamps side-by-side
2. Identify pattern: When does ml4t.backtest skip trades?
3. Check `allow_immediate_reentry` setting
4. Verify position state after exits

---

## Files to Investigate

### VectorBT Source
- `/home/stefan/ml4t/software/backtest/resources/vectorbt.pro-main/vectorbtpro/portfolio/nb/from_signals.py`
  - Lines ~1000-1020: Fill price determination
  - Search for where `close` vs `open` is selected

### Validation Scripts
- `/home/stefan/ml4t/software/projects/crypto_futures/scripts/validate_single_signal.py`
  - Currently uses: `scripts/validate_single_signal.py`
  - Should print OHLC values at first signal for manual verification

### Configuration
- `/home/stefan/clients/wyden/long-short/development/ml-strategies/baseline/backtest_pipeline/vectorbt_wrapper.py:155-172`
  - Actual VectorBT configuration used in production

---

## Current State

**Code Status**: Reverted to baseline (uses `close` for all fills)
**Tests**: âœ… All 49 tests passing
**Validation**: Need to re-run baseline to confirm behavior

**Key Files**:
- `src/ml4t.backtest/execution/fill_simulator.py` - Fill price logic (REVERTED)
- `src/ml4t.backtest/execution/broker.py` - Broker integration (REVERTED)

---

## Questions for Next Session

1. **Fill Price**: Does VectorBT actually use `close` by default, even when `open` is provided?
2. **Slippage**: Is 0.02% slippage applied to the fill price? (Seems yes based on $37,625 â†’ $37,632.53)
3. **Trade Count**: Why 462 vs 579 trades? Same-bar re-entry issue?
4. **Exits**: Do bracket orders (TP/SL/TSL) use different pricing logic?

---

## Lessons Learned

1. **Don't trust existing reports** - Always verify claims against actual code/data
2. **Test incrementally** - Should have validated "fix" matched expected behavior before committing
3. **Empirical verification** - Compare actual OHLC prices with fill prices to determine logic
4. **User knowledge > documentation** - User correctly identified the issue

---

**Created**: 2025-11-04 23:59:00 UTC
**Next Action**: Verify VectorBT fill price behavior empirically
**Key Insight**: VectorBT likely uses `close` + slippage, not `open`

