### **1) Executive Summary**

* **Library under review:** Backtesting (QEngine)
* **One-paragraph overview:** QEngine is a sophisticated, event-driven backtesting framework designed as a modern
  replacement for the Quantopian stack. It features a highly modular architecture built around a central `Clock` and
  `EventBus`, aiming for high realism and performance using Polars for data handling. The library boasts extensive
  support for multi-asset trading (Equities, Futures, Options, FX, Crypto), comprehensive execution modeling (slippage,
  commission, market impact), detailed corporate action processing, and robust reporting capabilities. While the
  component design is excellent, critical integration flaws currently prevent the engine from functioning correctly.

* **Top 5 strengths:**
    * Highly modular architecture with excellent separation of concerns (Data, Execution, Strategy, Portfolio).
    * Comprehensive and sophisticated suite of execution realism models (Slippage, Commission, and advanced Market
      Impact models like Almgren-Chriss).
    * Strong multi-asset support formalized in `AssetSpec`, covering complex P&L and margin requirements for
      derivatives.
    * Detailed handling of corporate actions (splits, dividends, mergers), including adjustments to open orders and
      positions.
    * High code quality utilizing modern Python features (type hints, dataclasses, enums) and efficient libraries (
      Polars).

* **Top 5 risks/defects or gaps:**
    * **[P0] Broken Engine Orchestration:** Critical integration flaws exist in `BacktestEngine`. The Broker is not
      subscribed to Market events, and Fills generated by the Broker are not published back to the EventBus, rendering
      the engine non-functional.
    * **[P0] Strategy Initialization Mismatch:** The `BacktestEngine` calls `Strategy.on_start` with arguments not
      supported by the base `Strategy` definition, leading to runtime failures.
    * **[P0] Lookahead Bias (Zero Latency):** The event loop design allows strategies to react and the broker to fill
      orders using the price from the *same* market event, implying zero latency and introducing significant lookahead
      bias.
    * **[P0] Flawed Clock Synchronization:** The logic for merging multiple data feeds (`Clock._replenish_queue`) is
      incorrect, leading to potential chronological errors when using multiple data sources.
    * **[P1] Domain Correctness Errors:** PnL calculations for Options contain specific errors (using intrinsic value
      instead of premium change), and a bug exists allowing negative fill quantities when cash is low.

* **Overall recommendation:** Needs immediate fixes before use. QEngine has an exceptionally strong foundation and
  feature set. However, the critical P0 flaws in engine orchestration, initialization, execution timing, and clock
  synchronization must be addressed immediately before the library can execute simulations or be relied upon for
  accuracy.

### **2\) Inventory of Files and Modules**

| Path                                           | Key Types/Functions/Classes                              | Primary Purpose                                                                 | Notes (mocked/placeholders, TODOs, duplication)                                                                                | Status (works / partial / broken) |
|:-----------------------------------------------|:---------------------------------------------------------|:--------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------|:----------------------------------|
| **Engine & Core**                              |                                                          |                                                                                 |                                                                                                                                |                                   |
| src/qengine/engine.py                          | `BacktestEngine`, `BacktestResults`                      | Main orchestrator; connects components and runs the event loop.                 | Critical wiring flaws in `_setup_event_handlers` and initialization calls.                                                     | Broken                            |
| src/qengine/core/assets.py                     | `AssetSpec`, `AssetRegistry`, `AssetClass`               | Defines asset specifications, P&L rules, and margin requirements.               | P&L calculation for options in `calculate_pnl` is flawed. FX PnL logic is flawed.                                              | Partial                           |
| src/qengine/core/clock.py                      | `Clock`, `ClockMode`                                     | Manages simulation time, event queue coordination, and market calendars.        | `_replenish_queue` is flawed for multi-feed scenarios (marked "simplified"). PAPER/LIVE modes are stubs.                       | Broken                            |
| src/qengine/core/event.py                      | `EventBus`, `Event` (Market, Signal, Order, Fill)        | Defines event types and the central event distribution system (priority queue). |                                                                                                                                | Works                             |
| src/qengine/core/types.py                      | Enums (OrderType, Status), Type Aliases (AssetId, Price) | Centralized type definitions.                                                   |                                                                                                                                | Works                             |
| **Data Handling**                              |                                                          |                                                                                 |                                                                                                                                |                                   |
| src/qengine/data/feed.py                       | `DataFeed`, `ParquetDataFeed`, `CSVDataFeed`             | Interfaces and Polars-based implementations for data loading.                   | Duplication between CSV and Parquet feeds. Loads all data into memory eagerly.                                                 | Partial                           |
| src/qengine/data/schemas.py                    | `MarketDataSchema`, `SignalSchema`                       | Schema definition and validation for input data.                                |                                                                                                                                | Works                             |
| **Execution Simulation**                       |                                                          |                                                                                 |                                                                                                                                |                                   |
| src/qengine/execution/broker.py                | `Broker`, `SimulationBroker`                             | Manages orders, simulates execution, applies costs.                             | Fails to publish FillEvents. Lookahead bias (zero latency). Partial fill logic bug (negative qty). Uses `datetime.now()`.      | Broken                            |
| src/qengine/execution/commission.py            | `CommissionModel` (and implementations)                  | Pluggable models for transaction fees.                                          | Comprehensive.                                                                                                                 | Works                             |
| src/qengine/execution/corporate_actions.py     | `CorporateActionProcessor`, Action Types                 | Handles corporate actions by adjusting positions, cash, and orders.             | Detailed implementation, but not integrated into the engine. Bug adjusting partially filled orders. Date validation incorrect. | Partial                           |
| src/qengine/execution/market_impact.py         | `MarketImpactModel` (and implementations)                | Advanced models simulating the effect of trades on market prices.               | Excellent feature set (e.g., Almgren-Chriss).                                                                                  | Works                             |
| src/qengine/execution/order.py                 | `Order`, `OrderState`                                    | Represents a trading order and its lifecycle.                                   | Uses `datetime.now()`.                                                                                                         | Partial                           |
| src/qengine/execution/slippage.py              | `SlippageModel` (and implementations)                    | Pluggable models for execution slippage.                                        | Comprehensive.                                                                                                                 | Works                             |
| **Portfolio Management**                       |                                                          |                                                                                 |                                                                                                                                |                                   |
| src/qengine/portfolio/accounting.py            | `PortfolioAccounting`                                    | Tracks P&L, equity curve, and calculates performance metrics.                   | Uses `datetime.now()`.                                                                                                         | Partial                           |
| src/qengine/portfolio/margin.py                | `MarginAccount`, `MarginRequirement`                     | Manages margin requirements and liquidation logic.                              | Implements asset-specific margin.                                                                                              | Works                             |
| src/qengine/portfolio/portfolio.py             | `Portfolio`, `Position`, `PortfolioState`                | Core state management, tracking positions, cash, and cost basis.                |                                                                                                                                | Works                             |
| src/qengine/portfolio/simple.py                | `SimplePortfolio`                                        | Basic portfolio implementation.                                                 | `finalize` method uses simplified/redundant P&L calculation. Seems redundant.                                                  | Partial                           |
| **Reporting**                                  |                                                          |                                                                                 |                                                                                                                                |                                   |
| src/qengine/reporting/base.py                  | `ReportGenerator`                                        | ABC for report generation and data preparation.                                 | Contains P&L calculation logic (Win Rate/Profit Factor) that should be in Accounting.                                          | Partial                           |
| src/qengine/reporting/html.py                  | `HTMLReportGenerator`                                    | Generates interactive HTML reports (Plotly).                                    |                                                                                                                                | Works                             |
| src/qengine/reporting/parquet.py               | `ParquetReportGenerator`                                 | Generates structured Parquet files for analysis.                                |                                                                                                                                | Works                             |
| src/qengine/reporting/reporter.py              | `Reporter`, `InMemoryReporter`, `ConsoleReporter`        | Captures events and statistics during the backtest run.                         |                                                                                                                                | Works                             |
| **Strategy Framework**                         |                                                          |                                                                                 |                                                                                                                                |                                   |
| src/qengine/strategy/adapters.py               | `StrategyAdapter`, `DataFrameAdapter`, `PITData`         | Bridges external strategy logic to QEngine's event system.                      | `DataFrameAdapter` uses inefficient row appending (`pl.concat`).                                                               | Partial                           |
| src/qengine/strategy/base.py                   | `Strategy`, `SignalStrategy`                             | Abstract base classes defining strategy interfaces and lifecycle.               | `on_start` signature mismatch with engine usage.                                                                               | Broken                            |
| src/qengine/strategy/crypto_basis_adapter.py   | `CryptoBasisAdapter`                                     | Example multi-asset strategy (Basis Trading).                                   | Implements custom synchronization logic that might be better generalized.                                                      | Works                             |
| src/qengine/strategy/spy_order_flow_adapter.py | `SPYOrderFlowAdapter`                                    | Example microstructure strategy (Order Flow).                                   |                                                                                                                                | Works                             |

### **3\) Scope vs. Implementation**

The library aims to be a "state-of-the-art event-driven backtesting engine" offering "realistic market simulation" (
README.md). While the components are sophisticated, critical flaws prevent the system from functioning as intended.

* **What functionality is claimed or implied?**
    * A functional, event-driven simulation environment.
    * Realistic execution, including costs, impact, and timing.
    * Robust multi-asset support with correct PnL and margin calculations.
    * Correct chronological processing across multiple data sources.

* **What is actually implemented?**
    * Extensive models for execution costs and Market Impact are implemented.
    * Detailed multi-asset specifications (`AssetSpec`) and Corporate Action logic are implemented.
    * The core event architecture (`EventBus`) is implemented.

* **List promised-but-missing items (including stubs, TODOs, “future work” comments).**
    * **Functional Simulation (Broken):** Critical flaws in `BacktestEngine` wiring (Broker subscriptions, Fill
      publications, Strategy initialization) render the simulation non-functional.
    * **Correct Multi-Feed Synchronization (Broken):** The `Clock` implementation fails to correctly merge events from
      multiple feeds (`core/clock.py:187` notes it is "simplified").
    * **Realistic Simulation Timing (Flawed):** The engine exhibits zero-latency behavior, introducing lookahead bias.
    * **Corporate Actions (Missing Integration):** The `CorporateActionProcessor` exists but is not integrated into the
      `BacktestEngine` loop.
    * **Liquidity Modeling (Missing):** Fills are generally all-or-nothing; volume constraints are not modeled.

* **Call out any mocks or placeholders wired into the main flow.**
    * The `fill_model` argument in `SimulationBroker` (`execution/broker.py:83`) is accepted but unused.

### **4\) Design & Architecture Review**

* **API design & cohesion:** Excellent API design utilizing ABCs (`Strategy`, `Broker`, `DataFeed`) for modularity.
  Naming is consistent, and the use of `dataclasses` and `Enums` provides strong structure. However, the orchestration
  in `BacktestEngine` fails to utilize these APIs correctly.
* **Separation of concerns:** Strong separation between data ingestion, strategy logic, execution simulation, and
  portfolio tracking. The `EventBus` effectively decouples components.
* **Configuration & parameters:** Configuration is explicit via constructor arguments. This is clear but lacks a
  centralized configuration management system (e.g., YAML/JSON configs).
* **Reproducibility (Determinism):** Critically flawed due to the use of `datetime.now()` in `Order`,
  `SimulationBroker`, and `PortfolioAccounting` instead of the simulation clock's time. This breaks backtest
  determinism.
* **Performance & scalability:** The use of Polars is a strength. However, `DataFeed` implementations load the entire
  dataset into memory (`.collect()`), limiting scalability. The `SimulationBroker` iterates linearly through open orders
  on every market event, which is an O(N\_orders) bottleneck.
* **Numerical robustness:** While `Price` allows `Decimal`, implementations predominantly use `float`, risking precision
  issues. Timezone handling in `Clock` (L244) is present but fragile when mixing aware/naive datetimes.

### **5\) Domain-Specific Checks (Backtesting)**

* **Fill/latency model:** **Present but flawed**. Fills occur immediately on the triggering market event (zero latency,
  lookahead bias). Latency is not modeled.
* **Slippage/fees/Impact:** **Present & correct**. Extensive, pluggable models for slippage, commission, and market
  impact.
* **Market hours:** **Present & correct**. Handled via `Clock` using `pandas_market_calendars`.
* **Partial fills:** **Present but flawed**. Only implemented for insufficient cash/margin. Not implemented for
  liquidity/volume constraints. Logic for cash constraint has a bug (negative quantity).
* **Position lifecycle:** **Present & correct**. Tracked accurately with cost basis and P&L.
* **Cash/financing:** **Present but flawed**. Cash and margin are tracked. Financing costs (interest, borrowing fees)
  are missing.
* **Corporate actions in PnL:** **Present but flawed**. Detailed processor exists but is not integrated into the engine
  loop.
* **Order types:** **Present & correct**. Supports Market, Limit, Stop, Stop-Limit, Trailing Stop, and Bracket/OCO.
* **Event ordering:** **Present but flawed**. `EventBus` uses a priority queue, but the `Clock`'s multi-feed merging
  logic is broken.
* **State resets:** **Present & correct**. `reset()` methods implemented across core components.
* **Warm-up periods:** **Missing**. Not explicitly managed by the engine.

### **6\) Correctness & Bug List**

| ID  | Path:Line(s)                                                   | Symptom / Why It’s Wrong                                                                                                                             | Minimal Repro or Reasoning                                                                                                                     | Severity | Fix Sketch                                                                                                                   |
|:----|:---------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------|:---------|:-----------------------------------------------------------------------------------------------------------------------------|
| B01 | src/qengine/engine.py:106–116                                  | **Broker not subscribed to MarketEvents:** `BacktestEngine._setup_event_handlers` omits subscribing the broker to `EventType.MARKET`.                | The `SimulationBroker` relies on `on_market_event` to check for fills. Without this subscription, the execution flow is broken.                | P0       | Add `self.event_bus.subscribe(EventType.MARKET, self.broker.on_market_event)`.                                               |
| B02 | src/qengine/execution/broker.py:320                            | **FillEvents not published:** Fills are calculated but not communicated to the Portfolio/Strategy.                                                   | `SimulationBroker.on_market_event` returns `FillEvent`s, but the `EventBus` handler ignores return values. The broker must publish the events. | P0       | In `on_market_event`, iterate through the generated `fills` list and call `self.event_bus.publish(fill_event)`.              |
| B03 | src/qengine/engine.py:134 vs src/qengine/strategy/base.py:63   | **Strategy initialization mismatch:** `BacktestEngine` calls `Strategy.on_start` with arguments the base class doesn't accept.                       | `engine.py` calls `on_start(self.portfolio, self.event_bus)`. Base `Strategy.on_start` signature is `on_start(self)`.                          | P0       | Standardize the initialization flow. Update `Strategy` base class to accept dependencies consistently.                       |
| B04 | src/qengine/engine.py:156; src/qengine/execution/broker.py:320 | **Lookahead Bias (Zero Latency):** The engine processes the full chain (Market -> Strategy -> Order -> Fill) in one cycle using the same price data. | A strategy can observe a price and immediately trade at that price, which is unrealistic.                                                      | P0       | Modify the event loop or broker logic to ensure fills occur based on the *next* market event or introduce simulated latency. |
| B05 | src/qengine/core/clock.py:190–217                              | **Broken Multi-Feed Synchronization:** `_replenish_queue` does not correctly track which feed provided the consumed event.                           | It replenishes the first available feed, breaking the chronological merging of streams.                                                        | P0       | Modify the event queue to store the source (feed instance) alongside the event, and only replenish from that source.         |
| B06 | src/qengine/core/assets.py:194–230                             | **Incorrect Default Options P&L:** `calculate_pnl` for options uses intrinsic value change, which is wrong for trades closed before expiry.          | P&L must be based on the change in premium (time value + intrinsic value).                                                                     | P0       | Refactor `calculate_pnl` to require premium data for options or clearly state it assumes expiry/exercise.                    |
| B07 | src/qengine/execution/broker.py:754–756                        | **Negative Partial Fill Quantity:** Partial fill calculation for insufficient cash can result in negative quantity.                                  | `fill_quantity = (self.cash - estimated_commission) / fill_price`. If cash < commission, fill_quantity is negative.                            | P0       | Ensure `fill_quantity` is clamped to a minimum of 0 or the asset's `min_quantity`.                                           |
| B08 | Various (e.g., Broker:174, Order:82, Accounting:49)            | **Non-Deterministic Time:** Usage of `datetime.now()` instead of the simulation clock time.                                                          | Backtests are not reproducible as timestamps depend on wall-clock time.                                                                        | P1       | Replace all `datetime.now()` calls with the simulation time (e.g., from the `Clock` or the event timestamp).                 |
| B09 | src/qengine/execution/corporate_actions.py:505                 | **Corporate Action adjustment bug for partial fills:** `_process_stock_split` adjusts `order.quantity` but not `order.filled_quantity`.              | Corrupts the `remaining_quantity` calculation for partially filled orders after a split.                                                       | P1       | Multiply `order.filled_quantity` by the `split_ratio` as well.                                                               |
| B10 | src/qengine/core/assets.py:210-213                             | **Incorrect FX PnL Calculation.** The logic divides the PnL by `pip_value`.                                                                          | This calculates the number of pips gained, not the PnL in currency units.                                                                      | P1       | Remove the division by `self.pip_value`. PnL should be `quantity * (exit_price - entry_price)`.                              |

### **7\) Code Quality & Standards**

* **Adherence to Standards:** The codebase exhibits high quality, adhering well to PEP 8. Import hygiene is good, and
  the formatting is consistent.
* **Type hints:** Coverage is excellent and correctly utilizes `typing`, `dataclasses`, `Enums`, and `NewType` (
  `core/types.py`). This significantly aids maintainability and clarity.
* **Docstrings:** Docstrings are comprehensive, generally explaining purpose, arguments, and return values effectively.
  Many modules include detailed explanations of the domain concepts.
* **Clear boundaries for internal vs. public APIs:** Modules clearly define public APIs using `__all__` in `__init__.py`
  files. Internal methods are consistently prefixed with `_`. The use of ABCs enforces interfaces effectively.

### **8\) Duplication & Simplification Opportunities**

* **Data Feed Consolidation:** `ParquetDataFeed` and `CSVDataFeed` (`data/feed.py`) share substantial logic for
  iteration, seeking, and event creation.
    * *Proposal:* Consolidate into a base `PolarsDataFeed` class that handles the shared logic, with subclasses managing
      the specific file loading (`pl.scan_parquet` or `pl.scan_csv`).
* **P&L Calculation Centralization:** P&L and metric calculation logic (like Win Rate/Profit Factor) is duplicated and
  potentially simplified in `reporting/base.py` and `portfolio/simple.py` (in its `finalize` method).
    * *Proposal:* Centralize all P&L calculation and trade matching within `PortfolioAccounting` and expose the results
      for reporting, removing redundant calculations.
* **Portfolio Module Structure:** The relationship between `Portfolio`, `SimplePortfolio`, and `PortfolioAccounting` is
  slightly confusing. `SimplePortfolio` seems redundant.
    * *Proposal:* Consolidate functionality into `Portfolio` (for state management) and `PortfolioAccounting` (for
      metrics and history), potentially removing `SimplePortfolio`.

### **9\) Performance Observations**

* **Hot Paths (by inspection):**
    * `SimulationBroker.on_market_event`: This method iterates linearly through all open, stop, and trailing orders for
      the relevant asset on every market event. This O(N\_orders) operation per event is the primary scalability
      bottleneck.
    * The main event loop in `BacktestEngine.run` and dispatch in `EventBus.process_all`.
* **Concrete suggestions:**
    * **Optimize Broker Lookups:** Replace linear scans of orders in `SimulationBroker` with data structures optimized
      for range queries (e.g., sorted lists or interval trees keyed by price) to find triggerable orders faster (O(log
      N) or O(1)).
    * **Lazy Data Loading:** Refactor `DataFeed` implementations to use Polars lazy execution or streaming (
      `scan_parquet` without immediate `.collect()`) to reduce memory footprint for large datasets.
* **Risky patterns:**
    * `DataFrameAdapter._update_data_history` (`strategy/adapters.py:291`) uses `pl.concat` to append single rows, which
      is inefficient (involves reallocation). Data should be buffered and appended in chunks.

### **10\) Roadmap & Prioritized Backlog**

| Priority | Item                                                                      | Outcome of Doing This                                                                                                                  | Effort |
|:---------|:--------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------|:-------|
| P0       | Fix Engine Integration Flaws (B01, B02)                                   | Makes the engine functional by ensuring correct event flow (Market->Broker, Fill->Portfolio).                                          | M      |
| P0       | Standardize Component Initialization (B03)                                | Fixes initialization crashes and ensures components receive necessary dependencies.                                                    | S      |
| P0       | Resolve Lookahead Bias / Zero Latency (B04)                               | Ensures realistic simulation timing, crucial for backtest validity.                                                                    | L      |
| P0       | Fix Clock Multi-Feed Synchronization (B05)                                | Enables correct chronological merging of multiple data sources.                                                                        | M      |
| P0       | Correct Options P&L Calculation (B06)                                     | Ensures accurate P&L reporting for options strategies.                                                                                 | S      |
| P0       | Fix Negative Fill Quantity Bug (B07)                                      | Prevents runtime errors when trading with low cash balances.                                                                           | S      |
| P1       | Enforce Determinism: Replace `datetime.now()` (B08)                       | Ensures backtests are reproducible.                                                                                                    | S      |
| P1       | Integrate `CorporateActionProcessor` into the `BacktestEngine` loop.      | Enables accurate simulation across splits, dividends, etc.                                                                             | M      |
| P1       | Fix Corporate Action adjustment for partial fills (B09) and FX PnL (B10). | Improves domain correctness.                                                                                                           | S      |
| P1       | Implement Liquidity Modeling (Volume Constraints) for Fills.              | Increases simulation realism by modeling partial fills based on available market volume.                                               | L      |
| P2       | Optimize Broker Order Matching Performance.                               | Enables scaling to strategies with many open orders.                                                                                   | L      |
| P2       | Centralize P&L Metrics Calculation.                                       | Ensures consistency by centralizing metrics logic in `PortfolioAccounting` and removing fragile logic from reporting/simple portfolio. | M      |
| P2       | Optimize Data Loading for Memory Efficiency (Lazy Polars).                | Enables backtesting on large datasets.                                                                                                 | M      |
| P2       | Consolidate Data Feeds (`ParquetDataFeed`/`CSVDataFeed`).                 | Reduces code duplication and improves maintainability.                                                                                 | M      |

### **11\) Appendix — File-by-File Notes**

* **src/qengine/engine.py**
    * L106-116: `_setup_event_handlers` is missing critical subscriptions (B01).
    * L134: Calls `strategy.on_start` incorrectly (B03).
    * L156: `self.event_bus.process_all()` executes the full chain reaction immediately, causing lookahead bias (B04).

* **src/qengine/core/assets.py**
    * L194-230: `calculate_pnl` implementation for options is flawed (B06).
    * L210-213: FX PnL calculation is flawed (B10).

* **src/qengine/core/clock.py**
    * L190-217: `_replenish_queue` is flawed for multiple feeds (B05).

* **src/qengine/data/feed.py**
    * Significant duplication between `ParquetDataFeed` and `CSVDataFeed`.
    * L116, L236: Eagerly loads data using `.collect()`.

* **src/qengine/execution/broker.py**
    * `on_market_event` is never called (B01).
    * L320: `on_market_event` generates fills but must publish them to the `EventBus` (B02).
    * L174, 616, 753: Uses `datetime.now()` (B08).
    * L754: Bug allowing negative fill quantity (B07).

* **src/qengine/execution/corporate_actions.py**
    * Comprehensive implementation, but not integrated into `engine.py`.
    * L505: Fails to adjust `filled_quantity` for partially filled orders during a split (B09).

* **src/qengine/strategy/base.py**
    * L63 (`on_start`): Signature mismatch with how the engine calls it (B03).

* **src/qengine/strategy/adapters.py**
    * L291: `DataFrameAdapter` uses inefficient `pl.concat` for single-row appends.